# Azure 概要
## 概要
### データセンター
- リージョン
    - リージョンペア
        - 冗長構成などを利用するときにペアとなるリージョンの組み合わせ
    - Azure上のほとんどのサービスや構成オプションはどのリージョンでも利用可能
### サブスクリプション
- Azure ダイレクト（従量課金）
    - 支払いはクレジットカード、デビットカード、請求書
- Azure EA
    - コミットメントが必要だが、低料金で利用可能
- Azure インオープン
    - 事前にリセラーから12ヶ月有効なプリペイド式のクレジットを$100単位で購入し、そのクレジットで支払う
- CSP
    - CSPと契約し、Azureを従量課金で利用する
- 無料サブスクリプション
    - 1ヶ月の期間内で自由に評価できる、$200分のクレジットが含まれる
- サブスクリプションを取得するためには
    - アカウントが必要
        - Microsoftアカウント
            - MSが提供するコンシューマー向けサービスに利用するアカウント
        - Azure ADアカウント・組織アカウント
            - MSが提供するエンタープライズ向けサービスに利用するアカウント
### Azureアカウント
- Azureアカウント
    - サブスクリプションの追加やキャンセルなど、サブスクリプションそのものを管理する単位
    - サインアップを行ったMSアカウントまたはAzureADアカウントにはアカウント管理者の権限が与えられる
- サブスクリプション
    - 契約及び課金の単位
    - リソースを管理する単位
    - サブスクリプションIDとサブスクリプション名
    - サービス管理者を指定可能
    - Azure Portalのサブスクリプション管理画面の「プロパティ」からサービス管理者の確認や変更が可能

## Resource Manager
### デプロイモデル
- クラシックデプロイモデル
    - ASM
        - Azure Service Manager
        - 各リソースが独立して存在する
- Resource Mangager モデル
    - ARM
    - 関連するリソースをグループ化して管理
### アーキテクチャ
- リソースの一貫したデプロイと管理を可能にするアーキテクチャ
- Azure Portal やAzure PowerShellなどの管理ツールからユーザー要求を受け取り
- REST APIを通じて適切なリソースプロバイダーへ転送
- リソースプロバイダー
    - 要求を処理するプログラム及びサービス
    - 例
        - Microsoft.Compute
        - Microsoft.Storage
        - Microsoft.Web
### リソースプロバイダーの管理
- 一部のリソースプロバイダーは手動で登録操作が必要
### リソースグループ
- 複数のリソースをまとめてグループ化し、一元的にデプロイ、管理、監視するためのフォルダー機能
- 1つのリソースは、いずれかのリソースグループに追加する必要があるが、複数のリソースグループへの追加はできない
- 種類の異なるリソースを、1つのリソースグループに追加できる
- 様々なリージョンのリソースを、1つのリソースグループに追加できる
### 別のリソースグループへの移動
- 一部を除くリソースについては、作成した後で別のリソースグループへ移動することもできる

## 管理ツールと基本操作
### Azure管理ツール
- Azure Portal
- Azure Mobile App
    - リソースの監視と操作
- Azure CLI
- Azure PowerShell
- Azure Cloud Shell
    - Bash
    - PowerShell
    - ストレージアカウントの作成が必要

## ARMテンプレート
### 概要
- テンプレートによるリソース作成
- 作成するリソsーストその構造を記述し、それをARMに送ることで実行
### メリット
- エラーの削減
- 一貫性のあるデプロイの実現
- 再利用性の向上
- 複数のデプロイの自動化
### 構造
- JSON
- `$schema`
    - テンプレート言語のバージョンが記述された「JSONスキーマファイル」の場所を指定するセクション
    - URLを記述
- `$contentVersion`
    - テンプレートのバージョンを記述
- `parameters`
    - 変数格納のため
    - ユーザーに入力
- `variables`
    - 変数格納のため
    - 複雑な記述を定義
- `resources`
    - デプロイまたは更新するリソースを定義
- `outputs`
    - デプロイによって返される値を定義
### クイックスタートテンプレート
- WebサイトやAzure Portalで確認
### テンプレートからのデプロイ実行と結果確認
- デプロイの結果や履歴は、リソースの格納先であるリソースグループの「デプロイ」メニューで確認できる

# Azure Active Directory
## 概要
### 認証と認可
- 認証
    - 本人確認のプロセス
- 認可
    - そのIDがサービスやアプリケーションにアクセス可能であるかを確認するプロセス
### AD DS
- Active Directory Domain Service
- オンプレミスのシステムに対して認証と認可を実現
- ドメインを1つの単位としてKerberosに基づいて認証と認可を行う
- Microsoft Intune
    - モバイルデバイス管理のためのクラウドサービス
### Azure Active Directory
- クラウドでの認証と認可を行うためのサービス
- クラウドベースのディレクトリサービス
### Azure ADのエディション
- Azure AD Free
- Azure AD Office 365アプリ
    - セルフパスワードリセットなどの機能
- Azure AD Premium P1
    - 有償版
    - オンプレミスとクラウドを一体運用する企業向けの多くの機能を提供
    - 動的グループ
        - クエリを用いて動的にグループのメンバーを構成する
    - 条件付きアクセス機能
        - 場所やデバイスの状態でアクセスを制御する
- Azure AD Premium P2
    - 有償版の最上位
    - Azure AD Identity Protection
        - 不正アクセスを検知する
    - Azure AD Privileged Identity Management
        - 時間限定で管理者権限を付与する
### 主な機能
- オブジェクトの管理
    - ユーザーやグループなどを管理する最も基本的な機能
    - デバイスを登録し、Azure ADのユーザーと紐づけることも可能
- 多要素認証
    - ユーザー名とパスワードだけでのサインインを禁止する
    - 例
        - 音声通話
        - SMS
        - Microsoft Authenticator
        - OATHハードウェアトークン
- 条件付きアクセス
    - 設定したポリシー条件に一致するユーザーやデバイスだけにアクセスを許可できるアクセス制御機能
- セルフサービスパスワードリセット
    - ユーザーがパスワードを忘れた時に、ユーザー自身でパスワードをリセットできるようにする機能
    - 本人確認方法
        - モバイルアプリの通知
        - モバイルアプリのコード
        - 電子メール
        - 携帯電話
        - 会社の電話
        - 秘密の質問
### デバイス情報の登録
- Azure ADにデバイス情報を登録
- MDM
    - Mobile Device Management
    - Microsoft Intune
        - デバイスの構成管理用の様々なポリシーを定義可能
- Azure ADデバイス登録
    - BYOD
        - Bring Your Own Device
    - ユーザーが個人で所有するデバイスを業務に使用している状況を想定し、そのデバイス情報をAzure ADに登録するための方法
- Azure AD参加
    - 社給のデバイスを想定した登録方法
- ハイブリッドAzure AD参加
    - 既存のAD DSにドメイン参加しているデバイスを想定した登録方法
    - AD DSとAzure ADの両方にデバイスを参加させる方法
    - Azure AD Connect
        - ディレクトリ同期を行うためのツール
    - AD DSのドメインに参加した時の機能と、Azure AD参加した時の機能の両方を利用できるメリット
## テナントの構成
### テナント
- Azure ADサービスのインスタンスであり、1つの組織
- Azure ADは、M365やMicrosoft Intuneの認証基盤としても使用されるため、サインアップ後はすでにAzure ADテナントが作成されている
- サブスクリプションとの関連
### テナント作成
- 必要に応じて、複数のテナントを作成することも可能
### カスタムドメイン
- 必要に応じてカスタムドメインを追加することが可能
- ドメイン名でAzure AD認証を行える
- カスタムドメイン名を追加するには、組織がそのドメイン名を所有しており、それをインターネット上で確認できる状態である必要がある
- 組織が管理している外部のDNSサーバーにカスタムドメイン名を所有していることを示すレコードを登録する必要がある
- カスタムドメイン名の設定を行うには、TXTレコードまたはMXレコードを登録し、そのドメイン名の所有者であることを確認する必要がある
## ユーザーとグループ
### ユーザー
- Azure AD認証を行うために必要な情報
- ユーザー
    - 通常の組織内のユーザー
    - ライセンスや、Azure ADのロール、アプリケーションのアクセス許可の割り当てを行うことが可能
- ゲストユーザー
    - 外部のユーザー
    - B2Bコラボレーション
        - 外部のユーザーを招待
    - 他のAzure ADテナントのユーザーやMicrosoft アカウントなど、組織外の任意のメールアドレスを持つユーザー
    - ライセンスやロール、アプリケーションのアクセス許可を割り当てることができる
### ユーザーの一括作成
- CSVファイルにユーザー情報をまとめて一括作成
- PowerShell
### グループ
- ユーザーをまとめて扱うためのオブジェクト
- セキュリティ
    - Azure 及びAzure ADのアクセス管理において、一般的に使用されるグループの種類
    - グループを入れ子にすることが可能（ユーザーのみ）
- M365
    - M365での使用を想定したグループの種類
    - 組織内外のユーザーとの共同作業を行う目的で使用
### グループのメンバー管理
- 手動
    - 管理者が手動でグループにユーザーやデバイスをメンバーに追加し、静的に管理
- 動的
    - ユーザーやデバイスの属性に基づいて動的にメンバーを管理する方法
    - Azure AD Premiumエディションでのみ利用可能
    - 動的メンバーシップルールと呼ばれるクエリの機能を使用
### ロール
- 管理権限
- 種類
    - グローバル管理者
    - グローバル閲覧者
    - ユーザー管理者
    - パスワード管理者
    - ライセンス管理者
    - レポート管理者
- テナントを作成したユーザーには、グローバル管理者のロールが規定で割り当てられる
## ディレクトリ同期
### 管理
- Azure Active Directory Connect
    - ディレクトリの同期
    - AD DSとAzure ADのディレクトリを統合するための管理ツール
    - ドメイン参加しているWindows Serverにインストール
    - 基本的にはAD DSからAzure ADへの一方向
    - Azure AD Premiumエディションでは、パスワードなどの一部の情報についてAzure AD からAD DSに同期できる
- 同期サーバーの冗長構成
    - ステージングモード
    - Azure AD COnnectのセカンドサーバー
- 各ディレクトリでの使用可能な文字の違い
- 各ディレクトリのドメイン名の相違
- 同期の監視
    - Azure AD Connect Health

# ガバナンスとコンプライアンス
## 環境管理
### Microsoft Azureの環境管理
- タグ
    - Azureの各リソースに付与できる「キーと値」のペア
    - リソース一覧の表示
    - コスト分析の際のフィルター
- ロック
    - リソースの変更や削除を禁止する
    - ロックの種類
        - 削除ロック
        - 読み取り専用ロック
    - ロックは、サブスクリプション、リソースグループ、リソースのスコープで設定可能
    - 上位のスコープで設定されたロックは、下位のスコープに継承
- クォータ
    - 作成できるリソースの数などの上限設定
    - 引き上げ依頼も可能
- Azure Advisor
    - Azure環境及び存在するリソースをスキャンし、アドバイスを提供する機能
- Azure Policy
    - 組織でAzureを使用する上でのルールを構成する機能
- RBAC
    - Azureリソースへの詳細なアクセス制御を行う機能
- 管理グループ
    - 複数のサブスクリプションをグルーピングする機能
    - 複数のサブスクリプションに同じAzure PolicyやRBACの設定を適用したい場合
## コスト管理
### MS Azureにより発生するコスト
- 仮想マシン
    - 単価x実行時間
- ストレージ
- ネットワーク
    - アウトバウンド通信に課金
### コストのシュミレーション
- 料金計算ツール
### コストの確認及び管理
- コスト分析
- タグごとの集計
- 予算の設定によって、指定した予算の割合に達した時にアラートメールを送信したり、仮想マシンを設定するなどの特定のアクションを実行できる
### コスト削減オプション
- 予約
    - 1年または3年の長期使用のためのコスト削減オプション
- Azureハイブリッド特典
    - ソフトウェアアシュアランスを購入している組織向けのコスト削減オプション
- Visual Studioサブスクライバー向けのAzure クレジットの活用
## Azure Policy
### ビジネスルールに基づいたAzureの使用
- 組織独自のコンプライアンス要件を持つ場合
- 不要なリソース種類や不適切な構成での作成を制限したい場合
- リソース管理の一貫性を高めたい場合
### 実装手順
1. ポリシー定義の作成または確認
    - カスタム定義
        - JSON形式で記述
    - ビルトイン定義
        - 使用できるリソースの種類
        - 許可されていないリソースの種類
        - 許可されている場所
        - 許可されている仮想マシンSKU
        - タグとその値をリソースに追加する
1. イニシアティブ定義の作成
    - 複数のポリシー定義をまとめて使用したい場合
    - 複数のポリシーをグループ化
1. 割り当ての設定
    - ポリシー定義またはイニシアティブ定義を割り当てるスコープのパラメータを設定
    - スコープから一部のリソースグループやリソースなどを除外できる
1. 結果と評価の確認
    - ポリシー割り当て後、既存リソースに対する評価が実施
        - 準拠してない場合、「非準拠のリソース」としてリストアップ
        - 「コンプライアンス」で確認できる
## RBAC
### 概要
- 各スコープに対するきめ細かいアクセス制御
### 組み込みのロール
- 所有者
    - フルコントロール
- 共同作成者
    - すべてのリソースへのフルコントロールアクセス権
    - 他のユーザーへのアクセス権の付与はできない
- 閲覧者
    - 既存のリソースの表示だけ可能
### カスタムロール
### ロールの割り当て
- ロールはユーザーやグループに対してだけでなく、サービスプリンシパル(アプリケーション)に対して割り当てることも可能
- マネージドIDにも可能
- 加算方式、割り当てられたロールの和集合が実際のアクセス許可となる
    - notActionsは加算されない
### Azure VS Azure AD
- Azure
    - 目的: Azure リソースのアクセス管理
    - スコープ:
        - 管理グループ
        - サブスクリプション
        - リソースグループ
        - リソース
    - 構成に使用する管理ツール:
        - Azure Portal
        - Azure CLI
        - Azure PowerShell
        - ARM Template
        - REST API
    - カスタムロール: 作成可能
- Azure AD
    - 目的: Azure ADリソースの管理
    - スコープ:
        - テナント
        - 管理単位
        - 個々のオブジェクト
    - 構成に使用する管理ツール:
        - Azure Portal
        - Microsoft 365管理ポータル
        - AzureAD PowerShell
        - Microsoft Graph
    - カスタムロール: Azure AD Premiumでのみ作成可能

# 仮想マシン
## 仮想マシンの計画
### 仮想マシンサービスの概要
- MSのデータセンターで実行される仮想マシンのインスタンス
- サイズ
    - 性能を決定するパラメータ
    - 様々なシリーズ
    - 仮想マシンのサイズは後から変更可能。ただし再起動が必要で、ダウンタイムが発生
- ディスク
    - OSディスク
        - OSが含まれるディスク
        - 最大4TiB
        - Cドライブ
        - Azure Storage に作成される
    - 一時ディスク
        - キャッシュ用のディスク
        - Dドライブ
    - データディスク
        - アプリケーションやデータを格納する他mに追加が可能なオプション
        - Azure Storageに作成
    - 種類
        - Standard HDD
            - データのアクセス頻度が低い
        - Standard SSD
            - 開発及びテスト向けのディスク
        - Premium SSD
            - エンタープライズワークロード向け
        - Ultra Disk
            - トランザクション量の多いワークロード向け
    - ディスクストレージ
        - アンマネージドディスク
            - 事前にストレージアカウントを準備して、その中にでディスクを格納
            - ディスクデータ以外のデータの格納
            - Azure Storage Explorerなどのツールを使用した管理
            - Standard HDDの場合のみ、geo冗長ストレージを選択できる
        - マネージドディスク
            - 仮想マシン作成時に同時に作成可能
            - キャプチャ機能
            - スナップショット機能
            - 可用性ゾーン
- 可用性オプション
    - 可用性セット
        - 同じ構成の仮想マシンを複数作成するときに、1つのデータセンター内における配置先のラックやブレードを分けることができるオプション
        - 99.95%の実稼働率
        - 障害ドメイン
            - 仮想マシンをデータセンター内の幾つのラックに分散して配置するかを決定
            - 最大3
        - 更新ドメイン
            - 仮想マシンを幾つのサーバーグループに分散して配置するかを決定
            - 計画的なメンテナンス時にまとめて再起動されるサーバーの単位
            - 最大20
    - 可用性ゾーン
        - 同じ構成の仮想マシンを複数作成するときに、配置先のデータセンターを分けることができるオプション
        - 99.99%の実稼働率
        - データセンターの障害に対応できる
- 代表的な拡張機能
    - カスタムスクリプト拡張機能
        - 仮想マシンのOSで指定したスクリプトを実行するための拡張機能
    - PowerShell DSC拡張機能
        - PowerShellによるシステムの構成や展開を行う管理プラットフォーム
- テンプレートのエクスポートは、既存の仮想マシンと同じようなパラメータを持つ新しい仮想マシンを作成したい場合に役立つ
- 接続方法
    - リモートデスクトップ
        - リモートデスクトップを使用し接続
        - ポート番号は3389
    - SSH接続
        - パスワードまたは証明書ベースのSSHを使用し、接続
        - ポート番号は22
    - Bastion接続
        - ブラウザーから安全に仮想マシンに接続して操作する
        - 仮想マシンのRDPまたはSSHのポートを外部に公開することなく、仮想マシンに対する安全なリモート接続が提供される
        - ポート番号は443
        - 仮想マシンが接続する仮想ネットワークにBastionだけを配置する専用のサブネットを作成し、「AzureBastionSubnet」というサブネット名にしておく必要がある
        - アドレス範囲のプレフィックスの値は/26以下
        - BastionにパブリックIPアドレスを割り当てる
##　仮想マシンスケールセット
### システムの性能に対するアプローチ
- 垂直スケーリング
    - システムを構成するマシンのスペックを変更することで性能を調整するアプローチ
    - ダウンタイムが発生
- 水平スケーリング
    - システムを構成するマシンの台数を変更することで性能を調整する
- スケールインポリシー
    - 最新のVMポリシー
    - 最も古いVMポリシー
- アップグレードモード
    - スケールセットモデルによって仮想マシンを最新の状態に維持するための方法
    - 手動
    - 自動
    - ローリング
        - スケールセット内で同時に更新を行う仮想マシンの割合を指定しておき、その割合に応じて仮想マシンが順次更新される
- オーバープロビジョニング
    - 仮想マシンのプロビジョニングの成功率を向上するための設定
    - スケールセットは実際に要求された数より多くの仮想マシンを作成及び起動する
    - そして要求された数の仮想マシンが正常にプロビジョニングされたことが確認できたときに、余計に作成した仮想マシンを削除
    - 一時的に余計に作成された仮想マシンは課金対象とはならず、クォータ制限にもカウントされない
- 自動スケールプロファイル
    - 複数の自動スケールプロファイルが構成されている場合
        1. 指定日プロファイル
        1. 定期的プロファイル
        1. 規定のプロファイル
    - 1つの自動スケールプロファイル内に複数の規則が構成されている場合
        - 1つの自動スケールプロファイル内で、スケールアウト及びスケールインについての複数の規則を構成することができる
        - スケールアウトの規則は「いずれか」が満たされていれば自動スケールが実行されるのに対し、スケールインの規則は「すべて」が満たされているバイに限って自動スケールが実行
# ストレージ
## ストレージアカウント
### 概要
- ストレージの貸出サービス
### ストレージサービスの種類
- Azure Blob Storage
    - テキストデータやバイナリデータなど、大量の非構造化データを格納するために最適化されたサービス
- Azure Files
    - クラウド上にSMBファイル共有またはNFSファイル共有を作成するサービス
- Azure Queue Storage
    - 異なるアプリケーション間のデータ交換場所である、キューを提供するサービス
    - アプリケーションの非同期通信を実現するための場所
- Azure Table Storage
    - テーブルデータを格納するサービス
    - NoSQL
### Storage Account
- Standard汎用v2
    - HDD
    - サポートされているサービス
        - Blob
        - Files
        - Queue
        - Table
        - Data Lage Storage
    - Replication
        - LRS
        - GRS
        - RA-GRS
        - ZRS
        - GZRS
        - RA-GZRAS
- Premium ブロックBLOB
    - SSD
    - サポートされているサービス
        - Blob
    - Replication
        - LRS
        - ZRS
- Premium ページBLOB
    - SSD
    - サポートされているサービス
        - Blob
    - Replication
        - LRS
- Premiumファイル共有
    - SSD
    - サポートされているサービス
        - Files
    - Replication
        - LRS
        - ZRS
- パフォーマンス及びストレージアカウントの種類は後から変更不可
- ストレージアカウント作成後にレプリケーションオプションが変更できるかどうかは、現在と変更先の組み合わせで決まる
    - LRS->GRSは可能
    - LRS->ZRSはMSへのサポートが必要（ライブマイグレーション）
### Replication
- LRS
    - 1つのデータセンター内でデータが3つのディスクに同期的にコピー
    - イレブンナイン
- ZRS
    - 選択したリージョンの3つの可用性ゾーン間で、データを同期的にコピー
    - 12ナイン
- GRS
    - プライマリリージョンとセカンダリリージョンのそれぞれでLRS
    - 16ナイン
- RA-GRS
    - プライマリリージョンとセカンダリリージョンのそれぞれでLRS
    - 16ナイン
    - セカンダリリージョンへのエンドポイント両方が構成されるため、平常時でも読み取りアクセス可能
- GZRS
    - プライマリリージョンでZRS、セカンダリリージョンでLRS
    - 16ナイン以上
- RA-GZRS
    - プライマリリージョンでZRS、セカンダリリージョンでLRS
    - 16ナイン以上
    - セカンダリリージョンへのエンドポイント両方が構成されるため、平常時でも読み取りアクセス可能
## Blob
### 形式
- ファイルストレージ
    - ファイル単位で管理及びアクセスするストレージ
- ブロックストレージ
    - ブロック単位で管理及びアクセスするストレージ
- オブジェクトストレージ
    - 階層構造がなく、1つのストレージプールの中で各データをオブジェクトとして扱う