# Azure 概要
## 概要
### データセンター
- リージョン
    - リージョンペア
        - 冗長構成などを利用するときにペアとなるリージョンの組み合わせ
    - Azure上のほとんどのサービスや構成オプションはどのリージョンでも利用可能
### サブスクリプション
- Azure ダイレクト（従量課金）
    - 支払いはクレジットカード、デビットカード、請求書
- Azure EA
    - コミットメントが必要だが、低料金で利用可能
- Azure インオープン
    - 事前にリセラーから12ヶ月有効なプリペイド式のクレジットを$100単位で購入し、そのクレジットで支払う
- CSP
    - CSPと契約し、Azureを従量課金で利用する
- 無料サブスクリプション
    - 1ヶ月の期間内で自由に評価できる、$200分のクレジットが含まれる
- サブスクリプションを取得するためには
    - アカウントが必要
        - Microsoftアカウント
            - MSが提供するコンシューマー向けサービスに利用するアカウント
        - Azure ADアカウント・組織アカウント
            - MSが提供するエンタープライズ向けサービスに利用するアカウント
### Azureアカウント
- Azureアカウント
    - サブスクリプションの追加やキャンセルなど、サブスクリプションそのものを管理する単位
    - サインアップを行ったMSアカウントまたはAzureADアカウントにはアカウント管理者の権限が与えられる
- サブスクリプション
    - 契約及び課金の単位
    - リソースを管理する単位
    - サブスクリプションIDとサブスクリプション名
    - サービス管理者を指定可能
    - Azure Portalのサブスクリプション管理画面の「プロパティ」からサービス管理者の確認や変更が可能

## Resource Manager
### デプロイモデル
- クラシックデプロイモデル
    - ASM
        - Azure Service Manager
        - 各リソースが独立して存在する
- Resource Mangager モデル
    - ARM
    - 関連するリソースをグループ化して管理
### アーキテクチャ
- リソースの一貫したデプロイと管理を可能にするアーキテクチャ
- Azure Portal やAzure PowerShellなどの管理ツールからユーザー要求を受け取り
- REST APIを通じて適切なリソースプロバイダーへ転送
- リソースプロバイダー
    - 要求を処理するプログラム及びサービス
    - 例
        - Microsoft.Compute
        - Microsoft.Storage
        - Microsoft.Web
### リソースプロバイダーの管理
- 一部のリソースプロバイダーは手動で登録操作が必要
### リソースグループ
- 複数のリソースをまとめてグループ化し、一元的にデプロイ、管理、監視するためのフォルダー機能
- 1つのリソースは、いずれかのリソースグループに追加する必要があるが、複数のリソースグループへの追加はできない
- 種類の異なるリソースを、1つのリソースグループに追加できる
- 様々なリージョンのリソースを、1つのリソースグループに追加できる
### 別のリソースグループへの移動
- 一部を除くリソースについては、作成した後で別のリソースグループへ移動することもできる

## 管理ツールと基本操作
### Azure管理ツール
- Azure Portal
- Azure Mobile App
    - リソースの監視と操作
- Azure CLI
- Azure PowerShell
- Azure Cloud Shell
    - Bash
    - PowerShell
    - ストレージアカウントの作成が必要

## ARMテンプレート
### 概要
- テンプレートによるリソース作成
- 作成するリソsーストその構造を記述し、それをARMに送ることで実行
### メリット
- エラーの削減
- 一貫性のあるデプロイの実現
- 再利用性の向上
- 複数のデプロイの自動化
### 構造
- JSON
- `$schema`
    - テンプレート言語のバージョンが記述された「JSONスキーマファイル」の場所を指定するセクション
    - URLを記述
- `$contentVersion`
    - テンプレートのバージョンを記述
- `parameters`
    - 変数格納のため
    - ユーザーに入力
- `variables`
    - 変数格納のため
    - 複雑な記述を定義
- `resources`
    - デプロイまたは更新するリソースを定義
- `outputs`
    - デプロイによって返される値を定義
### クイックスタートテンプレート
- WebサイトやAzure Portalで確認
### テンプレートからのデプロイ実行と結果確認
- デプロイの結果や履歴は、リソースの格納先であるリソースグループの「デプロイ」メニューで確認できる

# Azure Active Directory
## 概要
### 認証と認可
- 認証
    - 本人確認のプロセス
- 認可
    - そのIDがサービスやアプリケーションにアクセス可能であるかを確認するプロセス
### AD DS
- Active Directory Domain Service
- オンプレミスのシステムに対して認証と認可を実現
- ドメインを1つの単位としてKerberosに基づいて認証と認可を行う
- Microsoft Intune
    - モバイルデバイス管理のためのクラウドサービス
### Azure Active Directory
- クラウドでの認証と認可を行うためのサービス
- クラウドベースのディレクトリサービス
### Azure ADのエディション
- Azure AD Free
- Azure AD Office 365アプリ
    - セルフパスワードリセットなどの機能
- Azure AD Premium P1
    - 有償版
    - オンプレミスとクラウドを一体運用する企業向けの多くの機能を提供
    - 動的グループ
        - クエリを用いて動的にグループのメンバーを構成する
    - 条件付きアクセス機能
        - 場所やデバイスの状態でアクセスを制御する
- Azure AD Premium P2
    - 有償版の最上位
    - Azure AD Identity Protection
        - 不正アクセスを検知する
    - Azure AD Privileged Identity Management
        - 時間限定で管理者権限を付与する
### 主な機能
- オブジェクトの管理
    - ユーザーやグループなどを管理する最も基本的な機能
    - デバイスを登録し、Azure ADのユーザーと紐づけることも可能
- 多要素認証
    - ユーザー名とパスワードだけでのサインインを禁止する
    - 例
        - 音声通話
        - SMS
        - Microsoft Authenticator
        - OATHハードウェアトークン
- 条件付きアクセス
    - 設定したポリシー条件に一致するユーザーやデバイスだけにアクセスを許可できるアクセス制御機能
- セルフサービスパスワードリセット
    - ユーザーがパスワードを忘れた時に、ユーザー自身でパスワードをリセットできるようにする機能
    - 本人確認方法
        - モバイルアプリの通知
        - モバイルアプリのコード
        - 電子メール
        - 携帯電話
        - 会社の電話
        - 秘密の質問
### デバイス情報の登録
- Azure ADにデバイス情報を登録
- MDM
    - Mobile Device Management
    - Microsoft Intune
        - デバイスの構成管理用の様々なポリシーを定義可能
- Azure ADデバイス登録
    - BYOD
        - Bring Your Own Device
    - ユーザーが個人で所有するデバイスを業務に使用している状況を想定し、そのデバイス情報をAzure ADに登録するための方法
- Azure AD参加
    - 社給のデバイスを想定した登録方法
- ハイブリッドAzure AD参加
    - 既存のAD DSにドメイン参加しているデバイスを想定した登録方法
    - AD DSとAzure ADの両方にデバイスを参加させる方法
    - Azure AD Connect
        - ディレクトリ同期を行うためのツール
    - AD DSのドメインに参加した時の機能と、Azure AD参加した時の機能の両方を利用できるメリット
## テナントの構成
### テナント
- Azure ADサービスのインスタンスであり、1つの組織
- Azure ADは、M365やMicrosoft Intuneの認証基盤としても使用されるため、サインアップ後はすでにAzure ADテナントが作成されている
- サブスクリプションとの関連
### テナント作成
- 必要に応じて、複数のテナントを作成することも可能
### カスタムドメイン
- 必要に応じてカスタムドメインを追加することが可能
- ドメイン名でAzure AD認証を行える
- カスタムドメイン名を追加するには、組織がそのドメイン名を所有しており、それをインターネット上で確認できる状態である必要がある
- 組織が管理している外部のDNSサーバーにカスタムドメイン名を所有していることを示すレコードを登録する必要がある
- カスタムドメイン名の設定を行うには、TXTレコードまたはMXレコードを登録し、そのドメイン名の所有者であることを確認する必要がある
## ユーザーとグループ
### ユーザー
- Azure AD認証を行うために必要な情報
- ユーザー
    - 通常の組織内のユーザー
    - ライセンスや、Azure ADのロール、アプリケーションのアクセス許可の割り当てを行うことが可能
- ゲストユーザー
    - 外部のユーザー
    - B2Bコラボレーション
        - 外部のユーザーを招待
    - 他のAzure ADテナントのユーザーやMicrosoft アカウントなど、組織外の任意のメールアドレスを持つユーザー
    - ライセンスやロール、アプリケーションのアクセス許可を割り当てることができる
### ユーザーの一括作成
- CSVファイルにユーザー情報をまとめて一括作成
- PowerShell
### グループ
- ユーザーをまとめて扱うためのオブジェクト
- セキュリティ
    - Azure 及びAzure ADのアクセス管理において、一般的に使用されるグループの種類
    - グループを入れ子にすることが可能（ユーザーのみ）
- M365
    - M365での使用を想定したグループの種類
    - 組織内外のユーザーとの共同作業を行う目的で使用
### グループのメンバー管理
- 手動
    - 管理者が手動でグループにユーザーやデバイスをメンバーに追加し、静的に管理
- 動的
    - ユーザーやデバイスの属性に基づいて動的にメンバーを管理する方法
    - Azure AD Premiumエディションでのみ利用可能
    - 動的メンバーシップルールと呼ばれるクエリの機能を使用
### ロール
- 管理権限
- 種類
    - グローバル管理者
    - グローバル閲覧者
    - ユーザー管理者
    - パスワード管理者
    - ライセンス管理者
    - レポート管理者
- テナントを作成したユーザーには、グローバル管理者のロールが規定で割り当てられる
## ディレクトリ同期
### 管理
- Azure Active Directory Connect
    - ディレクトリの同期
    - AD DSとAzure ADのディレクトリを統合するための管理ツール
    - ドメイン参加しているWindows Serverにインストール
    - 基本的にはAD DSからAzure ADへの一方向
    - Azure AD Premiumエディションでは、パスワードなどの一部の情報についてAzure AD からAD DSに同期できる
- 同期サーバーの冗長構成
    - ステージングモード
    - Azure AD COnnectのセカンドサーバー
- 各ディレクトリでの使用可能な文字の違い
- 各ディレクトリのドメイン名の相違
- 同期の監視
    - Azure AD Connect Health

# ガバナンスとコンプライアンス
## 環境管理
### Microsoft Azureの環境管理
- タグ
    - Azureの各リソースに付与できる「キーと値」のペア
    - リソース一覧の表示
    - コスト分析の際のフィルター
- ロック
    - リソースの変更や削除を禁止する
    - ロックの種類
        - 削除ロック
        - 読み取り専用ロック
    - ロックは、サブスクリプション、リソースグループ、リソースのスコープで設定可能
    - 上位のスコープで設定されたロックは、下位のスコープに継承
- クォータ
    - 作成できるリソースの数などの上限設定
    - 引き上げ依頼も可能
- Azure Advisor
    - Azure環境及び存在するリソースをスキャンし、アドバイスを提供する機能
- Azure Policy
    - 組織でAzureを使用する上でのルールを構成する機能
- RBAC
    - Azureリソースへの詳細なアクセス制御を行う機能
- 管理グループ
    - 複数のサブスクリプションをグルーピングする機能
    - 複数のサブスクリプションに同じAzure PolicyやRBACの設定を適用したい場合
## コスト管理
### MS Azureにより発生するコスト
- 仮想マシン
    - 単価x実行時間
- ストレージ
- ネットワーク
    - アウトバウンド通信に課金
### コストのシュミレーション
- 料金計算ツール
### コストの確認及び管理
- コスト分析
- タグごとの集計
- 予算の設定によって、指定した予算の割合に達した時にアラートメールを送信したり、仮想マシンを設定するなどの特定のアクションを実行できる
### コスト削減オプション
- 予約
    - 1年または3年の長期使用のためのコスト削減オプション
- Azureハイブリッド特典
    - ソフトウェアアシュアランスを購入している組織向けのコスト削減オプション
- Visual Studioサブスクライバー向けのAzure クレジットの活用
## Azure Policy
### ビジネスルールに基づいたAzureの使用
- 組織独自のコンプライアンス要件を持つ場合
- 不要なリソース種類や不適切な構成での作成を制限したい場合
- リソース管理の一貫性を高めたい場合
### 実装手順
1. ポリシー定義の作成または確認
    - カスタム定義
        - JSON形式で記述
    - ビルトイン定義
        - 使用できるリソースの種類
        - 許可されていないリソースの種類
        - 許可されている場所
        - 許可されている仮想マシンSKU
        - タグとその値をリソースに追加する
1. イニシアティブ定義の作成
    - 複数のポリシー定義をまとめて使用したい場合
    - 複数のポリシーをグループ化
1. 割り当ての設定
    - ポリシー定義またはイニシアティブ定義を割り当てるスコープのパラメータを設定
    - スコープから一部のリソースグループやリソースなどを除外できる
1. 結果と評価の確認
    - ポリシー割り当て後、既存リソースに対する評価が実施
        - 準拠してない場合、「非準拠のリソース」としてリストアップ
        - 「コンプライアンス」で確認できる
## RBAC
### 概要
- 各スコープに対するきめ細かいアクセス制御
### 組み込みのロール
- 所有者
    - フルコントロール
- 共同作成者
    - すべてのリソースへのフルコントロールアクセス権
    - 他のユーザーへのアクセス権の付与はできない
- 閲覧者
    - 既存のリソースの表示だけ可能
### カスタムロール
### ロールの割り当て
- ロールはユーザーやグループに対してだけでなく、サービスプリンシパル(アプリケーション)に対して割り当てることも可能
- マネージドIDにも可能
- 加算方式、割り当てられたロールの和集合が実際のアクセス許可となる
    - notActionsは加算されない
### Azure VS Azure AD
- Azure
    - 目的: Azure リソースのアクセス管理
    - スコープ:
        - 管理グループ
        - サブスクリプション
        - リソースグループ
        - リソース
    - 構成に使用する管理ツール:
        - Azure Portal
        - Azure CLI
        - Azure PowerShell
        - ARM Template
        - REST API
    - カスタムロール: 作成可能
- Azure AD
    - 目的: Azure ADリソースの管理
    - スコープ:
        - テナント
        - 管理単位
        - 個々のオブジェクト
    - 構成に使用する管理ツール:
        - Azure Portal
        - Microsoft 365管理ポータル
        - AzureAD PowerShell
        - Microsoft Graph
    - カスタムロール: Azure AD Premiumでのみ作成可能

# 仮想マシン
## 仮想マシンの計画
### 仮想マシンサービスの概要
- MSのデータセンターで実行される仮想マシンのインスタンス
- サイズ
    - 性能を決定するパラメータ
    - 様々なシリーズ
    - 仮想マシンのサイズは後から変更可能。ただし再起動が必要で、ダウンタイムが発生
- ディスク
    - OSディスク
        - OSが含まれるディスク
        - 最大4TiB
        - Cドライブ
        - Azure Storage に作成される
    - 一時ディスク
        - キャッシュ用のディスク
        - Dドライブ
    - データディスク
        - アプリケーションやデータを格納する他mに追加が可能なオプション
        - Azure Storageに作成
    - 種類
        - Standard HDD
            - データのアクセス頻度が低い
        - Standard SSD
            - 開発及びテスト向けのディスク
        - Premium SSD
            - エンタープライズワークロード向け
        - Ultra Disk
            - トランザクション量の多いワークロード向け
    - ディスクストレージ
        - アンマネージドディスク
            - 事前にストレージアカウントを準備して、その中にでディスクを格納
            - ディスクデータ以外のデータの格納
            - Azure Storage Explorerなどのツールを使用した管理
            - Standard HDDの場合のみ、geo冗長ストレージを選択できる
        - マネージドディスク
            - 仮想マシン作成時に同時に作成可能
            - キャプチャ機能
            - スナップショット機能
            - 可用性ゾーン
- 可用性オプション
    - 可用性セット
        - 同じ構成の仮想マシンを複数作成するときに、1つのデータセンター内における配置先のラックやブレードを分けることができるオプション
        - 99.95%の実稼働率
        - 障害ドメイン
            - 仮想マシンをデータセンター内の幾つのラックに分散して配置するかを決定
            - 最大3
        - 更新ドメイン
            - 仮想マシンを幾つのサーバーグループに分散して配置するかを決定
            - 計画的なメンテナンス時にまとめて再起動されるサーバーの単位
            - 最大20
    - 可用性ゾーン
        - 同じ構成の仮想マシンを複数作成するときに、配置先のデータセンターを分けることができるオプション
        - 99.99%の実稼働率
        - データセンターの障害に対応できる
- 代表的な拡張機能
    - カスタムスクリプト拡張機能
        - 仮想マシンのOSで指定したスクリプトを実行するための拡張機能
    - PowerShell DSC拡張機能
        - PowerShellによるシステムの構成や展開を行う管理プラットフォーム
- テンプレートのエクスポートは、既存の仮想マシンと同じようなパラメータを持つ新しい仮想マシンを作成したい場合に役立つ
- 接続方法
    - リモートデスクトップ
        - リモートデスクトップを使用し接続
        - ポート番号は3389
    - SSH接続
        - パスワードまたは証明書ベースのSSHを使用し、接続
        - ポート番号は22
    - Bastion接続
        - ブラウザーから安全に仮想マシンに接続して操作する
        - 仮想マシンのRDPまたはSSHのポートを外部に公開することなく、仮想マシンに対する安全なリモート接続が提供される
        - ポート番号は443
        - 仮想マシンが接続する仮想ネットワークにBastionだけを配置する専用のサブネットを作成し、「AzureBastionSubnet」というサブネット名にしておく必要がある
        - アドレス範囲のプレフィックスの値は/26以下
        - BastionにパブリックIPアドレスを割り当てる
##　仮想マシンスケールセット
### システムの性能に対するアプローチ
- 垂直スケーリング
    - システムを構成するマシンのスペックを変更することで性能を調整するアプローチ
    - ダウンタイムが発生
- 水平スケーリング
    - システムを構成するマシンの台数を変更することで性能を調整する
- スケールインポリシー
    - 最新のVMポリシー
    - 最も古いVMポリシー
- アップグレードモード
    - スケールセットモデルによって仮想マシンを最新の状態に維持するための方法
    - 手動
    - 自動
    - ローリング
        - スケールセット内で同時に更新を行う仮想マシンの割合を指定しておき、その割合に応じて仮想マシンが順次更新される
- オーバープロビジョニング
    - 仮想マシンのプロビジョニングの成功率を向上するための設定
    - スケールセットは実際に要求された数より多くの仮想マシンを作成及び起動する
    - そして要求された数の仮想マシンが正常にプロビジョニングされたことが確認できたときに、余計に作成した仮想マシンを削除
    - 一時的に余計に作成された仮想マシンは課金対象とはならず、クォータ制限にもカウントされない
- 自動スケールプロファイル
    - 複数の自動スケールプロファイルが構成されている場合
        1. 指定日プロファイル
        1. 定期的プロファイル
        1. 規定のプロファイル
    - 1つの自動スケールプロファイル内に複数の規則が構成されている場合
        - 1つの自動スケールプロファイル内で、スケールアウト及びスケールインについての複数の規則を構成することができる
        - スケールアウトの規則は「いずれか」が満たされていれば自動スケールが実行されるのに対し、スケールインの規則は「すべて」が満たされているバイに限って自動スケールが実行
# ストレージ
## ストレージアカウント
### 概要
- ストレージの貸出サービス
### ストレージサービスの種類
- Azure Blob Storage
    - テキストデータやバイナリデータなど、大量の非構造化データを格納するために最適化されたサービス
- Azure Files
    - クラウド上にSMBファイル共有またはNFSファイル共有を作成するサービス
- Azure Queue Storage
    - 異なるアプリケーション間のデータ交換場所である、キューを提供するサービス
    - アプリケーションの非同期通信を実現するための場所
- Azure Table Storage
    - テーブルデータを格納するサービス
    - NoSQL
### Storage Account
- Standard汎用v2
    - HDD
    - サポートされているサービス
        - Blob
        - Files
        - Queue
        - Table
        - Data Lage Storage
    - Replication
        - LRS
        - GRS
        - RA-GRS
        - ZRS
        - GZRS
        - RA-GZRAS
- Premium ブロックBLOB
    - SSD
    - サポートされているサービス
        - Blob
    - Replication
        - LRS
        - ZRS
- Premium ページBLOB
    - SSD
    - サポートされているサービス
        - Blob
    - Replication
        - LRS
- Premiumファイル共有
    - SSD
    - サポートされているサービス
        - Files
    - Replication
        - LRS
        - ZRS
- パフォーマンス及びストレージアカウントの種類は後から変更不可
- ストレージアカウント作成後にレプリケーションオプションが変更できるかどうかは、現在と変更先の組み合わせで決まる
    - LRS->GRSは可能
    - LRS->ZRSはMSへのサポートが必要（ライブマイグレーション）
### Replication
- LRS
    - 1つのデータセンター内でデータが3つのディスクに同期的にコピー
    - イレブンナイン
- ZRS
    - 選択したリージョンの3つの可用性ゾーン間で、データを同期的にコピー
    - 12ナイン
- GRS
    - プライマリリージョンとセカンダリリージョンのそれぞれでLRS
    - 16ナイン
- RA-GRS
    - プライマリリージョンとセカンダリリージョンのそれぞれでLRS
    - 16ナイン
    - セカンダリリージョンへのエンドポイント両方が構成されるため、平常時でも読み取りアクセス可能
- GZRS
    - プライマリリージョンでZRS、セカンダリリージョンでLRS
    - 16ナイン以上
- RA-GZRS
    - プライマリリージョンでZRS、セカンダリリージョンでLRS
    - 16ナイン以上
    - セカンダリリージョンへのエンドポイント両方が構成されるため、平常時でも読み取りアクセス可能
## Blob
### 形式
- ファイルストレージ
    - ファイル単位で管理及びアクセスするストレージ
- ブロックストレージ
    - ブロック単位で管理及びアクセスするストレージ
- オブジェクトストレージ
    - 階層構造がなく、1つのストレージプールの中で各データをオブジェクトとして扱う
### Blob
- オブジェクトストレージ
- ストレージアカウント/コンテナー/BLOB
- パブリックアクセスレベル
    - プライベート
    - BLOB
    - コンテナー
- パブリックアクセスレベルがコンテナーの場合、ファイルの一覧を取得できる
- BLOBの種類
    - ブロックBLOB
        - 一般的なファイルや画像、ビデオなどのデータをクラウドに格納するほとんどの場合
    - 追加BLOB
        - 追加操作に最適化
        - BLOBの末尾へのブロック追加のみ許可され、既存のブロックの更新または削除はサポートされていない
        - 仮想マシンのログや監査ログを格納するシナリオに適する
        - ブロックIDを公開しない
    - ページBLOB
        - 512バイトのページの集まりであり、Azure仮想マシンで使用する仮想ディスクのプラットフォームのバックボーン
        - VHDファイルをアップロードしてAzure仮想マシンで使用する場合には、BLOBの種類でページBLOBを選択する必要がある
- ストレージのコスト
    - ストレージコスト
    - アクセスコスト
- アクセス層
    - ホット
        - 頻繁にアクセスされるデータに適した
        - ストレージコストは高めに、アクセスコストは安く
    - クール
        - 頻繁にはアクセスしないデータ
    - アーカイブ
        - アーカイブ層のデータはオフラインで格納され、アーカイブストレージ内にある間は読み取りも変更もできない
        - リハイドレート
            - アーカイブファイルの読み取りやダウンロードを行うには、最初にホットまたはクールに切り替える必要がある
- ライフサイクル管理のルールを使用することでアクセス層の変更を自動化できる
## Azure Files
### 概要
- SMBプロトロコルまたはNFSプロトコルを介してアクセス可能な、フルマネージドのファイル共有を提供するサービス
- Azureポータルから直接アップロード
- 他のコンピュータからマウントして使用
- オンプレミスのアプリケーションをクラウドにリフトアンドシフトするために利用
- ストレージ層
    - Premium
        - SSD
    - トランザクション最適化
        - HDD
    - ホット
        - チーム共有やAzure File Syncなどの汎用ファイル共有シナリオに最適化
    - クール
- SMBファイル共有に接続するには、ポート番号445を使用する通信がネットワーク経路上のファイアウォールで許可されている必要がある
- Azure File Sync
    - オンプレミスやAzure仮想マシンで実行されるWindoesファイルサーバーとAzure Filesのファイル共有を同期するためのサービス
    - コンポーネント
        - ストレージ同期サービス
            - Azure File Syncを行うために必要となる、Azure上に作成するリソース
            - Azure File Syncで使用するサーバーを登録するための最上位のオブジェクトであり、同期グループを管理する役割を担う
        - 登録済みサーバー
            - サーバーとストレージ同期サービス間の信頼関係を表すオブジェクト
            - 1vs多
        - Azure File Syncエージェント
            - Windows Serverにインストールするエージェントプログラム
        - 同期グループ
            - クラウドエンドポイントであるAzureファイル共有とサーバーエンドポイント間の同期リレーションシップを定義するオブジェクト
        - クラウドエンドポイント
            - Azureファイル共有へのポインターとなるオブジェクト
            - クラウドエンドポイントは同期を行う上でのハブとして動作する
            - 指定するAzureファイル共有のストレージアカウントは、ストレージ同期サービスと同じリージョンに存在する必要がある
        - サーバーエンドポイント
            - 登録済みサーバーのWindows Server上のディレクトリパスを表す情報
            - ボリューム上の特定のフォルダーまたはボリュームのルートを指定
- 実装手順
    1. ストレージ同期サービスのデプロイ
    1. Windows Serverの準備
    1. エージェントのインストールとストレージ同期サービスへのサーバー登録
    1. 同期グループとクラウドエンドポイントの作成
    1. サーバーエンドポイントの追加
## ストレージセキュリティ
### ストレージセキュリティ
- RBAC
- 安全な転送
- 論理的な削除
    - BLOBの保持期間は1年
    - Azure Filesのファイル共有はファイル共有レベルで可能
- サービスエンドポイント
    - インターネットを経由せずに、直接アクセス
    - ストレージアカウントのネットワークのメニューから、サービスエンドポイントの設定に加え、特定のパブリックインターネットIPアドレス範囲からのアクセスだけを許可することが可能
- Shared Access Signaure
    - 制限付きのアクセス権
    - リソースURI+SASトークン
- Storage Service Encryption
    - ストレージそのものを暗号化する機能
    - Microsoftマネージドキー
        - マイクロソフトによって内部的に管理される鍵で、暗号化に用いる
    - カスタムマネージドキー
        - 特定のキー交換のコンプライアンス要件を持つ組織などのシナリオで使用
        - ユーザー自身で鍵の交換や管理を行う必要がある
        - Key Vaultを用いて管理
## その他のストレージサービス
### Azure Storage Explorer
- Windows, Linux, macOSにインストール可能なツール
- Azure上のストレージにアクセスできるルールであり、このツールを介してストレージサービス内のデータを操作
### AzCopy
- コマンドラインユーティリティ
- ファイルシステムとストレージアカウントの間でのデータ転送や、ストレージアカウント間でのBLOBデータやファイルコピーなどをコマンド操作で実行することが可能
- Blob Storageのコンテナーを作成する際は、`$azcopy make`を使用し、エンドポイントや作成するコンテナー名を指定して実行
### Import/Exportサービス
- オンプレミスにあるファイルをAzure Blob Storageのコンテナーにアップロードする
- 対象となるデータをディスクドライブに格納し、それを打ち理的に配送することによって受け渡し
- Import
    - Azure Blob Storage
    - Azure Files
- Export
    - Azure Blob Storage
- 必要なもの
    - ジョブの作成
        - インポートジョブ
        - エクスポートジョブ
    - ディスク
    - WAImportExport
        - ディスクの配送準備
    - (Azure Data Blox Disk)
        - ディスクの用意が不要になる
- インポートの手順
    1. WAImportExportツールを使用して、データをディスクドライブにコピーし、BitLockerでディスクドライブを暗号化する
    1. Azure Portalでターゲットなるストレージアカウントやドライブのジャーナルファイルを指定し、インポートジョブを作成する
    1. ドライブの返送先となる住所と運送業者アカウント番号を指定する
    1. ジョブの作成時に提供された送付先住所にディスクドライブを発送
    1. インポートジョブの詳細で配送問い合わせ番号を更新し、インポートジョブを送信する
    1. ディスクドライブがAzureデータセンターに届き、スタッフによって処理される
    1. 運送業者アカウントを使用して、インポートジョブで提供された返送先住所にドライブが送付される
- エクスポート
    1. Azure portalでソースとなるストレージアカウントを指定し、エクスポートジョブを作成する
    1. エクスポートするデータのBLOBまたはコンテナーパスを指定する
    1. ドライブの返送先となる住所と運送業者アカウント番号を指定する
    1. ジョブの作成時に提供された送付先住所にディスクドライブを発送する
    1. エクスポートのジョブの詳細で配送問い合わせ番号を更新し、エクスポートジョブを送信する
    1. ディスクドライブがAzureデータセンターに届き、スタッフによって処理される
    1. ディスクドライブがBitLockerで暗号化され、Azure portalを介してそのキーが提供される
    1. 運送業者アカウントを使用して、エクスポートジョブで提供された返送先住所にドライブが送付される

# 仮想ネットワーク
## 基礎
### 仮想ネットワーク
- Azure内のネットワーク通信のための基本的な構成要素
- 既定では異なる仮想ネットワーク間は通信できないが、ピアリング設定やVPNゲートウェイの使用により、異なる仮想ネットワークやオンプレミスのネットワークと通信できるように構成可能
### サブネット
- ネットワークを論理的に分割したもの
- 1つの仮想ネットワークには1つい上のサブネットが必要
- 既定ではどのサブネットに接続された仮想マシンでもお互いに通信可能
- Azure内部DHCPサービス
    - 仮想マシンなどのリソースにプライベートIPアドレスが配布される
    - ホスト部は4以降
    - 仮想ネットワークのアドレス空間から、特定のアドレス範囲を切り出したものをサブネットとして使用
- ピアリングを構成済みの仮想ネットワークでアドレス空間の変更を行う場合は、ピアリングを一旦削除してアドレス空間の変更後にピアリングを再度構成するか、アドレス空間の変更後にピアリングを再同期する必要がある
- サブネットの削除は、そのサブネットにどのAzureリソースも接続されていない状態でのみ実行可能
### ネットワークインターフェイス
- IPアドレスがネットワークインターフェイスに割り当てられて使用
- プライベートIPアドレス
    - 主に仮想ネットワーク内での通信に使用
    - VPNゲートウェイなどによって仮想ネットワークとオンプレミスネットワークが接続されている場合は、オンプレミスネットワークのコンピューターとの通信で使用
    - 仮想マシン-ネットワークインターフェイス-動的/静的
    - ロードバランサー-フロントエンド構成-動的/静的
    - アプリケーションゲートウェイ-フロントエンド構成-動的/静的
- パブリックIPアドレス
    - インターネットからのアクセスに使用
    - 仮想マシン-ネットワークインターフェイス-動的/静的
    - ロードバランサー-フロントエンド構成-動的/静的
    - VPNゲートウェイ-ゲートウェイIPの構成-動的/静的
    - アプリケーションゲートウェイ-フロントエンド構成-動的/静的
    - Azure Firewall-フロントエンド構成-静的
    - 仮想マシンでパブリックIPアドレスを動的に割り当てで使用する場合、起動時にパブリックIPアドレスを取得し、停止時にそのアドレスをリリースする
    - パブリックIPアドレスのSKUがStandardな時、静的な割り当てのみ可能
    - Standardでは可溶性ゾーンがサポート
    - パブリックIPアドレス作成後のSKUの変更は、BasicからStandardへのみ可能
        - ロードバランサーやネットワークインターフェイスなどとの関連付けが解除されていること
        - 静的な割り当て方法が選択されていること
## ネットワークセキュリティグループ
### 概要
- 仮想マシンが送受信するネットワークトラフィックを制御するためのファイアウォール機能を提供
- 仮想マシンが使用するネットワークインターフェイスにNSGを環rf連づけた場合、その仮想マシンに向かってくるトラフィックと出ていくトラフィックを制御可能
- 仮想ネットワークのサブネットにNSGを関連付けて使用することが可能
- 受信セキュリティ規則と送信セキュリティ規則
- 規定の規則
    - NSGで最初から構成される規則
    - 受信セキュリティ規則
        - AllowVnetInBound
            - 同じ仮想ネットワーク内やピアリングされた仮想ネットワークなどからのトラフィックを許可
        - AllowAzureLoadBalancerInBound
            - ロードバランサーからのプローブトラフィックを許可
        - DenyAllInBound
            - 他のいずれの規則にも一致しないすべてのトラフィックを拒否
    - 送信セキュリティ規則
        - AllowVnetOutBound
            - 同じ仮想ネットワーク内やピアリングされたかそうネットワークなど宛のトラフィックを許可
        - AllowInternetOutBound
            - インターネット宛の通信を許可
        - DenyAllOutBound
            - 他のいずれの規則にも一致しないすべてのトラフィックを拒否
- 規則は優先度順にチェックされ、より高い優先度の規則の条件に一致した場合、その規則より低い優先度の規則は適用されない
- ネットワークインターフェイスとサブネットに異なるNSGを関連づけた場合、特定のトラフィックを許可するためには、両方のNSGに許可規則が存在する必要がある
- NSGのリージョンとその関連付け先のリソースのリージョンは同じである必要がある
- サービスタグ
    - 必要に応じて、受信セキュリティ規則のソースでは、IPアドレスやその範囲を直接的に指定する代わりに使用できる
    - 特定のIPadoress Prefixのグループを表すものであり、InternetやVirtual Netowrkなどの選択肢がある
- アプリケーションセキュリティグループ
    - 複数の仮想マシンのネットワークインターフェイスをグループ化したもので、作成したASGはNSGの規則の送信元及び宛先として使用できる
    - メリット
        - NSGの規則の数を削減できる
        - 特定の役割のサーバーが追加されてもNSGの規則を修正する必要がない
        - ここの仮想マシンのIPアドレスを意識する必要がない
## Azure Firewall
### 概要
- Azure仮想ネットワークリソースを保護するクラウドベースのマネージドネットワークセキュリティサービス
- 高い可用性とスケーラビリティを備えた、ステートフルなサービスとして機能
- 異なるネットワーク間に設置するネットワークファイアウォールのようなサービス
- サブスクリプションと仮想ネットワークを跨いだアプリケーションとネットワークの接続ポリシーを一元的に作成、管理
- オンプレミスのネットワークとVPNなどで接続することにより、オンプレミスのネットワークからインターネット宛に送信されるトラフィックについてもAzure Firewallを通すことが可能
- 実装手順
    1. ネットワークインフラストラクチャの作成
        - Azure Firewallをデプロイするための仮想ネットワーク及びサブネットを作成
        - 仮想ネットワーク名は任意だが、サブネット名は「AzureFirewallSubnet」
        - アドレスプレフィックスは、/26以下にする必要がある
        - 専用の仮想ネットワーク上にファイアウォールを配置することが推奨される
            - その場合は仮想ネットワーク間で通信できるようにピアリングの構成が必要
    1. Azure Firewallのデプロイ
        - デプロイ後、Azure Firewallに割り当てられたプライベートIPアドレスとパブリックIPアドレスを確認
    1. ルートテーブルの作成とサブネットへの関連付け
        - デプロイ後、ルートテーブルを作成
            - ルートテーブルがない場合、ネットワーク間の通信が直接的に行われてしまうため
            - 仮想マシンからインターネットへの送信について、既定ではシステムルートに従って直接送信されてしまいAzure Firewallを経由しない
            - ルートの追加画面では、ネクストホップの種類で仮想アプライアンスを選択して、Azure FirewallのプライベートIPアドレスを指定することにより、Azure Firewall経由にすることが可能
            - ルート構成後、仮想マシンが接続している仮想ネットワークとサブネットでそのルートテーブルが使用されるように関連付けを行う
    1. ファイアウォールポリシーと規則の作成
        - ファイアウォールポリシーの構成により、Azure Firewallを介したネットワークトラフィックが、規則で指定した送信元や宛先及びアクションに基づいて制御される
- ファイアウォールポリシー
    - 規則コレクションと呼ばれる種類ごとに管理
        - 種類が同じ規則の集まり
    - 構成できる規則は3種類
    - 規則コレクションはその種類と優先順位に基づいて処理
    - 既定では、すべてのトラフィックが拒否される
    - ネットワーク規則
        - アウトバウンドとインバウンドの両方の通信で使用される規則
        - TCP, UDP, ICMPまたは任意のIPプロトコルとポート番号を指定し、条件に一致したネットワークトラフィックを許可または拒否できる
    - アプリケーション規則
        - アウトバウンド通信で使用される規則
        - HTTP, HTTPS, またはMSSLQのいずれかのプロトコルと過疎ネットワーク及びサブネットからアクセス可能な宛先をFQDNで指定して定義
        - ネットワーク規則が優先
    - DNAT規則
        - インバウンド通信に対して使用される規則
        - 受信トラフィックのアドレス変換とフィルタリングを実行できる
        - ファイアウォールのパブリックIPアドレスとパブリックポートを、特定のプライベートIPアドレスとプライベートポートに変換する
            - 仮想マシン子が使用するIPアドレスを隠蔽しつつRDPやSSHを許可したい場合、HTTP/HTTPS以外を使用するアプリケーションなどをインターネットに公開したい場合に役立つ
## Azure DNS
### 概要
- 名前解決のために使用可能なDNSサービス
- ドメインのホスティングサービスであり、Microsoft Azure インフラストラクチャを使用した名前解決を提供
- 外部の名前解決
    - インターネット上の名前解決を目的
    - DNSゾーンを作成して組織が所有しているドメインのホスティングを行い、レコードを管理することが可能
    - ドメインの購入そのものは、App Serviceドメインまたはサードパーティのドメインレジストらを利用する必要がある
    - Azure DNSはドメインレジストラーではなく、他の手段によって購入したドメインをホスティングするサービス
- 内部の名前解決
    - 仮想ネットワーク上の名前解決を目的
    - プライベートDNSゾーンを作成してレコードを登録すると、仮想ネットワークにおけるドメイン名の管理と名前解決を行うことができる
    - BINDやDNSを実装した仮想マシンを構成せずに、プライベートDNSゾーンの使用によって1つまたは複数の仮想ネットワーク上での仮想マシンの名前解決が提供
### DNS委任
- ドメインに対するDNSクエリがAzure DNSに到達するには、ドメインが親ドメインからAzure DNSに委任される必要がある
- DNS委任
    - 親ドメインが子ドメインに対し、一部のドメインの管理を任せること
    - 所有するドメインを自分で管理するには、DNSの上位階層となる親ドメインからDNSの委任を受ける必要がある
    - 委任により、そのドメインを含む配下のDNSツリー構造を委任先の管理者が自由に管理可能になり、インターネット上でのそのドメインの名前解決要求には該当するゾーン及びレコードの情報が使用されるようになる
- 具体的には、親ドメインのゾーンでAzure DNSをさん諸王するNSレコードを作成する必要がある
    - Azure DNSのゾーンをホストする4つのネームサーバーの情報をドメインレジストラーに連絡し、そのドメインの名前解決要求では、それらのAzure DNSゾーン内の情報がサンショス荒れるようにNSレコードを登録してもらう必要がある
    - 4つすべてのネームサーバーを登録する必要がある
### プライベートDNSゾーン
- 仮想ネットワーク内及び仮想ネットワーク間での名前解決を実現
- 独自のカスタムドメインを自由に使用
- 仮想ネットワークをプライベートDNSゾーンに関連づける際には下記の関連付け方法を選択
    - 解決仮想ネットワーク
        - 動的登録を行わない
        - 手動でレコードを管理
    - 登録仮想ネットワーク
        - その仮想ネットワークに接続する仮想マシンのレコードがプライベートDNSゾーンに動的登録される
        - 手動での操作も可能
- 複数の仮想ネットワークおよび異なるリージョン間における名前解決が可能

# サイト間接続
## ピアリング
### 概要
- Azure上の2つ以上の仮想ネットワークをシームレスに接続可能
- ネットワーク同士は、リージョン内ネットワークまたはマイクロソフトのバックボーンネットワークによって接続されるため、待機時間の短い広帯域幅の接続が可能
- 仮装ネットワークピアリング
    - 同じリージョン内の仮想ネットワークを接続するピアリングの種類
- グローバル仮想ネットワークピアリング
    - 異なるリージョン間の仮想ネットワークを接続するピアリング
- 特徴
    - 待機時間の短い高帯域幅の接続が可能
    - 異なるリージョン間、異なるサブスクリプション間や異なるテナント間でのピアリングも可能
    - アドレス空間は重複してはならない
    - 原則として方向ごとのピアリングの設定が必要
        - 1つの画面操作によって各方向のピアリング設定を作成できる
    - ピアリングの設定は明示的に指定した2つの仮想ネットワーク間でのみ有効
    - ピアリング構成済みの仮想ネットワークでアドレス空間の変更を行うには、ピアリングの再設定または同期操作のいずれかが必要
- オプション
    - VPNゲートウェイの共有
        - ある仮想ネットワーク上に配置されたVPNゲートウェイを他の仮想ネットワークからも使用できるように共有するオプション設定
        - VPNゲートウェイを貸すための設定と、VPNゲートウェイを借りるための設定を各ピアリング設定で行う
    - サービスチェイニングのためのトラフィック転送
        - ルーターやファイアウォールなどのネットワーク機能を連携し、適切な順番でパケットのやり取りが行われるようにするための構成や仕組み
        - ピアリングによりハブスポーク方のネットワークトポロジを形成すると、サービスチェイニングを実現できる
        - SpokeVNet同士の通信はできないが、SpokeVNetはHubVNetとの通信が可能
        - HubVNet上にルーターやネットワーク仮想アプライアンスなどを配置すれば, HubVNetを通して、SpokeVNet間が通信できるように構成可能
            - 転送される側のピアリング設定にて、転送されたトラフィックを受け入れるための設定が必要
        - NVA
            - 境界ネットワーク (DMZ、非武装地帯、スクリーン サブネットとも呼ばれます) とパブリック インターネットの間など、さまざまなセキュリティ レベルで分類されたネットワーク セグメント間のトラフィックフローを制御するために使用
## VPNゲートウェイ
- Azure上に作成可能な仮想ネットワークゲートウェイの一種
- パブリックインターネット経由で異なるネットワーク間を接続し、暗号化されたトラフィックを送受信するために使用
- サイト間接続
    - オンプレミスネットワークとAzureの仮想ネットワークを接続するための構成
    - インターネットVPNを使用してオンプレミスネットワークと仮想ネットワークを接続し、1つのネットワークとして機能
    - VPNプロトコルにはIPsec/IKE
    - 実装手順
        1. 仮想ネットワーク及びゲートウェイサブネットの作成
            - 任意の仮想ネットワーク
            - 専用のサブネット
                - GatewaySubnet
            - アドレスプレフィックス長としては/27または/28を推奨
        1. VPNゲートウェイの作成
            - 仮想マシン
                - ゲートウェイの種類
                    - VPN
                    - ExpressRoute
                - VPNの種類
                    - 後から変更不可
                    - 種類
                        - ポリシーベース
                            - IPsecポリシーに基づいて、パケットを送信
                            - 主にテストを目的としたBasic SKU
                            - アクティブ/アクティブモードは使用不可
                        - ルートベース
                            - IP転送やルーティングテーブルのルートに基づいてパケットを送信
                - VPNゲートウェイのSKUと世代
                    - Basic SKUを除くすべてのVPNゲートウェイのSKUでは、BGPがサポートされている
                        - BGP
                            - 複数のネットワーク間でルーティングと到達可能性情報を交換するために、インターネット上で一般的に使用されている標準のルーティングプロトコル
                    - Basicを除いて、同じ世代内であれば変更可能
                    - ゾーン上長をサポートするSKUとサポートしないSKUの間での変更はできない
        1. ローカルネットワークゲートウェイの作成
            - オンプレミスネットワーク上にVPNデバイスを設置し、そのVPNデバイスのIPアドレスなどの情報をAzure上に登録するために、ローカルネットワークゲートウェイというリソースを作成
            - VPNデバイスとして、Windows Serverで「ルーティングとリモートアクセスサービス」を構成してVPNデバイスとして使用することが可能
            - VPNデバイスの情報として必要なもの
                - 共有キー
                - VPNゲートウェイのパブリックIPアドレス
        1. 接続の作成と確認
            - Azure上に作成したVPNゲートウェイとオンプレミスネットワークのVPNデバイス情報であるローカルネットワークゲートウェイを接続
    - 仮想ネットワークにデプロイするリソースの名前解決を行う必要がある場合は、仮想ネットワーク構成で使用するDNSサーバーを指定する必要がある
- ポイント対サイト接続
    - 個々のクライアントコンピューターをAzureの仮想ネットワークに接続するための構成
    - インターネット経由で最大10000台まで任意の場所で実行されるWindows, macOS, Linuxコンピューターを仮想ネットワークに接続
    - プロトコル
        - OpenVPN
        - SSTP
        - IKE-v2
- 仮想ネットワーク間接続
    - Azure上の仮想ネットワーク同士をVPNで接続するための構成
    - Azureバックボーンネットワークを経由して送信
    - 高スループットを必要とせず、暗号化や推移的なルーティングだけが必要な一部のシナリオで使用
- 高可用性シナリオ
    - 内部的には2つのインスタンスがデプロイされており、既定ではこの2つのインスタンスがアクティブ/スタンバイで構成される
    - アクティブなインスタンスに対してメンテナンスや何らかの問題が発生した場合は、スタンバイインスタンスへの自動的なフェールオーバーが行われ、サイト間接続または仮想ネットワーク間接続が再開される
    - 計画的メンテナンスの場合は、10~15秒以内に接続が回復するが、予期しない問題の場合には接続の復旧に1~3分ほどかかる可能性がある
    - ポイント対サイト接続の場合は、クライアントコンピューターからの接続が切断されるため、ユーザーが自分で再接続する必要がある
    - Basic SKUではアクティブ/アクティブモードを有効化できる
        - 各テートウェイインスタンスが個別のパブリックIPアドレスを持ち、ローカルネットワークゲートウェイとの接続が指定されたオンプレミスのVPNデバイスへのIPsec/IKEサイト間VPNトンネルを確立
        - VPNゲートウェイ作成後に有効化することも可能
            - 2番目のパブリックIPアドレスの作成または割り当てが必要
        - オンプレミスネットワークにも2つのVPNデバイスを設置してクロスプレミスで接続も可能
## ExpressRoute とVirtual WAN
### 概要
- オンプレミスネットワークとマイクロソフトデータセンターを閉域網で接続するサービスであり、インターネットを使用しないため、高い安全性を持つ
- VPNによるサイト間接続はあくまでもベストエフォート通信であり、ネットワークの帯域幅の保証がないことから通信の遅延などの問題が発生することがある
- 組織のコンプライアンス上の理由から、インターネットを経由すること自体を避けたいと考える場合もある
- マイクロソフトとのAzure契約とは別に、接続プロバイダーとの契約も必要
- サポートされる帯域幅
    - 50Mbps〜10Gbps
- 冗長性を備えた接続
    - 標準的な動的ルーティングプロトコルであるBGPが利用
        - オンプレミスネットワーク, Azureインスタンス、マイクロソフトパブリックアドレスの間でルートを交換し、通信の種類ごとに個別のBGPセッションを確立
    - かくExpressRoute回線では、接続プロバイダー/オンプレミス側のネットワークエッジと、接続ポイントに配置した2つのマイクロソフトエンタープライズエッジルーターが接続される構成
        - 冗長性を向上するには、接続プロバイダー/オンプレミス側から各MSEEに対して、1つずつ計2つのBGP接続が必要
    - 接続可能なクラウドサービス
    - 課金モデル
        - 従量課金
            - 月額の基本料金+送信データ量
        - 無制限
            - 月額の基本料金のみ
- SKU
    - ローカル
        - ExpressRouteの接続場所から最も近いリージョンにのみ接続可能
        - 課金モデルは無制限のみ
        - 提供される回線帯域幅は1Gbps以上
    - Standard
        - ExpressRouteの接続場所と同一地域内のリージョンに接続可能なSKU
    - Premium
        - ExpressRouteの接続場所を問わず、特殊リージョンを除く世界中のすべてのリージョンに接続可能なSKU
- 接続方法
    - Point-to-Point Ethernet Connections
        - オンプレミスネットワークから直接、ExpressRoute回線を使用してマイクロソフトネットワークおよびデータセンターへ接続する方法
        - 日本では不可能
    - Co-located at a cloud exchange
        - L2接続サービス
        - 接続ポイントに回線引き込み済みの接続プロバイダーと契約し、接続プロバイダーの曲内に自社の機材を導入する方法
        - オンプレミスネットワークから接続プロバイダーの局内までは任意のキャリアで接続
            - ユーザー自身で接続ポイントの施設内にルーターを設置、オンプレミスネットワークとの接続を行う
                - ネットワークの自由な設計、管理が可能
                - 運用コストが高い
    - Any-to-any networks
        - L3接続サービス
        - 接続ポイントに回線引き込み済みの接続プロバイダーのWAN回線を利用
        - 接続プロバイダーが提供するWANサービスに相乗りして、ExpressRouteに接続する方法
        - オンプレミスネットワークからWANサービスまでの間はIP-VPNなどでの接続が必要になるが、その先のルーターおよびネットワークの管理や設定などは接続プロバイダーによって行われる
            - 運用コストが低い
- ピアリング
    - ExpressRouteピアリング
        - 利用時、ExpressRoute回線というリソースを作成し、そのリソース内でピアリング情報を構成
        - Azureプライベートピアリング
            - Azure仮想ネットワークとの接続に使用するピアリング
            - 仮想ネットワークに接続された仮想マシンとクラウドサービスにプライベートIPアドレスで接続可能
        - Microsoftピアリング
            - マイクロソフトのオンラインサービスとの接続に使用するピアリング
            - パブリックIPアドレスのみ使用可能のため、その準備とオンプレミスネットワーク側ではNATを使用してプライベートIPアドレスをパブリックIPアドレスに変換する必要がある
        - 接続先に適したピアリングを構成して使用
- 実装方法
    1. ExpressRoute回線の作成
        - Azure上に「ExpressRoute回線」という種類のリソースを作成
        - 個別のExpressRoute回線を識別するための「サービスキー」と呼ばれるIDが発行され、接続プロバイダー側での初期設定に必要な情報
        - 接続プロバイダへのサービスキーの連絡と初期設定が完了すると「プロビジョニング済み」となる
    1. ExpressRouteピアリングの構成
        - Any-to-any networksの場合は、ピアリングの有効化を接続プロバイダーに依頼可能
    1. ExpressRoutゲートウェイの作成
        - 接続先となる仮想ネットワーク上にゲートウェイサブネットを用意し、仮想ネットワークゲートウェイを作成
        - ゲートウェイサブネット
            - GatewaySubnet
            - /26以下
        - SKUの選択
    1. 接続の作成と確認
- ExpressRouteによる接続とサイト間VPN接続
    - コストを抑えながら接続の可用性を高める方法としてExpressRouteによる接続とサイト間VPN接続の併用
    - 共存可能だが、それぞれの種類の仮想ネットワークゲートウェイが必要。またBasic SKUのVPNゲートウェイは共存構成をサポートしていない
### Virtual WAN
- Azureが提供する様々なネットワーク接続サービスを集約した。大規模拠点間接続サービス
- 多数の接続サービスを1つの運用インターフェイスに統合し、ハブスポーツ型でのフルメッシュ接続を構成
- Azure上に仮装ハブを作成し、その仮想ハブに仮想ネットワークや拠点ネットワークデバイスを接続して使用
- ハブゲートウェイはアクティブ/アクティブでデプロイ
- SKU
    - Basic
        - サイト間VPNのみ
    - Standard
        - ポイント対サイト
        - サイト間VPN
        - ExpressRoute
        - 仮想ハブを経由したハブ間及びVNet対VNetトランジット
# ネットワークトラフィック管理
## ルートテーブル
### システムルート
- トラフィックはルーティングによって特定の経路で送受信される
- Azureではユーザーの保守が不要なルートテーブルが自動的に作成され、仮想ネットワークの各サブネットに割り当てられる
- 仮想ネットワークが作成されるたびに、いくつかの規定のルート情報を含むシステムルートが自動的に作成
- サブネットごとに割り当てられる
- 各ルートにはアドレスプレフィックスとネクストホップの種類が含まれる
- サブネット内から送信されるトラフィックの宛先が特定のルートのアドレスプレフィクスに含まれている時に、そのプレフィックスを含むルート情報が使用される
- 既定
    - 接続している仮想ネットワークのアドレス空間-仮想ネットワーク
    - 0.0.0.0/0-インターネット
    - 10.0.0.0/8-なし
    - 192.168.0.0/16-なし
    - 100.64.0.0/10-なし
- 特定のオプション
    - ピアとなる仮想ネットワークのアドレス空間-VNETピアリング-すべてのサブネット
    - BGP経由でオンプレミスからアドバタ出されたプレフィックス、またはローカルネットワークゲートウェイで構成されているプレフィックス-仮想ネットワークゲートウェイ-すべてのサブネット
    - サービスエンドポイント設定で選択したサービスの種類によって異なる複数のプレフィックス-VirtualNetworkServiceEndpoint-サービスエンドポイントが有効になっているサブネットのみ
- ルート情報変更の必要性
    - ある宛先への通信時に特定のNVAや仮想ネットワークをネクストホップとして指定したい場合には、ルート情報の変更が必要
    - ユーザー定義ルートを作成することで、システムルートよりも優先度が高いルート情報として使用
- ユーザー定義ルートの実装
    1. ルートテーブルの作成
    1. ルートの追加
    1. サブネットへの関連付け
        - 作成したルートテーブルを使用するには、仮想ネットワークのサブネットへの関連付けが必要
    1. 変更されたルートの確認
## サービスエンドポイントとPrivate Link
### サービスエンドポイントの概要
- サービスエンドポイントを使用すると、Azureのバックボーンネットワーク上で最適化されたルートを介して、ストレージやSQL DatabaseなどのAzureサービスに安全に直接接続可能
- インターネット経由のアクセスはブロックされる
- サービスエンドポイントの有効化
    - 仮想ネットワークのサブネットごとに、サービスエンドポイントを使用するサービスを選択して行う
    - ルートテーブルの変更とサービスごとのファイアウォール機能によって実現される
### Private Linkの概要
- 様々なリソース間のプライベート接続を提要
- 仮想ネットワークからAzure PaaSサービス、あるいはAzure 上で運用している自社の業務システムなどへのプライベート接続を行うためのプライベートエンドポイントを構成
- プライベートエンドポイント用のネットワークインターフェイスが作成され、このネットワークインターフェイスにプライベートIPアドレスが割り当てられる
    - プライベートエンドポイントにストレージアカウントなどのリソースをマップすることによって、リソースへの直接アクセスを実現
### 違い
- プライベートエンドポイントでは、グローバルな展開が可能
- プライベートエンドポイントでは、様々なネットワークから使用可能
    - ExpressRouteやVPNトンネルで接続されたオンプレミスネットワークからも、アクセス可能
## Azure Load Balancer
### 負荷分散サービス
- Azure Load Balancer
    - レイヤー4のロードバランサーとして使用
    - 任意のポート番号とプロトコルを振り分けの条件に使用し、いくつかの仮想マシンで負荷を分散
    - Webサーバー以外の負荷分散に使用
    - ハッシュベースの分散アルゴリズム
        - 種類
            - 送信元IPアドレス
            - 送信元ポート
            - 宛先IPアドレス
            - 宛先ポート
            - プロトコル
        - セッションが切れた場合は、異なる仮想マシンにトラフィックが向かう可能性がある
    - フロントエンドIPアドレス
        - ロードバランサーのIPアドレスのグループ
        - 追加可能
        - インターネットからのアクセス要求を負荷分散する場合には、パブリックIPアドレスの割り当てが必要
    - バックエンドプール
        - 負荷分散先となる仮想マシンのグループ
        - 追加する仮想マシン及び仮想マシンスケールセットは、ロードバランサーと同じリージョンに存在する必要がある
        - パブリックIPアドrすが構成されている場合、リソースで使用するパブリックIPアドレスのSKUとロードバランサーのSKUが一致する必要がある
    - ロードバランサーで使用する規則
        - 負荷分散規則
            - 負荷分散が目的の場合
            - セッションの永続化が可能
        - インバウンドNAT規則
            - 1対1のポート変換が目的の場合
            - 受信したトラフィックを特定の仮想マシンにルーティングするための規則
            - 1対1のポート変換を行うことにより、外部ポートを隠蔽できる
        - アウトバウンド規則
            - インターネット通信
    - 正常性プローブ
        - バックエンドプール内の死活監視を行うコンポーネント
        - TCPによる正常性プローブについて、3ウェイハンドシェイクの通信を送信
        - HTTP/HTTPSによる正常性プローブについて、HTTP/HTTPSリクエストを送信
    - ロードバランサーの種類
        - パブリック
            - ロードバランサーがパブリックIPアドレスをもち、インターネットからロードバランサー宛に送られたトラフィックが分散される
            - NATが行われるため、バックエンドプールに含まれるここの仮想マシンにはパブリックIPアドレスが不要
            - バックエンドプール内の死活監視を行うためにプライベートIPアドレスも所有
        - 内部
            - パブリックIPアドレスを持たないロードバランサーの種類
            - プライベートIPアドレスをもち、仮想ネットワーク内からロードバランサー宛に送られたトラフィックが分散される
            - 内部的に行われる通信を分散するため
    - SKU
        - basic
            - 無料だがSLAが提供されない
            - バックエンドプールに含まれる仮想マシンの数は300まで
            - 単一の可用性セットが構成された仮想マシンまたは仮想マシンスケールセット
            - 可用性ゾーンは使用不可
        - Standard
            - 有料だが、99.99%のSLA
            - バックエンドプールには最大1000の同じ仮想ネットワーク内の任意の仮想マシン
            - 単一の仮想ネットワーク内の任意の仮想マシンまたは仮想マシンスケールセット
            - 可用性ゾーンは使用可能
- Azure Application Gateway
    - レイヤー7のロードバランサーとして使用
    - Webサーバー専用の負荷分散サービス
        - WAFやSSLオフロード機能も使用可能
    - 要求されたURLのパスやホストヘッダーなどのHTTPリクエストの追加属性に基づいて振り分け先を決定して負荷分散を行う
    - WAF
        - SQLインジェクション攻撃などの悪意のある攻撃から保護
        - WAFのSKUを持つAzure Application Gatewayが必要
    - SSLターミネーション
        - SSL/TLS証明書をバックエンドプール内のここのサーバーにインストールしなくても、Azure Pllication GatewayにSSL/TLS証明書をインストールするだけで外部との通信にHTTPSが使用できるようになる
    - URLベースのルーティング
    - 複数サイトのホスティング
        - ドメイン名またはホスト名に基づくルーティングを行う
        - マルチサイトリスナーの構成
    - 自動スケール
    - 構成要素
        - フロントエンドIPアドレス
        - リスナー
            - クライアントから送信された要求がリスナーに検出されると、規則に構成されているバックエンドプールのメンバーにその要求がルーティングされる
            - Basic
            - マルチサイト
        - 要求ルーティング規則
            - リスナーが要求を受け取ると、要求ルーティング規則により要求がバックエンドに転送されるか、他の場所にリダイレクトされる
            - バックエンドに転送される場合は、規則によって転送先となるバックエンドサーバープールが決定される
            - Basic
            - 要求を、要求に含まれるURLのパスに基づいて特定のバックエンドプールにルーティングしたい場合に使用
        - HTTP設定
            - バックエンドプロトコルやバックエンドポートなどの指定が含まれる
            - Cookieベースのアフィニティ
                - Webアプリケーションでセッション情報を維持するため
        - バックエンドプール
        - 正常性プローブ
- アプリケーションゲートウェイをデプロイするには専用のサブネットが必要
# App Serviceとコンテナー
## App Service
### 概要
- Webアプリケーション、REST API、及びモバイルバックエンドなどをホストするためのHTTPベースのサービス
- App Service プラン
    - Webアプリを動かすための仮想マシンの設定
    - App Serviceプランの単位でコストが発生
    - 価格
        - Free, Shared, Basic
            - 開発やテスト
            - 自動スケールはない
            - デプロイスロットもない
        - Standard, Premium
            - 一般的なアプリ
        - Isolated
            - 高速なネットワーク環境で実行したいワークロードがある場合
- App ServiceプランとApp Serviceのリージョンは同じである必要あり
- デプロイセンター
    - 実行するWebアプリのコンテンツをアップロードする必要
- デプロイスロット
    - Webアプリの新バージョンの開発及び確認とその公開をスムーズに行うための機能
    - Standard以上のプランで利用可能
    - スワップ後に何らかの問題があった場合、再度スワップを行うことで以前のWebアプリに戻せる
- カスタムドメイン
    - ドメインの所有権の検証が必要
- スケールアップ及びスケールダウン
- スケールアウト及びスケールイン
- バックアップ
    - Standard以上で可能
    - ストレージアカウント内のBLOBコンテナーに格納
## コンテナーサービス
### 概要
- コンテナー
    - アプリケーションのコードとアプリの実行に必要な構成関連ファイル、ライブラリ、依存関係をまとめたもの
    - OSのユーザーモード部分のみを実行し、アプリとその実行に必要なものだけを含めることにより、少ないリソースで軽量に動作
- ACI
    - Azure COntainer Inscances
    - Dockerコンテナーを実行するためのシンプルな環境を提供
    - 高速な起動
    - アクセス範囲を選択可能
        - パブリックかプライベートか
    - 柔軟なサイズ指定
    - データ保持のためにAzure Filesを利用可能
    - WindowsコンテナーとLinuxコンテナーのサポート
- AKS
    - Azure Kubernetes Service
    - Kubernetesによるコンテナーオーケストレーションを行うことができる、高度なDockerコンテナー実行環境を提供するサービス
    - 負荷分散や障害対策などの機能を含むコンテナークラスターを構築し、複数のコンテナーを一元的に管理する
    - ノード
        - コンテナーかされたアプリケーションを実行する仮想マシン
        - 構成要素
            - kubelet
                - 各ノード内で実行されるエージェント
                - コントロールプレーンからオーケストレーション要求を処理して、該当コンテナーの起動スケジュールを管理
            - kube-proxy
                - 各ノード上で仮想ネットワークを処理する
                - ネットワークトラフィックをルーティングし、サービスとポッドのIPアドレスを管理
            - コンテナーらんたいむ
                - コンテナーかされたアプリケーションを実行し、仮想ネットワークやストレージなどの外部のリソースと通信できるようにする
    - ノードプール
        - 同じ構成のノードのグループ
    - ポッド
        - ノード内で実行されるアプリケーションの1つのインスタンス
    - デプロイメント
        - ポッドやレプリカセット単位でのデプロイのあり方を定義したもの
    - レプリカセット
        - 同じ機能を持つ複数のポッドをまとめて起動し、維持するために使用
    - マニフェストファイル
        - 使用するコンテナーイメージや実行するポットの数などを指定したテキストファイル
        - YAML
    - コントロールプレーン
        - Azureが管理するマネージドリソースとして、無料で提供されるコンポーネント
        - AKSクラスターを作成すると、コントロールプレーンも同時に作成及び構成される
        - 構成要素
            - APIサーバー
                - kubectlやKubernetesダッシュボードなど、管理ツールに対する操作を提供するコンポーネント
            - etcd
                - Kubernetesクラスターと構成の状態を維持するため使用されるKubernetes内のキー値ストア
            - スケジューラー
                - アプリケーションの作成/スケーリング時に、ワークロードを実行するノードを判断するコンポーネント
            - コントローラーマネージャー
                - ポッドのレプリケーションやノード調整などを行う多数のコントローラーを監視する
    - プリセット構成
        - 簡単にカスタマイズするため
# データ保護
## Azure Backup
### 概要
- Azure仮想マシンのディスクであるVHDファイルは、Azureストレージアカウント内に格納される
- シンプルで信頼性の高いクラウドベースのバックアップソリューション
- 効率的な増分バックアップ
- Recovery Servicesコンテナー
    - 既定はgeo冗長
- ファイル及びフォルダー、システム状態の保護
    - MARSエージェント
        - Windows OSを実行するコンピューターにAzure Backupのエージェントプログラムである
        - Azure Backup エージェント
    - オンプレミスや他のクラウド上で実行されるWindowsコンピューターでも使用
- 仮想マシンの保護
    - Azure上で実行されるWindowsまたはLinuxの仮想マシンを保護するシナリオ
    - 厳密には、仮想マシンのディスクであるVHDファイルをバックアップ
    - ファイル単位での回復もサポート
- ワークロードの保護
    - MABS
        - Microsoft Azure Backup Server
        - System Center Data Protection Managerをベース
    - Windowsコンピューターが実行する様々なワークロードデータを保護するシナリオ
    - 具体的には
        - Exchange Serverのメールボックス
        - SharePointのフォーム
        - SQL Server DB
        - Hyper-V VM
### Recovery Services コンテナー
- バックアップデータの格納先となるリソース
- Azure Backupを使用するため、最初に作成する
- 仮想マシンのバックアップを行う場合には、同じリージョンに作成する必要がある
- バックアップポリシー
    - バックアップ実行時刻や保持期間などの構成情報
    - 最大9999日保持
- バックアップの有効化後にRecovery Servicesコンテナーを削除するには、バックアップの停止とバックアップデータの完全な削除が必要
- 仮想マシンの復元オプション
    - 新しい仮想マシンを作成
    - ディスクを復元
        - 既存の仮想マシンまたは別途作成する新しい仮想マシン
    - 既存の仮想マシンのディスクを置換する
- ファイルレベルの回復
    - インターネットに接続され、なおかつバックアップ元の仮想マシンと同じOSまたは互換性のあるOSが動作するコンピューターで実行
## Azure Site Recovery
### 概要
- レプリケーションサービス
- あるリージョンのAzure仮想マシンを別のリージョンへ
    - Azure仮想マシンが存在しているリージョンとは異なるリージョンにRecovery Servicesコンテナーを作成する必要
- プライマリーリージョン内のAzure仮想マシンをセカンダリリージョンへ継続的にレプリケーション
- RTOとRPOが短い
- マルチVM生合成を有効にするとレプリケーショングループを構成できる
    - グループ内のすべての仮想マシンはまとめてレプリケーションされ、フェールオーバー時にクラッシュ整合性とアプリ生合成の生合成復旧ポイントを共有できる
    - レプリケーショングループ内の単一の仮想マシンをフェールオーバーすることができなくなり、復旧計画を使用したフェールオーバーが必要
- 再保護
    - レプリケーションの方向を反転
- フェールバック
    - プライマリリージョンでの実行に戻す
- 復旧計画
    - 複数の仮想マシンのフェールオーバーを確実に行うための機能
- レプリケーションポリシー
    - マルチVM整合性の有効化
- ターゲット設定のカスタマイズ
    - セカンダリリージョンで使用するリソースグループや仮想ネットワークなどを指定
# 監視
## Azure Monitor
### 概要
- Azureで監視をまとめて行う
- 監視データ
    - アプリケーション監視データ
    - ゲストOS監視データ
        - AMAのインストール
        - 拡張機能
            - Windows Azure Diagnostics
            - Linux Azure Diagnostics
    - Azureリソース監視データ
    - Azureサブスクリプション監視データ
    - Azureテナント監視データ
- メトリック
    - パフォーマンスデータ
- ログ
    - システム内で発生した操作や変化の記録
- アラート
    - 1つのアラートルールの条件内に複数のメトリックシグナルが指定されている場合は、すべての条件が満たされた場合にトリガーされる
    - アクティビティログは1つのみ指定
    - 同時指定は不可
- アクショングループ
    - レート制限
        - 電子メール
            - 1時間で100件以下
        - SMS
            - 5分間で1件以下
        - 音声
            - 5分間で1件以下
## Log Analytics
### 概要
- 高度な監視と分析のために使用可能なサービス
- Azure Monitor Log
- 最初に Log Analytics Workspaceを作成
## Network Wather
### 概要
- ネットワークの監視やトラブルシューティングのためのサービス
- Network Wather エージェント仮想マシン拡張機能
    - オンデマンドでの仮想マシンのネットワークトラフィックのキャプチャなど、高度な機能を使用可能
    - 機能
        - 接続モニター
        - パケットキャプチャ
        - 接続のトラブルシューティング
- 機能
    - 監視
        - トポロジ
            - 仮想ネットワーク内の全てのリソースや、仮想ネットワーク内のリソースに関連づけられたリソース、及びリソース間の関係性を視覚的に表示
        - 接続モニター
            - 指定されたソースとターゲットについて、エンドツーエンドの統合的な接続監視機能を提供
    - ネットワーク診断ツール
        - IPフロー検証
            - 仮想マシンから送受信されるパケットのプロトコルや方向、任意のIPアドレス、ポート番号を指定してNSGでの通信の可否をシュミレーションできる
            - NSGのトラブルシューティングに役立つ
        - NSG診断
            - IPフロー検証の詳細版
        - ネクストホップ
            - ルートテーブルの動作を確認
            - ルートテーブルの検証やトラブルシューティングに役立つ
        - VPNのトラブルシューティング
            - 診断結果の詳細は、ストレージアカウントに保存される
        - パケットキャプチャ
            - 仮想マシンで送受信されるパケットをキャプチャできる
        - 接続のトラブルシューティング
    - ログ
        - NSGフローログ
            - NSGを使用したIPトラフィックに関する情報をログに記録する機能
            - Microsoft.Insightsのリソースプロバイダーが登録されている必要がある
            - 指定したストレージアカウントにBLOBとして保存