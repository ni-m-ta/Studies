# ガバナンス
## Microsoft Entra ID
- Microsoftが提供するマルチテナントに多王したクラウドベースのディレクトリ及びID管理サービス
- アクセス先
    - 企業ネットワーク上にある内部リソースとアプリ
    - Microsoft365, Azure portal, SaaSアプリケーションなどの外部リソース
    - 組織向けに開発されたクラウドアプリ
- 機能
    - SSO
    - ユビキタスデバイス
        - iOS
        - macOS
        - Android
        - Windows
    - セキュリティ
        - MFA
        - 条件付きアクセスポリシー
        - グループベースのアクセス管理
    - クラウドへの拡張性
    - セルフサービスのサポート
- 概念
    - ID
        - 認証できるオブジェクト
    - アカウント
        - データが関連づけられているID
    - Microsoft Entra アカウント
        - Microsoft Entra ID, または別のMSクラウドサービスを通じて作成されるID
        - 職場アカウントまたは学校アカウント
    - Azure テナント
        - Microsoft Entra IDの専用の信頼された単一のインスタンス
        - 各テナントは一組織
        - 組織がMicrosoftクラウドサービスサブスクリプションにサインアップすると新しいテナントが自動的に作成される
        - 複数テナント作成可能
    - Azure サブスクリプション
        - Azureクラウドサービスの料金を支払うために使用
        - 各サブスクリプションは1つのテナントに結び付けられている
    - AD DS
        - Active Directory Domain Services
        - 物理または仮想サーバーへのWindows ServerベースのActive Directoryの従来のデプロイ
- 特徴
    - IDソリューション
    - 通信プロトコル
        - HTTP及びHTTPS
        - 認証方法
            - SAML
            - WS-Federation
            - OpenID Connect
            - OAuth
    - フェデレーションサービス
    - フラット構造
    - マネージドサービス
        - ユーザー、グループ、ポリシーのみを管理
- エディション
    - <img src="imgs/edition.png">
- セルフパスワードリセット
    - ヘルプデスクをバイパスして独自のパスワードをリセット

## ユーザーアカウントとグループアカウント
- クラウドID
    - Microsoft Entra IDでのみ定義
    - Microsoft Entra組織で定義されているユーザーアカウント、および外部のMicrosoft Entraインスタンスで定義されているユーザーアカウントに対しても使用可能
    - プライマリディレクトリから削除されるとそのユーザーアカウントは削除される
    - 表示名とユーザーアカウント名が必要
    - 復元オプション
        - アカウント削除後30日以内
    - ユーザーアカウントのサインインと監査ログ情報を収集
    - 一括操作
        - ユーザーアカウントを作成および削除する権限を持つのは、グローバル管理者またはユーザー管理者
        - 管理者はユーザーアカウントのデータのCSVテンプレートを入力
        - 一括操作テンプレートはMicrosoft Entra管理センターからダウンロード
- ディレクトリ同期ID
    - オンプレミスのActive Directoryで定義
    - Microsoft Entra Connect を開始て実行される同期アクティビティによりAzureに提供
    - Windows Servier Active Directory
- ゲストユーザー
    - Azureの外部で定義
    - 招待されたユーザー
- セキュリティグループ
    - ユーザーグループの共有リソースへのメンバーとコンピューターのアクセスを管理するために使用
    - Microsoft Entra管理者のみが実装
- Microsoft 365グループ
    - 共同作業の機会を提供
    - 共有メールボックス、カレンダー、ファイル、SharePointなどへのアクセス権
    - Microsoft Entra組織外のゲストユーザーのグループアクセスを有効
    - 通常のユーザーとMicrosoft Entra管理者は使用可能
- 割り当て済み
    - グループの面として特定のユーザーを追加
- 動的ユーザー
    - 動的メンバーシップルールを使用して、グループメンバーを自動的に追加および削除できる
    - メンバーの属性が変わるとAzureによってディレクトリの動的グループルールが確認される
    - メンバー属性がルールの要件を満たしている場合、そのメンバーはグループに追加
    - メンバー属性がルールの要件を満たさなくなった場合、そのメンバーは削除
- 動的デバイス
    - 動的グループルールを適用して、セキュリティグループ内のデバイスを自動的に追加および削除する
    - デバイス属性がルールの要件を満たしている場合、そのデバイスは追加
    - デバイス属性がルールの要件を満たさなくなった場合、そのデバイスは削除
## サブスクリプション
- リージョン
    - 140カ国60を超えるリージョンで一般提供
    - リージョンペア
        - 同じ地域内の別のリージョンとペア
        - Always On可用性をサポート
        - 物理的分離
        - レプリケーション
        - リージョン復旧順序
        - 計画的なAzureシステムの更新は、ペアになっているリージョンに順次ロールアウト
        - データの保存場所
            - リージョンは有効セットとして同じ地域内に存在
            - ブラジル南部およびシンガポールリージョンを除く
- サブスクリプション
    - 全てのリソースはサブスクリプションに属する
    - サブスクリプションごとに異なる請求および支払い構成を設定
    - 複数のサブスクリプションを同じAzureアカウントにリンクできる
    - Azureサービスの課金はサブスクリプションごとに行われる
    - 調達
        - エンタープライズ契約
            - Azureへの前払い年額コミットメントの契約により、Azureを追加
        - Microsoft リセラー
            - オープンプランのライセンスプログラムを通じて購入
        - Microsoft パートナー
        - 個人用無料アカウント
    - Microsoft Cost Management
        - 高度な分析によって組織のコストや使用パターンが示される
    - リソースタグ
        - 定義済みの値のセットから選択することも、特定のリソースインスタンスに対して一位にすることも可能
        - 最大50このペア
        - リソースによって継承されないものもある
    - コスト削減
        - Reservation
            - 1,3年分の前払い
        - Azureハイブリッド特典
        - Azure クレジット
        - Azureリージョン
        - 予算
        - 料金計算ツール
## Azureポリシー
- 管理グループ
    - ルート管理グループ
    - 既定では新しいサブスクリプションは全て、最上位レベルの管理グループ、ルート管理グループの下に配置
    - 管理グループ内の全てのサブスクリプションは、管理グループに適用された条件を自動的に継承
    - 管理グループツリーの深さは最大6
    - Azureのロールベースのアクセス制御の認可は、管理グループの操作に対しては既定では有効にならない
- Azure Policy
    - 規則のコンプライアンスの適用
        - 組み込みポリシーを有効にするか、全ての種類のリソースに対してカスタムポリシーを作成
        - リアルタイムなポリシーの評価と適用、および定期的またはオンデマンドのコンプライアンス評価をサポート
    - ポリシーの大規模な適用
        - 組織全体を制御する管理グループにポリシーを適用する
        - 複数のポリシーを適用し、ポリシーイニシアティブを使用してポリシーの状態を集約
        - 除外範囲を定義
    - 修復の実行
        - リアルタイムの修復、および既存のリソースの修復を実行
    - ガバナンスの実行
    - ポリシー定義
        - リソースのコンプライアンス条件と条件が満たされたときに完了するアクションを記述
    - イニシアチブ定義
        - ポリシーのスコープを制御し、リソースのコンプライアンスを評価するために、1つ以上のポリシー定義がグループ化される
    - 実装
        1. ポリシー定義を作成
        1. イニシアチブ定義を作成
        1. イニシアチブ定義のスコープを指定
            - サブスクリプションを指定
            - オプションでリソースグループを選択
        1. コンプライアンスを決定
            - 対応
            - 準拠していない
## ロールベースのアクセス制御の構成
- RBAC
    - Azureリソースにアクセスできるユーザーを管理するのに役立つメカニズム
    - セキュリティプリンシパル
        - リソースへのアクセスを要求しているものを表す
    - ロールの定義
        - 許可された操作を一覧表示するアクセス許可のセット
        - アクセス許可セット
            - Actions アクセス許可
                - 許可されるアクション
            - NotActions アクセス許可
                - 許可されないアクション
            - DataActions アクセス許可
                - データを変更または使用する方法
            - AssinableScopes アクセス許可
                - ロール定義を割り当てることができるスコープが一覧表示
                - 管理グループ、サブスクリプション、リソースグループ、リソースを指定
    - スコープ
        - 要求されたアクセスレベルの境界
        - `/`
            - 全ての要求元に対して割り当て用のロールのスコープを使用可能
    - ロールの割り当て
        - 特定のスコープでセキュリティプリンシパルにロール定義をアタッチする
    - カスタムロールとアクセス許可を作成可能
    - Actionsアクセス許可からNotActionsアクセス許可を引いて、ロールの有効なアクセス許可を決定
- アクセス管理
    - 従来のサブスクリプション管理者ロール
    - Azureロールベースアクセス制御ロール
        - Azureリソースへのアクセス管理
        - 管理グループ、サブスクリプション、リソースグループ、リソースなど
        - Azure portal, Azure CLI, Azure PowerShell, Azure Resource Manager テンプレート, REST API
        - 例
            - グローバル管理者
            - ユーザーアクセス管理者
    - Microsoft Entra 管理者ロール
        - Microsoft Entraリソースへのアクセス管理
        - テナントレベルで指定
        - Azure管理ポータル、Microsoft356管理ポータル、Microsoft Graph Powershellを使用
        - 例
            - 全体管理者
            - アプリケーション管理者
            - アプリケーション開発者
            - 課金管理者
- RBAC
    - 所有者
        - 他のユーザーにアクセス許可を委任する権限も含め、全てのリソースへのフルアクセス権を持つ
        - サービス管理者と共同管理者のロールには、サブスクリプションスコープで所有者ロールが割り当てられる
    - Contributor
        - 全ての種類のAzureリソースを作成および管理できる
        - 他のユーザーにアクセス権を付与できない
    - Reader
        - 既存のAzureリソースを表示
    - User Access Administorator
        - Azureリソースへのユーザーアクセスを管理
# 実装
## ツールを使用してAzureリソースを構成
- Azure Cloud Shell
    - Azureリソースを管理するためのブラウザーでアクセスできるインタラクティブなシェル
    - BashとPowerShellを選べる
    - 一時的に、新規または既存のAzureFiles共有をマウントする必要がある
- Azure PowerShell
    - Windows PowerShellまたはPowerShell Coreに追加するモジュールで、自身のAzureサブスクリプションに接続してリソースを管理
    - Azモジュール
        - Azure機能で使用できるコマンドレットを含むAzure PowerShellコマンドレットの正式名称
- Azure CLI
    - Azureリソースで管理コマンドを実行するためのコマンドラインプログラム
- Azure Resource Manager
    - Azure PowerShell, Azure CLI, Azure portal, REST APIを通じてタスクを実行する一貫性のある管理レイヤーが提供
    - 宣言構文を使用してデプロイ
    - リソースプロバイダー
        - Resource Managerを使用してデプロイおよび管理できるリソースを提供するサービス
    - ロック
        - サブスクリプション、リソースグループ、リソースに関連づけ
        - 子リソースに継承
        - 読み取り専用ロック
        - 削除ロック
        - 管理ロックを作成または削除できるのは、所有者とユーザーアクセス管理者のロールのみ
    - Azureリソースを再構成
        - リソースを新しいサブスクリプションまたは同じサブスクリプションないの新しいリソースグループに移動することは可能
        - 移動中、両方のグループがロックされる
    - リソース制限
        - 既定の制限を増加させる必要がある場合は、引き上げを依頼する
        - 上限に達している場合は、制限を引き上げられない
- ARM テンプレート
    - $schema
        - テンプレートの言語のバージョン
    - contentVersion
        - 任意の数値
    - parameters
        - リソースのデプロイをカスタマイズするための値
        - 例
            - adminUsername
            - adminPassword
    - variables
        - テンプレート言語式を簡略化するためにテンプレート内でJSONフラグメントとして使用される値
    - functions
        - テンプレート内で使用できるユーザー定義関数
    - outputs
        - デプロイ後に返される値
    - 同じテンプレートが2回実行された場合、リソースがすでに存在しかつプロパティに変更が検出されない場合、アクションは実行されない
- Azure Bicep テンプレート
    - 宣言方の構文を使用してAzureリソースをデプロイするドメイン固有言語
    - BicepはARMテンプレートJSONに対する透過的な抽象化
- クイックスタートテンプレート
    - azuredeploy.json
        - デプロイされるリソースを定義
    - azuredeploy.parameters.json
        - テンプレートに必要な値を提供
# ネットワーク
## 仮想ネットワーク
- Azureクラウドリソースを論理的に分離したもの
- 仮想プライベートネットワークをプロビジョニングおよび管理できる
- 各仮想ネットワークには独自のCIDRブロックがあり、他の仮想ネットワークやオンプレミスネットワークにリンクできる
- 接続しているネットワークのCIDRブロックが重複しない場合は、仮想ネットワークとオンプレミスのITインフラストラクチャをリンクして、ハイブリッドまたはクロスプレミスのソリューションを提供
- サブネット
    - 各サブネットには仮想ネットワークアドレス空間に収まるIPアドレス範囲が含まれる
    - サブネットのアドレスの範囲は、仮想ネットワークのアドレス空間内で一意
    - 1つのサブネットの範囲が同じ仮想ネットワークないの他のサブネットのIPアドレスと重複しない
    - サブネットのIPアドレス空間はCIDR表記を使う
    - 予約されるアドレス
        - xxx....0
            - 仮想ネットワークアドレス
        - xxx....1
            - 既定のゲートウェイ
        - xxx....2,xxx....3
            - Azure DNS IPアドレスは、Azureにより仮想ネットワーク空間にマップ
        - xxx....255
            - 仮想ネットワークのブロードキャストアドレス
- ネットワーク仮想アプライアンス
    - 既定ではネットワークトラフィックは仮想ネットワークないの全てのサブネット間でルーティングされる
    - 既定の設定をオーバーライドして、サブネット間のトラフィックをネットワーク仮想アプライアンス経由でルーティングする
- サービスエンドポイント
    - 仮想ネットワークサービスエンドポイントのある特定のサブネットに制限
- プライベートリンク
    - 仮想ネットワークから他のサービスへのプライベート接続が可能
    - ネットワークアーキテクチャが簡素化され、Azureないのエンドポイント間の接続がセキュリティで保護
- プライベートIPアドレス
    - Azure仮想ネットワーク内とオンプレミスネットワーク内での通信を可能にする
- パブリックIPアドレス
    - インターネットと通信
    - Basic SKUのIPv6のみ動的
    - 動的IPアドレスが更新されるのは、Azure内で仮想マシンが停止してから再起動された時
## ネットワークセキュリティグループ
- 仮想ネットワーク内のリソースへのネットワークトラフィックを制限
- サブネットまたはネットワークインターフェイスに割り当て
- 各サブネットにはネットワークセキュリティグループを最大1つ関連付ける
- 既定の規則
    - DenyAllInbound
    - AllowVnetInBound
    - AllowAzureLoadBalancerInBound
    - AllowInternetOutbound
    - AllowVnetOutBound
    - DenyAllOutBound
- フィルター
    - 送信元
    - 送信先
    - サービス
    - 優先度
- アプリケーションセキュリティグループ
    - 仮想マシンをワークロード別に論理的にグループ化する
    - その後アプリケーションセキュリティグループに基づいてネットワークセキュリティグループの規則を定義
## Azure DNS
- DNSドメインをホストし、Microsoft Azureインフラストラクチャを使用してドメインの名前解決にアクセス
- Azureサブスクリプションを作成すると、AzureによってサブスクリプションのMicrosoft Entraドメインが自動的に作成
- ドメイン管理タスクを実行するには、グローバル管理者である必要がある
- グローバル管理者は、サブスクリプションを作成したユーザー
- 初期ドメイン名
    - xxxxx.onmicrosoft.com
- カスタムドメイン名をMicrosoft Entra IDで使用できるようにするには、事前にカスタムドメイン名をディレクトリに追加して確認する
- 初期ドメイン名は変更または削除できないが、制御するルーティング可能なカスタムドメイン名を追加できる
- Microsoft Entra IDではドメイン名はグローバルに一意である
- カスタムドメイン名の有効性を検証する方法
    - Microsoft Entraインスタンスにカスタムドメイン名を追加
    - カスタムドメイン名のDNSレコードを追加
        - MS: ドメインのメールを受け取るメール交換サーバーが一覧表示
        - TXT: データ
    - レコード追加後、AzuredeはDNSレコードの存在がDNSドメインに照会される
- リソースグループ内ではDNSゾーンの名前は一意にする
- 複数のDNSゾーンで同じ名前を共有する時、各DNSゾーンインスタンスは異なるDNSネームサーバーアドレスに割り当てられる
- ルート及び親ドメインはレジストラーに登録され、その後AzureDNSを指す
- 子ドメインはAzure DNSに直接登録
- ドメインをAzureDNSに委任するには、DNSゾーンのDNSネームサーバーを識別する
- DNSゾーンが作成されるたびに、AzureDNSによってプールからDNSネームサーバーが割り当てられる
- DNSネームサーバーが割り当てられた後、AzureDNSによってDNSゾーンに権限のあるNSレコードが自動的に作成される
- DNSドメイン委任方法
    - DNSネームサーバーを識別する
        - overviewを確認
    - 親ドメインを更新
        - レジストラーのDNS管理ページに移動
        - 親ドメインの既存のNSレコードを検索
        - 既存のNSレコードをAzure DNSによってドメイン用に作成されたNSレコードに置き換え
- サブドメインを委任
    - Azure Portalでドメインの親DNSゾーンに移動
    - 親ドメインの既存のNSレコードを検索
    - 子DNSゾーンの新しいNSレコードを作成
- 親と子のDNSゾーンは、同じまたは異なるリソースグループ内に含められる
- DNSレコードセット
    - DNSゾーン内のレコードのコレクション
    - DNSレコードセット内のすべてのレコードは、名前とレコードの種類が同じ
    - CNAME型のレコードセットに含めることができるレコードは1つ
    - 空のレコードセットを作成可能だが、Azure DNS ネームサーバーに表示されない
- Azure プライベートDNSゾーン
    - Azureによって提供される名前ではなく、独自のカスタムドメイン名を使って作成できる
    - 独自のカスタムドメイン名を使うと、最適な仮想ネットワークのアーキテクチャを調整
    - 仮想ネットワーク内および仮想ネットワーク間で、仮想マシンの名前が解決
    - スプリットホライズンビューでDNSゾーン名を構成でき、プライベートとパブリックのDNSゾーンで同じドメイン名を共有できる
    - すべてのAzureリージョンで利用できる
    - AzureプライベートDNSゾーンアドレスが、仮想ネットワークにリンクされると、リンク構成で自動登録が有効になっている場合、Azure DNSによってDNSゾーンに2つのAレコードが自動的に作成される
## Azure Virtual Network Peering
- 2つの仮想ネットワーク間をシームレスに接続
- 2種類
    - リージョン仮想ネットワークピアリング
        - 同じリージョンに存在するAzure仮想ネットワークを接続
        - 同じAzure パブリッククラウドリージョン内
        - 同じChinaクラウドリージョン内
        - 同じMicrosoft Azure Governmentクラウドリージョン内
    - グローバル仮想ネットワークピアリング
        - 異なるリージョンに存在するAzure仮想ネットワークを接続
        - 任意のAzureパブリッククラウドリージョン
        - 任意のChinaクラウドリージョン内
- 仮想ネットワークにはVPNゲートウェイを1つだけ作成可能
- ゲートウェイ転送はリージョンとグローバルの両方の仮想ネットワークピアリングでサポート
    - VPNゲートウェイ転送を許可すると、仮想ネットワークはピアリングの外部にあるリソースと通信できる
        - サイト間VPNを使用して、オンプレミスネットワークに接続
        - 別の仮想ネットワークへのVNet間接続を使用
        - ポイント対サイトVPNを使用して、クライアントに接続
    - VPNゲートウェイをデプロイする必要はない
- 仮想ネットワークピアリングを実装するには、Network Contributor or Classic Network Contributorが必要
- ピアリング内の両方の仮想ネットワークの状態が接続済みになるまで、ピアリングは正常に確立しない
- ピアリングの拡張
    - ハブとスポークのネットワーク
    - ユーザー定義のルート
    - サービスチェーン
## システムルート
- 仮想マシン、オンプレミスネットワーク、インターネット間でネットワークトラフィックを転送
- システムルートに関する情報はルートテーブルに記録
- 下記シナリオで仮想マシンのトラフィックを制御
    - 同じサブネット内の仮想マシン間のトラフィック
    - 同じ仮想ネットワークでの異なるサブネット内の仮想マシン間のトラフィック
    - 仮想マシンからインターネットへのトラフィック
- ルートテーブルにはテーブルがサブネットに関連づけられているシステムルートに関する情報が記録
- サブネットから離れる各パケットは、関連付けするルートテーブルに基づいて処理される
- パケットは送信先を使用してルートと照合される
- 一致するルートが見つからない場合、そのパケットは破棄される
- ユーザー定義ルート
    - トラフィックフローのネクストホップを指定するルートを定義することで、ネットワークトラフィックを制御
    - ネクストホップ
        - 仮想ネットワークゲートウェイ
        - 仮想ネットワーク
        - インターネット
        - ネットワーク仮想アプライアンス
    - システムルートと同様にUDRもルートテーブルにアクセス
    - 各ルートテーブルは複数のサブネットに関連づけ
    - 各サブネットは1つのルートテーブルにのみ関連付け
- サービスエンドポイント
    - 仮想ネットワークのIDをAzureリソースに提供。仮想ネットワークでサービスエンドポイントが有効になったら、Azureサービスリソースに仮想ネットワーク規則を追加することで、このリソースを仮想ネットワークにおいて保護
    - 元々仮想ネットワークからAzureサービストラフィックでは、パブリックIPアドレスを発信元IPアドレスとして使用
    - サービスエンドポイントを使用すると、仮想ネットワークのプライベートIPアドレスを発信元IPアドレスとして使用
- Azure Private Link
    - 仮想ネットワークからAzureのPaaS、顧客のリソース、Microsoft Partnerの各サービスへのプライベート接続が可能
    - リージョンに関する制限はない
## Azure Load balancer
- 負荷分散を離床し、受信したネットワークトラフィックをバックエンドサーバーとリソースの間で効率的に分散
- 受信と送信のシナリオに使用
- パブリックまたは内部
- 構成要素
    - フロントエンドのIP構成
        - ロードバランサーで応答するパブリックIPまたは内部IPを指定
    - バックエンドプール
        - Azure Virtual MachinesやAzure Virtual Machine Scale Setsのインスタンスなど、サービスとリソース
    - 正常性プローブ
        - バックエンド内のリソースが正常であることを確認
    - 負荷分散規則
        - ロードバランサーは無数のTCPおよびUDPアプリケーションにスケール
- SKU
    - Standard
        - HTTPS,HTTP,TCP
        - 受信トラフィックと送信トラフィック用のゾーン冗長およびゾーンフロントエンドへ可用性ゾーン使用可能
        - 受信および送信
        - NSGで許可されている場合を除き、受信フローは閉じられる
        - 仮想ネットワークから内部ロードバランサーへの内部トラフィックは許可
        - 最大1000台
        - 1つの仮想ネットワークで仮想マシンまたはVirtual Machine Scale Setsを選択
    - Basic
        - HTTP,TCP
        - 受信のみ
        - 既定で開かれる、NSGによる制御
        - 最大300台
        - 可用性セットかAzure Virtual Machine Scale Sets
    - Gateway 
        - サードパーティ性のNVAが含まれるハイパフォーマンスと高可用性のシナリオがサポート
- バックエンドプール
    - 各ロードバランサーにはトラフィックの分散に使用されるバックエンドプールが1つ以上与えられる
    - ロードバランサーに接続されている仮想NICのIPアドレスが含まれる
- 正常性プローブ
    - ロードバランサーでアプリケーションの状態を監視
    - プローブで応答できない場合、ロードバランサーは以上なインスタンスへの新しい接続の送信を停止
    - HTTPプローブ
        - バックエンドプールエンドポイントが15秒毎調査
        - 指定のタイムアウト期間内に仮想マシンインスタンスがHTTP200で応答した場合はそのインスタンスは正常な状態にあるとする。以外は異常とする
    - TCPプローブ
        - 定義されたプローブポートにTCPセッションを確立できるかに依存。仮想マシン上に指定されたリスナーが存在すれば成功。接続が拒否されるとプローブは失敗
    - 構成
        - ポート
        - URI
        - 間隔
        - 異常閾値
    - ゲストエージェントプローブ
- 負荷分散規則
    - 構成するためにロードバランサーのフロントエンド、バックエンド、正常性プローブが必要
    - 構成
        - IPのバージョン
        - フロントエンドIPアドレス、ポート、プロトコル
        - バックエンドプールとバックエンドポート
        - 正常性プローブ
        - セッション永続化
    - 既定では、ネットワークトラフィックを複数の仮想マシンに均等に分散
        - 5タプルハッシュ
            - 送信元IPアドレス
            - 送信元ポート
            - 送信先IPアドレス
            - 送信先ポート
            - プロトコル
    - セッションの永続化
        - なし
            - 任意の仮想マシンが要求を処理
        - クライアントIP
            - 同じクライアントIPアドレスから連続する要求は、同じ仮想マシンに転送
        - クライアントIPとプロトコル
            - クライアントIPアドレスとプロトコルの同じ組み合わせからの連続する要求は同じ仮想マシンに転送
    - 負荷分散規則は、NAT規則と組み合わせて使用可能
## Azure Application Gateway
- クライアントアプリケーションからそのWebアプリへの要求を管理
- Webアプリへの受信トラフィックをリッスンし、HTTPなどのプロトコルを介して送信されたメッセージをチェック
- アプリケーション層のルーティング
    - 要求のURLに基づいてWebサーバのバックエンドプールにトラフィックを転送
    - Azure仮想マシン、Azure Virtual Machine Scale Sets, Azure App Service, オンプレミスのサーバ
- ラウンドロビンの負荷分散
- セッションの持続性
- サポートされるプロトコル
    - HTTP, HTTPS, HTTP/2, WebSocket
- ファイアウォール
- 暗号化
- 負荷の自動スケーリング
- トラフィックルーティング
    - パスベースのルーティング
        - 異なるURLパスの要求を異なるバックエンドサーバのプールに送信
    - マルチサイトのルーティング
        - 同じアプリケーションゲートウェイのインスタンス上に複数のWebアプリケーションを構成
- トラフィックをリダイレクト
- HTTPヘッダーを書き換えられる
- 既定のエラーページを表示する代わりに、カスタムエラーページを作成できる
- 構成要素
    - フロントエンドIPアドレス
        - クライアント要求を受信
        - パブリックまたはプライベートIPアドレス
    - Webアプリケーションファイアウォール
        - 要求がリスナーに到達する前に一般的な脅威について受信トラフィックをチェック
    - 1つ以上のリスナーがトラフィックを受信し、要求をバックエンドプールにルーティング
    - ルーティング規則
        - 要求を分析し、要求を適切なバックエンドプールに転送
    - バックエンドプール
        - 仮想マシンやVirtual Machine Scale Setsなどのリソース用のWebサーバを含む
    - 正常性プローブ
        - 200~399を正常とする
# ストレージ
## Storage Account
- データオブジェクト用の高度にスケーラブルなオブジェクトストア
- クラウドのためのファイルシステムサービス、信頼性の高いメッセージングのためのメッセージングストア、およびNoSQLストア
- 仮想マシンデータ
    - ディスク
        - Azure IaaS仮想マシン用の永続的ブロックストレージ
    - ファイル
        - クラウド内のフルマネージドファイル共有
- 非構造化データ
    - Azure Blob Storage
        - 拡張性の高いRESTベースのクラウドオブジェクトストア
    - Azure Data Lake Storage
        - サービスとしてのHadoop分散ファイルシステム
- 構造化データ
    - Azure Table Storage
    - Azure Cosmos DB
        - グローバル分散型データベースサービス
    - Azure SQL Database
        - SQLを基盤とするサービスとしてのフルマネージドデータベース
- SKU
    - Standard
        - 磁気ハードディスクを基盤
        - Standard 汎用v2
            - Blob, FIles, Queue, Table
    - Premium
        - ソリッドステートドライブを基盤
        - Premium ブロックBLOB
            - BLOB
            - ブロックBLOBと追加BLOB向けのアカウント
            - 高トランザクションレートのアプリケーションに推奨
        - Premium ファイル共有
            - Files
            - EAまたはハイパフォーマンススケールアプリケーション
            - SMBとNFSファイル共有の両方をサポート
        - Premium ページBLOB
            - BLOB
            - OS, 仮想マシン用のデータディスク、データベースのようなインデックスベースのスパースデータ構造格納
- Azure Blob Storage
    - Microsoftのクラウド用オブジェクトストレージソリューション
    - 画像,ビデオ、オーディオ、ドキュメントなどを格納
    - HTTP, HTTPS経由でアクセス
- Azure Files
    - 可用性の高いネットワークファイル共有
    - SMBプロトコルとNFSプロトコルを使ってアクセス
- Azure Queue Storage
    - メッセージの格納と取得
- Azure Table Storage
    - 非リレーショナル構造化データをクラウド内に格納
- すべてのストレージアカウントは保存データ用のStorage Service Encryptionを使用して暗号化
- レプリケーション
    - LRS
        - データ損失が発生した場合に簡単に再構築できるデータがアプリケーションで格納
    - ZRS
        - 単一のリージョン内の3つのストレージクラスターに渡ってデータが同期的にレプリケートされる
        - 各ストレージクラスターは、他のクラスターから物理的に分離されていて、独自の可用性ゾーン内に置かれている
        - 一部リージョンで利用不可
        - 別のオプションから変更するには、1つのストレージスタンプから、リージョン内の複数のスタンプへの物理的なデータ移動が必要
    - GRS
        - セカンダリリージョンにデータがレプリケート
        - 16,9
        - セカンダリリージョン内の別のデータセンターにデータをレプリケート
        - そのデータを読み取れるのはMicrosoftがプライマリリージョンからセカンダリリージョンへのフェールオーバーを開始した場合だけ
        - RA-GRS
            - セカンダリリージョンから読み取り可能
        - セカンダリリージョンへは非同期でレプリケートされる
        - 障害ドメインとアップグレードドメイン間でレプリカを管理
    - GZRS
        - プライマリリージョンの3つのAzure可用性ゾーン間でレプリケートされ、セカンダリリージョンにもレプリケートされる
        - 同じgeo内の別リージョンと組み合わせてリージョンペアにして使用
        - RA-GZRS
- ストレージへのアクセス
    - Blob
        - `//{StorageAccountName}.blob.core.windows.net`
    - Table
        - `//{StorageAccountName}.table.core.windows.net`
    - Queue
        - `//{StorageAccountName}.queue.core.windows.net`
    - Files
        - `//{StorageAccountName}.files.core.windows.net`
    - カスタムドメイン
        - 直接マッピング
            - サブドメイン用のカスタムドメインをAzure Storage Accountに対して有効
            - サブドメインからAzure Storage AccountをポイントするCNAMEレコードを作成
        - 中間ドメインマッピング
            - Azure内ですでに使用中のドメインに適用
            - asverify中間ドメインを使用
- ストレージエンドポイントをセキュリティで保護
    - ファイアウォールと仮想ネットワークの設定で、仮想ネットワークまたはパブリックIP上の特定のサブネットからのストレージアカウントへのアクセスを制限する
    - 1つ以上のパブリックIP範囲へのアクセスを許可するようにサービスを構成
    - サブネットと仮想ネットワークはストレージアカウントと同じAzureリージョンまたはリージョンペアに存在する必要がある
- ストレージアカウント名はAPIアクセス用のURIの一部として使用されるためグローバルに一意
## Azure Blob Storage
- 大量の日構造化オブジェクトデータを格納するサービス
- 任意の種類のテキストまたはバイナリデータを格納
- すべてのBLOBは1つのコンテナーに存在する必要がある
- コンテナーにはBLOBを無制限に格納できる
- 1つのAzureストレージアカウントに含めることができるコンテナの数は無制限
- `New-AzStorageContainer`で作成可能
- アクセス層
    - ホット層
        - 頻繁に読み書きするために最適化
    - クール層
        - 30日以上クールそうに保存されるデータを対象
    - コールド層
        - 90日以上保存されるデータ
    - アーカイブ層
        - 数時間の取得待機時間を許容できるデータのために最適化されたオフライン層
        - 180日間アーカイブそうに保持
- オブジェクトレプリケーション
    - ユーザーが構成したポリシールールに従って、コンテナ内のBLOBを非同期にコピーする
    - ソースアカウントと宛先アカウントの両方でBLOBのバージョン管理が有効になっている必要がある
    - コピー元とコピー先のアカウントがほっと、クール、またはコールド層にある場合にサポート
- BLOBの種類
    - ブロックBLOB
        - データのブロックで構成され、それらを組み立ててBLOBを構成
        - 画像などのテキストデータやバイナリデータ
    - 追加BLOB
        - 追加操作用に最適化
    - ページBLOB
        - 読み取りおよび書き込み操作を頻繁に続行する場合により効率的
- アップロードツール
    - Azure Storage Explorer
    - AzCopy
        - WindowsとLinux用の使いやすいコマンドラインツール
    - Azure Data Box Disk
        - オンプレミスのデータをBlob Storageに転送するサービス
    - Azure Import/Export
        - ストレージアカウントにある大量のデータをハードドライブにエクスポートするのに役立つ
## セキュリティ
- 暗号化
- 認証
    - Microsoft Entra IDとロールベースのアクセス制御は、Azure Storageのリソース管理操作とデータ操作の両方でサポート
- 転送中のデータ
    - アプリケーションとAzureの間で送信されるデータを、クライアント側暗号化、HTTPS, またはSMB3.0使用して保護
- ディスクの暗号化
    - Azure Virtual Machinesに使われるOSとデータディスクはAzure Disk Encryptionを使って暗号化
- Share Access Signature
    - 委任アクセスを許可
- 承認
- セキュリティ戦略
    - Microsoft Entra ID
        - クラウドベースのIDおよびアクセス管理サービス
    - 共有キー
        - Azure Storageアカウントのアクセスキーとその他のパラメータを利用し、暗号化された署名文字列を生成
    - 共有アクセス署名
        - Azure Storageアカウント内の特定のリソースへのアクセスが指定したアクセス許可で指定した期間だけ委任される
        - SASを所有しているクライアントに付与するアクセスの種類をきめ細かく制御
        - 複数のサービスへのアクセスを委任
        - 有効期間
        - アカウントレベルでは1つ以上のサービス内のリソースへのアクセスが委任
        - サービスレベルでは1つだけのサービス内のリソースへのアクセスが委任
    - 暗号化
        - データはAzure Managed Disks, Azure Blob Storage, Azure Queue Storage, Azure Cosmos DB, Azure Table Storage, Azure Filesに永続化される前に自動的に暗号化
        - 取得前に自動的に暗号化が解除
        - 暗号化、保存時の暗号化、解読、キー管理はユーザーに対して投下的に行われる
        - AES暗号化によって暗号化
        - 無効にできない
    - カスタムマネージドキー
        - アクセス制御の作成、無効化、監査、ローテーション、定義を行える
        - Azure Storage Accountとキーコンテナは同じリージョンに存在していることが必要
## Azure Files
- 業界標準のSMBおよびNFSプロトコルを使用して、アプリケーションのための共有ストレージを提供
- データを本来のディレクトリオブジェクトとしてファイル共有に格納
- 複数のVMにまたがるファイルへの共有アクセスを提供
- SKU
    - Standard
        - HDD
        - SMB, REST
    - Premium
        - SSD
        - SMB, NFS, REST
- File Sync
    - ポート445を開く
    - 安全な転送を有効にする
    - Windowsにマウント
        - 共有をマウントするドライブを指定し、認証方法を選ぶ
    - Linux
        - CIFSカーネルクライアントを使うことでLinuxディストレイビューションにマウント
- ファイル共有スナップショット
    - File Sync レベルで提供
    - 特定時点のデータ読み取り専用コピー
- 論理的な削除
    - 保持期間を指定できる(1年以内)
    - NFSでは機能しない
- Azure Storage Explorer
    - ストレージデータの操作を容易にするスタンドアロンアプリケーション
- クラウドの階層化
    - Azure File Syncのオプション機能
    - 頻繁にアクセスされるファイルがサーバ上でローカルにキャッシュされるのに対して、その他のファイルはすべてポリシー設定に基づいてAzure Filesに改装かsれる
    - アクセス頻度の低いファイルは作成したポリシーに従ってAzureファイル共有に階層化またはアーカイブ化される

# リソース
## VM
- インターネット経由でプロビジョニングと管理を行う
- 価格
    - 従量課金
        - コンピューティング容量に対して秒単位で支払う
    - RI
        - RIオプションは特定のリージョンで仮想マシンを1年間または3年間分予約購入する
- サイズ
    - 汎用
        - バランスの取れたCPU対メモリ比を提供
    - コンピューティング最適化
        - 高いCPU対メモリ比
        - NVA
        - バッチ処理
        - アプリケーションサーバ
    - メモリ最適化
        - 高いメモリ対CPU比
        - RDB
    - ストレージ最適化
        - 高いディスクスループットとIO
        - ビックデータ
    - GPU
        - 負荷の高いグラフィックスのレンダリングやビデオ編集に特化
    - ハイパフォーマンスコンピューティング
        - 最も高速で最も強力なCPU
- ストレージ
    - VHDとして格納
    - OSディスク
        - 仮想マシンの作成時に選択されたOSがインストール
    - 一時ディスク
        - メンテナンスイベント中または仮想マシンの再デプロイ時に失われる可能性
        - Windows
            - D:
        - Linux
            - /dev/sdb
    - データディスク
        - VMに取り付けられるマネージドディスクであり、ユーザーが保存しておく必要があるアプリケーションなどのデータを格納する
- Azure Bastion
    - PaaS
    - SSL経由で直接、仮想マシンへの安全かつシームレスなRDPまたはSSH接続が提供
    - パブリックIPアドレスは必要ない
## 可用性
- メンテナンス計画
    - 計画外のハードウェアメンテナンス
        - ライブマイグレーションテクノロジを使って、障害が発生したハードウェアから正常な物理マシンに仮想マシンを移行
        - 仮想マシンを短時間だけ一時停止する仮想マシン維持操作
    - 予期しないダウンタイム
        - ローカルネットワーク障害、ローカルディスク障害
        - 同じデータセンター内の正常な物理マシンに自動的に移行
        - 復旧中に仮想マシンでダウンタイムが発生し、場合によっては一時ドライブが失われる
    - 計画メンテナンス
        - パフォーマンスやセキュリティを向上させるために元になるAzureプラットフォームに対して、MSが行う定期的な更新
- 可用性セット
    - 関連する仮想マシンのグループが一緒にデプロイされるようにするために使用できる論理機能
    - 同じ機能セットを実行する必要がある
    - 同じソフトウェアがインストールされている必要がある
    - アプリケーションは稼働状態を維持し、利用可能
    - 可用性セットへの仮想マシンの追加は、仮想マシンを作成するときにのみ行うことができる
    - 可用性セット内の各仮想マシンは1つの更新ドメインと1つの障害ドメインに配置される
- 更新ドメイン
    - ロールアウトのプロセスの間にまとめてアップグレードされるノードのグループ
    - 各更新ドメインには、仮想マシンのセットと、同時に更新と再起動を行える関連する物理ハードウェアが含まれる
    - 計画メンテナンス中に一度に再起動される更新ドメインは1つ
    - 更新ドメインの規定の数は5つ
    - 最大20個の更新ドメインを構成
- 障害ドメイン
    - ハードウェアの共通セットと単一障害点を共有する仮想マシンのグループが定義される
    - 最大3つの障害ドメインが連携して影響を緩和
- 可用性ゾーン
    - 効果養成を提供するサービスで、アプリケーションとデータをデータセンターの障害から保護
    - 障害ドメインと更新ドメインを組み合わせたもの
    - それぞれのゾーンは独立した電源、冷却手段、ネットワークを備えた1つまたは複数のデータセンターで構成
    - ゾーンサービス
        - 各リソースを特定のゾーンに固定
        - 例
            - Azure VM
            - Azure Managed Disks
            - Standard IP Address
    - ゾーン冗長サービス
        - プラットフォームによって全てのゾーン間で自動的にレプリケート
        - 例
            - ゾーン冗長であるAzure Storage
            - Azure SQL Database
- スケーリング
    - 垂直方向
        - ワークロードに応じて仮想マシンのサイズを増減
    - 水平方向
        - 仮想マシンの数を調整
- Azure Virtual Machine Scale Sets
    - 同一の仮想マシンのセットをデプロイして管理するために使用できるAzure Conputing Resource
    - Azure Load balancerの使用をサポートし、レイヤー7のトラフィック分散とAzure Application Gatewayの使用をサポート
    - 最大1000個の仮想マシンインスタンスをサポート
    - 独自のカスタム仮想マシンイメージを作成してアップロードする場合、仮想マシンインスタンス数の上限は600個
    - スケールインポリシー
        - 均一オーケストレーション
            - 既定
            - 可用性ゾーン間で仮想マシンを均衡
            - 障害ドメイン間で仮想マシンを均衡
            - インスタンスIDが最も大きい仮想マシンを削除
        - NewestVMスケールインポリシー
            - スケールセット内の最新の、仮想マシンが削除
        - OldestVM スケールインポリシー
            - スケールセット内で最も古く作成された仮想マシンが削除
## Azure App Service
- Webアプリを実行するための一連のコンピューティングリソースを定義
- リージョンでApp Service プランを作成すると、指定されたリージョンのプラン用に一連のコンピューティングリソースが作成
- プランに増加する付加を処理するための十分なリソースがある限り、既存のプランに新しいアプリケーションを追加し続けることができる
- SKU
    - Free
        - 共有仮想マシンインスタンスでCPU分を受け取ることによって実行
        - アプリケーションはスケールアウトできない
        - アプリケーション数: 10
    - Shared
        - 共有仮想マシンインスタンスでCPU分を受け取ることによって実行
        - アプリケーションはスケールアウトできない
        - アプリケーション数: 100
    - Basic
        - アプリケーションはApp Serviceプランで構成されているすべての仮想マシンインスタンスで実行
        - 同じプラン内の複数のアプリケーションが同じ仮想マシンインスタンスを共有
        - アプリケーション用の複数のデプロイスロットをお持ちの場合は、すべてのデプロイスロットが同じ仮想マシンインスタンスで実行
        - 診断ログを有効にするか、バックアップを実行するか、Webジョブを実行すると、これらのタスクは同じ仮想マシンインスタンス上でCPUサイクルとメモリを使用
        - アプリケーション数: 無制限
    - Standard
        - アプリケーションはApp Serviceプランで構成されているすべての仮想マシンインスタンスで実行
        - 同じプラン内の複数のアプリケーションが同じ仮想マシンインスタンスを共有
        - アプリケーション用の複数のデプロイスロットをお持ちの場合は、すべてのデプロイスロットが同じ仮想マシンインスタンスで実行
        - 診断ログを有効にするか、バックアップを実行するか、Webジョブを実行すると、これらのタスクは同じ仮想マシンインスタンス上でCPUサイクルとメモリを使用
        - アプリケーション数: 無制限
        - 自動スケール
        - デプロイスロット
    - Premium
        - アプリケーションはApp Serviceプランで構成されているすべての仮想マシンインスタンスで実行
        - 同じプラン内の複数のアプリケーションが同じ仮想マシンインスタンスを共有
        - アプリケーション用の複数のデプロイスロットをお持ちの場合は、すべてのデプロイスロットが同じ仮想マシンインスタンスで実行
        - 診断ログを有効にするか、バックアップを実行するか、Webジョブを実行すると、これらのタスクは同じ仮想マシンインスタンス上でCPUサイクルとメモリを使用
        - アプリケーション数: 無制限
        - 自動スケール
        - デプロイスロット
    - Isolated
        - アプリケーションはApp Serviceプランで構成されているすべての仮想マシンインスタンスで実行
        - 同じプラン内の複数のアプリケーションが同じ仮想マシンインスタンスを共有
        - アプリケーション用の複数のデプロイスロットをお持ちの場合は、すべてのデプロイスロットが同じ仮想マシンインスタンスで実行
        - 診断ログを有効にするか、バックアップを実行するか、Webジョブを実行すると、これらのタスクは同じ仮想マシンインスタンス上でCPUサイクルとメモリを使用
        - アプリケーション数: 無制限
        - 自動スケール
        - デプロイスロット
- 自動スケーリング
    - メトリックベース
    - 時間ベース
- 構成設定
    - アプリの名前は一意
    - アプリはコードまたはDockerコンテナーとしてApp Serviceでホスト
    - 作成後の設定
        - Aloways On
            - トラフィックがない場合でも、アプリを読み込まれたままにする
            - 継続的なWebジョブやCRON式を使用してトリガーされるWebジョブに必要
        - ARRアフィニティ
            - マルチインスタンスデプロイの場合に、アプリクライアントがセッションの有効期間を通して確実に同じインスタンスにルーティングされるようにする
        - 接続文字列
            - アプリの接続文字列は保存時に暗号化され、暗号化されたチャネルで送信
- CI/CD
    - 自動デプロイ
        - エンドユーザーへの影響を最小限に抑えて、新機能とバグ修正を高速かつ反復的なパターンでプッシュアウトするために使用されるプロセス
            - Azure DevOps
                - コードをプッシュし、クラウドでコードをビルドし、テストを実行し、コードからリリースを生成し、最後にコードをAzure Webアプリにプッシュする
            - GitHub
                - GitHubから直接自動デプロイをサポート。GitHubリポジトリをAzureに接続すると、GitHub上の運用ブランチにプッシュする全ての変更が自動的にデプロイされる
    - 手動デプロイ
        - Git
        - CLI
        - Visutal Studio
        - FTP
- デプロイスロット
    - 独自のホスト名を持つライブアプリ
    - スロットにアプリをデプロイした後に運用サイトにスワップすると、運用サイトへのスワップ前にスロットのすべてのインスタンスが準備される
    - トラフィックのリダイレクトはシームレスであるため、スワップ操作によって破棄される要求はない
    - スワップ前の検証が必要ない場合、自動スワップを構成することで、ワークフロー全体を自動化できる
    - 運用スロットにスワップした変更が想定通りでない場合は、適切な動作が確認されている元のサイトにすぐ戻せる
    - Linux上のWebアプリではサポートされない
    - スワップされる設定
        - フレームワークのバージョン、32/64 ビット、Web ソケットなどの一般的な設定
        - アプリ設定 *
        - 接続文字列 *
        - ハンドラー マッピング
        - パブリック証明書
        - WebJobs コンテンツ
        - ハイブリッド接続**
        - サービス エンドポイント**
        - Azure Content Delivery Network**
        - パスのマッピング
    - スロット固有の設定
        - カスタム ドメイン名
        - 非パブリック証明書と TLS/SSL 設定
        - スケール設定
        - 常にオン
        - IP 制限
        - WebJobs スケジューラ
        - 診断設定
        - クロスオリジン リソース共有 (CORS)
        - 仮想ネットワーク統合
        - マネージド ID
        - サフィックス _EXTENSION_VERSION で終わる設定
- セキュリティ
    - 匿名要求を許可する
    - 認証された要求のみを許可する
        - 全ての匿名要求を、選ばれたプロバイダーの/.auth/login/{provider}にリダイレクトする
    - ログおよびトレース
        - 認証と承認のトレースをログファイルで直接確認できる
- アプリのカスタムドメイン名を構成
    1. ドメイン名を予約
        - Azure Portalから直接購入できる
    1. ドメインをAzure Web AppsにマップするDNSレコードを作成
        - Web Appsの場合は、AレコードまたはCNAMEレコードを作成
        - IPアドレスが変更された場合、CNAMEエントリはまだ有効だが、Aレコードは更新する必要がある
        - 一部のドメインレジストラーではルートドメインまたはワイルドカードドメインのCNAMEレコードが許可されていない
    1. カスタムドメインを有効にする
- バックアップおよび復元の機能を使うと、手動で、またはスケジュールに従ってバックアップを簡単に作成
    - Standard, Premium,
    - バックアップするアプリと同じサブスクリプション内に、Azure Storage AccountとContainerが必要
    - ZipファイルとXMLファイル
    - 既定は完全バックアップ、部分バックアップもサポート
- Azure Application Insights
    - ライブアプリケーションの監視に使用できるAzure monitorの機能
    - オンプレ、ハイブリッド環境、または任意のパブリッククラウドでホストされている構成で使用
    - 要求率、応答時間、失敗率
    - ページビューと読み込みのパフォーマンス
    - パフォーマンスカウンター
    - ホスト診断
    - 診断トレースログ
    - カスタムイベントとメトリック
## Azure Container 
- Azure Container Instances
    - Hyper-V分離コンテナーの単一ポッドをオンデマンドで提供するため、シンプルなアプリケーション、タスク自動化、ビルドジョブなど、分離されたコンテナーで操作できる
    - 短い起動時間
    - パブリックIP接続とDNS名
    - カスタムサイズ
    - 永続的なストレージ
        - Azure Filesのフィル共有の直接マウントをサポート
    - Linux, Windows
    - 共同スケジュールグループ
    - 仮想ネットワークのデプロイ
- コンテナーグループ
    - 同じホストコンピューター上にスケジュール設定されるコンテナーのコレクション
    - マルチコンテナーグループのデプロイ方法
        - ARMテンプレート
        - YAMLファイル
    - パブリックIPアドレス、ポート、FQDNを持つDNSラベルを共有
        - 外部クライアントアクセス
        - ポートのマッピング
        - 削除されたグループ
- Azure Container Apps
    - サーバレスプラットフォームであり、コンテナーかされたアプリケーションを実行するため、保守するインフラストラクチャが少なくなり、コストを削減できる
    - デプロイを簡略化し、オーケストレーションを提供するコンテナ管理ソリューション
    - 用途
        - APIエンドポイントのデプロイ
        - バックグラウンド処理ジョブのホスト
        - イベント駆動型処理
        - マイクロサービス
    - スケーリング
        - HTTPトラフィック
        - CPUまたはメモリ負荷
## Azure Backup
- データをバックアップし、MS Azure クラウドから回復するためのソリューション
- 一元化された管理インターフェイスによって、簡単にバックアップポリシーを定義し、Azure Virtual Machines, Azure Disk, SQLおよびSAPデータベース、Azure File Sync, Blobなどを保護
- バックアップサービス
    - VM
    - Managed Disks
    - Files Sync
    - SQL Server
    - SAP DB
    - DB for PostgreSQL
    - Blob
- 方法
    - バックアップされたデータは、Recovery Services ContainerとBackup Containerに格納
    - 完全バックアップと増分バックアップ
- ワークロード統合レイヤー
    - 各ワークロードに固有のバックアップ拡張機能が、ソースVMまたはワーカVMにインストールされる
    - ストレージ: スナップショット
    - ストリームバックアップ: VMで実行されているSQLやHANA
- アクセス層
    - スナップショット層
    - Vault-Standard層
        - Azure backupで管理されるストレージアカウントの自動スケーリングセットである、バックアップストレージを保持するコンテナーに保存される
        - MSが管理するテナントにバックアップデータのコピーを隔離保存することを可能にするオンラインストレージ層
    - Archive層
        - コンプライアンスのニーズ
- レプリケーション
    - LRS
    - GRS
    - ZRS
- 削除されたバックアップは14日間無料で保存される
- 監視とレポート
    - Azure Backup はLog Analyticsと統合されておりWorkbooksを使用してレポートを表示する機能も提供
    - 操作アクティビティを大規模に監視する必要がある場合には、バックアップエクスプローラによってバックアップ資産全体の集約ビューが提供され、詳細なドリルダウン分析やトラブルシューティングが可能
- バックアップセンター
    - 複数種類のワークロード、コンテナー、サブスクリプション、リージョン、Azure Lighthouseテナントにわたってバックアップを効率的に管理
- バックアップ拡張機能
    - WindowsおよびLinuxVM全体をバックアップ
- Microsoft Azure Backup Serer
    - オンプレミスのWindows マシンのバックアップに使用
- Azure Backup job
    1. 仮想マシンデータのスナップショットを作成する
    1. そのスナップショットをAzure Recovery Services Containerに転送する
    - 既定ではバックアップと復元の時間を短縮するために、Azure Bakcup はスナップショットを2日間保持する
    - ローカルの保持により、Azure Recovery Services Containerからのデータの変換とコピーに必要な時間が短縮される
    - 既定のスナップショット保持期間は1~5日間
    - 増分スナップショットはAzure Page Blobとして格納
    - 仮想マシンスナップショットの復旧ポイントはAzure Backup Jobの両方のフェーズが完了した後にのみ使用
    - スナップショットが最初に作成されると、その復旧ポイントはスナップショットという復旧ポイントの種類であると識別
    - Azure Recovery Services Containerにスナップショットが転送されると復旧ポイントの種類はスナップショットとコンテナーに変わる
- Recovery Services Container
    - IaaSやAzure SQL DBなどさまざまなAzure サービスのバックアップデータが格納
    - System Center Data Protection
        - 堅牢なEA向けのバックアップ
    - Windows Server
    - Microsoft Backup Server
    - 手順
        1. Recovery Services Containerを作成する
            - GRS
                - Azure がプライマリバックストレージエンドポイントの場合
            - LRS
                - Azureがプライマリバックストレージエンドポイントの場合
        1. Backup Policy Optionを定義する
            - バックアップのトリガーは一日に1~5回
        1. 仮想マシンをバックアップする
            - Azure Backup job プロセスを実行
            - バックアップジョブを実行する場合、VMにMicrosoft Azure VM Agent を導入する必要がある
                - VMがAzure ギャラリーから作成された場合、エージェントは既定でマシンにインストールされる
                - 仮想マシンがオンプレミスのデータセンターから移行された場合は、マシンにエージェントを手動でインストールする必要がある
    - Azure Portal では仮想マシンスナップショットの回復ポイントを選択できる
    - 復元操作を始めると、Azure Backupによってその復元操作を追跡するジョブが作成される
    - Azure backupによって復元操作に関する通知が作成され、一時的に表示される
    - Azure Portal でジョブ通知を監視することで復元操作を追跡できる
- Backup Options
    - Azure Backup
        - 運用ワークロードを実行し、Azure仮想マシンをバックアップ
        - WindowsとLinuxの両方の仮想マシンに対してアプリケーション整合性バックアップを作成
        - 仮想マシン全体または特定のファイルのみ復旧
    - Azure Site Recovery
        - 特定のアプリケーションを素早く簡単に復旧させる
        - 任意のAzureリージョンにレプリケート
        - 自然災害や広範囲にわたるサービス中断によるリージョン全体の停止時に仮想マシンを保護
        - プライマリサイトからセカンダリの場所にワークロードをレプリケートすることで、ビジネス継続性を確保する
    - Azure Managed Disk - Snap Shot
        - 任意の時点でAzure Managed Diskを使用する仮想マシンを素早く簡単にバックアップ
        - Managed Diskの読み取り専用のフルコピー
        - 既定でStandard Managed Diskとして格納
    - Azure Managed Disk - Image
        - Azure Storage Account内のVHD、または仮想マシンから直接イメージを作成
        - Azure Storage Accountをコピーまたは管理せずにカスタムイメージを使用して仮想マシンを作成
- VMの論理的な削除
    - Azure Blobオブジェクトの論理的な削除オプションが提供
    - バックアップデータはバックアップ停止操作後、14日間保持される
    - 削除されたバックアップデータのみが保護
    - 仮想マシンのバックアップデータを削除または保持する前に、アクティブなバックアップジョブを停止する必要がある
    - バックアップデータの削除を選択した後、バックアップの停止を選択
    - 論理的に削除された仮想マシンを復元する前に、バックアップデータの削除を取り消す必要がある
    - バックアップの選択した復旧ポイントからの仮想マシンを復元を選択して、仮想マシンを復元
    - 削除を取り消す処理が完了すると、バックアップジョブの状態はデータを保持しsてバックアップを停止するに戻り、バックアップの再開を選択できるようになる
# 監視
## Azure Monitor
- オンプレミスとクラウドの両方の環境から利用統計情報を収集、分析、応答する包括的なソリューション
- メトリックの監視と視覚化
- ログのクエリと分析
- アラートとアクションの設定
- Azure Monitorのデータストアにはメトリックとログが保持される
- Azure Monitor Insights
    - 分析、アラート、外部システムへのストリーミングなど、収集されたデータを使用する
    - 分析情報を取得する
        - Azure MonitorへのAzure Application Insights拡張機能にアクセス
    - 視覚化
    - 分析
        - Azure Monitor Logを使用して、データのログクエリを記述
    - 応答
        - ログアラートルールを設定して、アプリケーションのパフォーマンスに関する通知を受け取る
        - クエリとアラートの結果が特定の条件または結果と一致する場合に自動アクションを実行するようにサービスを構成
    - 統合
        - Azure CLI, Azure PowerShell, およびさまざまなAPIからログクエリの結果を取り込んでエクスポート
        - Azure Storage AccountまたはAzure Event Hubsへのログデータの自動エクスポートを設定
- メトリックとログ
    - メトリック
        - 特定の時点におけるシステムの何らかの側面を表す数値
        - 軽量であり、リアルタイムに近いシナリオをサポート
        - メトリックエクスプローラー
            - Azureサービスとリソースのメトリックを表示
    - ログ
        - 種類ごとに異なるプロパティセットを持つレコードに編成されたさまざまな種類のデータが含まれる
        - Azure Monitorによって収集されたログデータがLog Analyticsに保存
- データ収集について
    - Azureサブスクリプションを作成してリソースを追加するとすぐに、Azure monitorでのデータの収集が始まる
    - リソースを作成または変更すると、データはAzure Monitorアクティビティログに格納
    - リソースに関するパフォーマンスデータと消費されるリソースの量は、Azure Monitor Metricsとして格納
    - 診断を有効にし、コンピューティングリソースにAzure Monitor Agentを追加して、収集するデータを拡張する
    - Windows,およびLinuxからログとメトリックを収集する
- Activity Log
    - Azureで発生したサブスクリプションレベルのイベント分析情報を提供するサブスクリプションログ
    - リソースに対する操作とその他の関連プロパティの状態を把握
    - リソースに対して実行されたすべての書き込み操作について、いつ誰が行ったのかを確認
    - 90日間保持
    - イベントカテゴリ
        - 管理
        - サービス正常性
        - Resource Health
        - Alert
        - Autoscale
        - 推奨
        - Security
            - Microsoft Defender For Cloudによって生成されたすべてのアラート
        - Policy
- アラートルールの範囲
    - メトリック値
    - ログの検索クエリ
    - アクティビティログのイベント
    - 元になっているAzureプラットフォームの正常性
    - Webサイトの可用性のテスト
- 静的閾値
- 動的閾値
    - ルックバック期間
        - 評価する必要があるかこの期間の数を定義
    - 違反数
        - ロジック条件が想定された動作から逸脱した回数がこの数を超えるとアラートルールによって通知が生成される
- ディメンション
    - 1つのメトリックアラートルールを定義し、複数の関連するインスタンスに適用できる
- スケールメトリックアラート
    - 複数のリソースを監視
- ログ検索
    - レコード数
    - メトリック測定
        - 集計関数
            - AggregatedValue
        - グループフィールド
        - 間隔
        - 閾値
    - ステートレス
- アクテビティログアラート
    - 特定の操作
    - サービス正常性イベント
- アラートプロセスルール
    - アラートが発報された時の挙動を上書きする
## Log Analytics
- KQL
- 一般的な専用テーブルには、Event, Syslog, Heartbeat, Alertなどがある
## Azure Network Wather
- Azure仮想ネットワーク内のリソースの監視、診断、メトリックの表示、ログの有効化または無効化を行うツールを提供
- IPフロー検証
    - インターネット間およびオンプレミス環境間の接続に関する診断
    - NSGについて
    - セキュリティ規則の検証に最適
    - テスト実行が失敗してもNSG規則の関連が示されていない場合は、ファイアウォールの制限などの要素を考慮する
- ネクストホップ
    - ネットワークルート内の次の接続ポイントを憑依し、ネットワークルーティング構成を分析
    - トラフィックが目的の宛先に送信されているかどうかを確認
- VPNのトラブルシューティング
    - 収集されたデータを使用して仮想ネットワークゲートウェイまたは接続の正常性を診断してトラブルシューティングする
- NSG診断
    - フローログを使用してNSGを介してIPトラフィックをマッピング
- 接続のトラブルシューティング
    - 仮想マシン、アプリケーションゲートウェイ、またはAzure Bastion Hostから仮想マシンへTCPまたはICMP接続を確認する
- ネットワークトポロジー
    - 仮想ネットワーク内のリソースを視覚的に示す
    - 仮想ネットワークと同じリージョンにAzure Network Watherインスタンスが必要