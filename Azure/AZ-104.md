# Azure 管理者向けの前提条件

### Azure PowerShell

Azure PowerShell: Windows PowerShell または PowerShell Core に追加するモジュールで、自分の Azure サブスクリプションに接続してリソースを管理できるようにする。

- PowerShell が機能している必要あり
- シェルウィンドウやコマンド解析などのサービスを提供

#### 利用方法

- Azure Cloud Shell: ブラウザー内で利用
- ローカル: Linux, macOS, WindowsOS にローカルインストールして利用
- Azモジュール: Azure 機能で使用できるコマンドレットを含む Azure PowerShell コマンドレットの正式名称。あらゆる Azure リソースのほぼ全ての面を制御

### Azure CLI

Azure CLI: Azure に接続し Azure リソースで管理コマンドを実行するためのコマンドラインプログラム。

- Linux, macOS, Windows 上で実行され管理者と開発者は Web ブラウザーの代わりにターミナル、コマンドラインプロンプト、またはスクリプトを介してコマンドを実行できる。
- ローカルでの実行が可能: Linux, macOS, WindowsOS を実行しているコンピューターにインストール
- ブラウザからの使用が可能: Azure Cloud Shell を介してブラウザーから使用可能
- 対話形式:
  - Windows: cmd.exe などのシェルを起動
  - Linux, macOS: Bash
- スクリプト:選択したシェルノスクリプト構文を使用して複数の Azure CLI コマンドを 1 つのシェルスクリプトにまとめる。その後実行
- ほぼあらゆるリソースを制御可能
  - リソースグループ
  - 記憶域
  - VM
  - Azure AD
  - Containers
  - 機械学習

### Azure Resource Manager

#### 利点

- ソリューション内の複数のリソースを 1 つのグループとして作業できる。
- 全てのリソースを一回の連携した操作でデプロイ、更新、または削除可能
- デプロイ時のテンプレートの使用: テスト、ステージング、運用環境などのさまざまな環境に使用できる。
- デプロイ後のリソース管理に役立つ、セキュリティ、監査、タグ付けの機能が用意
- 一貫性のある管理レイヤー: Azure PowerShell, Azure CLI, Azure portal, REST API, クライアント SDK を通じてタスクを実行する一貫性のある管理レイヤーが提供される。
- 全ツールが API を介して Azure Resource Manager とやりとり
- API により要求の認証と承認を行う Azure Resource Manager サービスに要求が渡される
- Azure Resource Manager により適切なリソースプロバイダーに要求がルーティングされる

#### メリット

- ソリューションのリソースを個別に処理するのではなく、全てのリソースをグループとしてデプロイ、管理、監視可能
- ソリューションを開発のライフサイクル全体で繰り返しデプロイ可能。常にリソースが一貫した状態でデプロイ
- スクリプトではなく宣言型のテンプレートを使用してインフラストラクチャを管理
- ロールベースのアクセス制御が管理プラットフォームにネイティブに統合されるためリソースグループのすべてのサービスにアクセス制御を適用できる
- タグをリソースに適用し、サブスクリプションの全てのリソースを論理的に整理
- 同じタグを共有するリソースグループのコストを表示することで組織の課金をわかりやすくすることができる

#### ガイダンス

- 命令型のコマンドを使用するのではなく、Azure Resource Manager テンプレート内の宣言型構文を使用してインフラストラクチャを定義及びデプロイする
- 命令型: 具体的に何をしているのかを定義(python でよく使う書き方)
- 宣言型: ゴールを抽象的な状態でそのまま記述(HTML, SQL)
- デプロイと構成の手順全てをこのテンプレートで定義。ソリューションの設定に手動操作は必要ない
- アプリやコンピューターの開始または停止などリソースの管理には命令型コマンドを実行
- リソースグループないの同じライフサイクルでリソースを調整。リソースのその他の全ての整理には
# 用語

### リソース

Azure を通じて管理できる要素。一般的なリソースとしては、仮想マシン、ストレージアカウント、Webアプリ、データベース、仮想ネットワークなどがある

### リソースグループ

Azure ソリューションの関連するリソースを保持するコンテナー。リソースグループにはソリューションの全てのリソースか、グループとして管理したいリソースのみを含めることが可能。組織のニーズに合わせてリソースをリソースグループに割り当てる方法を指定

### リソースプロバイダー

Resource Managerを使用してデプロイ及び管理できるリソースを提供するサービス。各リソースプロバイダーはデプロイされたリソースを利用するための操作を提供。

- Microsoft.Compute: 仮想マシンリソースを提供
- Microsoft.Storage: ストレージアカウントリソースを提供
- Microsoft.Web: Webアプリに関連したリソースを提供

### テンプレート

リソースグループにデプロイする1つ以上のリソースを定義するJSONファイル。デプロイ対象リソース間の依存関係もこのテンプレートによって定義。このテンプレートを使えばリソースを一貫性のある形で繰り返しデプロイ可能

### 宣言型構文

一連のプログラミングコマンドを記述しなくても作成しようしているものを明確に宣言することのできる構文。

### リソースグループを作成

リソースをリソースグループへデプロイすることでテンプレートの実行を追跡できるジョブになる

- デプロイ失敗時、ジョブ出力によりデプロイが失敗した理由が示される
- グループないの全てのリソースで同じライフサイクルが共有される必要がある
- あるリソースグループから別のリソースグループへリソースを移動可能
- 管理操作のアクセス制御のスコープを設定
- 他のリソースグループ内のリソースとやりとり可能

### 注意事項

- リソースは1つのリソースグループのみ存在
- リソースグループの名前は変更不可
- リソースグループにはさまざまな種類のリソースを含めることができる
- リソースグループには多くの異なるリージョンからのリソースを含めることができる

### Azure リソースを再構成する

- リソースの移動
  - 新しいサブスクリプション
  - 同じサブスクリプション内の新しいリソースグループ
- リソースを移動する場合はその操作の間、ソースグループとターゲットグループの両方がロックされる。
  - 移動が完了するまでブロック
  - 追加、更新、削除が不可
- リソースとリソースグループの削除
  - そこに含まれているすべてのリソースが削除される
  - そのリソースグループには他のリソースグループで使用されているリソースが含まれている可能性がある
  - PowerShellを使用してリソースグループを削除
    - `Remove-AzResourceGroup -Name “RGGROUPNAME”`

### リソース制限を決定する

現在の使用状況を追跡し、将来の使用を計画するのに役立つ

### Azure Resource Manager テンプレートの利点についての確認

Azure Resource Managerテンプレートではデプロイに含まれるすべてのResource Managerリソースが正確に定義されている

### テンプレート利点

- テンプレートによって一貫性が向上
- テンプレートは複雑なデプロイを表現するのに役立つ
- テンプレートによりエラーが発生しやすい手動タスクが減る
- テンプレートはコード
- テンプレートにより再利用が推進される
- テンプレートはリンク可能
  - テンプレートをまとめてリンクしてテンプレート自体をモジュール化することができる
- テンプレートはオーケストレーションを簡略化する

# Azure Resource Managerテンプレートスキーマ

JSONでの記述

格納データをオブジェクトとしてテキストで表す

- `$schema`: テンプレート言語のバージョンが記述されているJSONスキーマファイルの場所
- `contentVersion`: テンプレートのバージョン。任意の値を指定可能
- `parameters`: リソースのデプロイをカスタマイズするのにはデプロイを実行すると提供されている値
- `variables`: テンプレート言語式を簡略化するためにテンプレート内でJSONフラグメントとして使用される値
- `functions`: テンプレート内で使用できるユーザー定義の関数
- `resources`: リソースグループ内でデプロイまたは更新されるリソースの種類
- `outputs`: デプロイ後に返される値

### Azure Resource Manager テンプレートのパラメータについて

```json
"parameters": {
    "<parameter-name>" : {
        "type" : "<type-of-parameter-value>",
        "defaultValue": "<default-value-of-parameter>",
        "allowedValues": [ "<array-of-allowed-values>" ],
        "minValue": <minimum-value-for-int>,
        "maxValue": <maximum-value-for-int>,
        "minLength": <minimum-length-for-string-or-array>,
        "maxLength": <maximum-length-for-string-or-array-parameters>,
        "metadata": {
            "description": "<description-of-the parameter>"
        }
    }
}
```
# Azure Resource Manager

### Bicepテンプレート

**Azure Bicep:** 宣言型の構文を使用してAzure リソースをデプロイするドメイン固有言語(DSL)
- 簡潔な構文
- 信頼性の高いタイプセーフ
- コードの再利用のサポートが提供

ARM テンプレートを作成するためのJSON構文は冗長になることがあり、複雑な指揮を必要とする。一方Bicep構文ではその複雑さが軽減され開発エクスペリエンスが向上する。

#### 仕組み
1. リソースまたは一連のリソースをAzureにデプロイ
2. トランスパイル: BicepテンプレートがJSONテンプレートに変換

#### 利点
- シンプルな構文
- モジュール性: 複雑なテンプレートデプロイを小さなモジュールファイルに分割しメインテンプレート内で参照できる
- 依存関係の自動管理: リソース間の依存関係は、Bicepによって自動検出される
- 種類の検証とIntelliSense: VS Code用のBicep拡張機能はAzureリソースの種類のAPI定義全てを対象とした豊富な検証機能とIntelliSenseを備える

### クイックスタートテンプレート

**Azure クイックスタートテンプレート:** Azureコミュニティによって提供されているAzure Resource Managerのテンプレート
- README.md: テンプレートの機能の概要
- azuredeploy.json: デプロイされるリソースを定義
- azuredeploy.parameters.json: テンプレートに必要な値を提供

### 対話型ラボシミュレーションーテンプレート

Azure PowerShell がタスクに合っているかどうかを判断する
- 管理ツール: 管理できる機能はほぼ同じ。Windows, macOS, 及びLinux上で動作する
- Azure Portal: Azure サブスクリプションのリソースを作成、構成、変更することができるwebサイト。
- Azure CLI: Azureに接続してAzureリソース上で管理コマンドを実行することができるクロスプラットフォームのコマンドラインプログラム。反復的なタスクを自動化するには、選択したシェルノスクリプト構文を使用して、複数のコマンドを1つのシェルスクリプトにまとめてスクリプトを実行
- Azure Cloud Shell経由のブラウザー内
- Linux, Mac, Windows上のローカルインストール
- Azure PowerShell: PowerShellに追加し、Azureサブスクリプションに接続してリソースを管理することができるモジュール
- PowerShellが機能している必要あり
- Azure Az PowerShellモジュールでAzure固有のコマンドが追加
- Azure Cloud Shell経由のブラウザー内
- Linux, Mac, Windows上のローカルインストール

#### 対話モード
#### スクリプトモード
#### PowerShellのインストール
- Base PowerShell製品
- Azure Az PowerShell モジュール: Azureリソースのほぼ全ての面を制御するためのコマンドレットを含む
- PowerShell コマンドレット: PowerShellコマンド。
- PowerShell モジュール: 利用可能な各コマンドレットを処理するコードを含むダイナミクリンクライブラリ
- コマンドレットはモジュールに付属する

### 管理ツールを選択
- 自動化
- 学習曲線
- チームのスキルセット: PowerShellの知識

### ARM テンプレート
- Infrastructure as Code
- 一貫性のある構成
- スケーラビリティの向上
- 迅速なデプロイ
- 追跡可能性の向上

#### テンプレートにリソースを追加する
- 組み合わせの構文: resource-provider/resource-type
- ex.: Microsoft.Storage/storageAccount
- find resource providers
- find each resource’s property
  - 組み合わせの構文: resource-provider/resource-type
  - ex.: Microsoft.Storage/storageAccount
  - find resource providers
  - find each resource’s property

# Azure でのIDとガバナンス

### Azure Active Directory

**Azure Active Directory:** MS のマルチテナントクラウドベースのディレクトリ及びID管理サービス。

#### アクセス先
- 企業ネットワーク上にある内部リソースとアプリ
- MS365, Azure portal, SaaSアプリケーションなどの外部リソース
- 組織向けに開発されたクラウドアプリ

#### 代表的な機能
- **SSO Access:** クラウド上のWebアプリ及びオンプレミスのアプリへのセキュリティで保護されたSSOが提供される。ユーザーは同じ資格情報セットで全てのアプリにアクセス可能
- **ユビキタスデバイスのサポート:** 各種デバイスから各種プラットフォームを通じてアプリを起動
- **セキュリティで保護されたリモートアクセス**
- **クラウドへの拡張性**
- **機密データの保護**
- **セルフサービスのサポート**

#### 主要コンポーネント
- **ID:** 認証できるオブジェクト
  - ユーザー名とパスワードを持つユーザー
  - 秘密鍵または証明書を必要とするアプリケーションやサーバー
- **アカウント:** データが関連づけられているID
  - **Azure AD アカウント:** Azure AD またはそれ以外のMSクラウドサービスを通じて作成されるID
- **Azure テナント:** Azure ADの専用の信頼された単一のインスタンス。一つの組織
- **Azure サブスクリプション:** 料金を支払うための単位

#### エディション
- *参加を実装:* Azure Active Directoryを使うと任意の場所からデバイス、アプリケーション、サービスにシングルサインオンできる。SSOサポートのため、会社の資産が保護されデバイスがセキュリティとコンプライアンスの基準を満たしていることを確認する必要がある

#### 利点
- **SSO:** 余分な認証プロンプトがない
- **Enterprise State Roaming:** ユーザーはユーザー設定とアプリ設定のデータを参加済みデバイスに安全に同期できる。新しいデバイスを構成する時間が短縮される
- **Windows Hello:** 参加済みデバイスから仕事用リソースへのセキュリテイ保護便利なアクセスをユーザーに提供
- **アクセス制限:** コンプライアンスポリシーを満たす参加済みデバイスからのみに制限
- **オンプレミスリソースへのシームレスなアクセス:** デバイスからオンプレミスのドメインコントローラーへの通信経路がある場合、参加済みデバイスはオンプレミスのリソースにシームレスにアクセスできる

#### 考慮すべきこと
- **接続オプション**
  - デバイス自体を登録: 個人アカウントや職場アカウントを使用してデバイスにサインインできる
  - デバイスにサインインするIDを指定する
  - 他のソリューションと組み合わせ
- **他の実装シナリオ**
  - **セルフパスワードリセット**
    - **特性と要件**
      - SSPRオプションを管理するためにグローバル管理者特権を持つAzure ADアカウントが必要
      - SSPRではセキュリティグループを使用してSSPR特権を持つユーザーを制限
      - 組織内のユーザーアカウント全てにSSPRを使用するための有効なライセンスが必要

### Active Directory Domain Service

**Active Directory Domain Service:** 物理または仮想サーバーへのWindows ServerベースのActive Directoryの従来デプロイ

#### 代表サービス
- Active Directory証明書サービス
- Active Directoryライトウェイトディレクトリサービス
- Active Directoryフェデレーションサービス
- Active Directory Rights Managementサービス

#### AD DS vs Azure AD
**AD DS**
- ディレクトリサービス
- 複数の認証
- SAML, WS-Federation, Open ID Connect

**Azure AD**
- 完全なIDソリューション
- HTTP及びHTTPS通信を使用するインターネットベースのアプリケーション向けに設計されている
- Kerberos認証は使用されない
- フェデレーションサービス及び多くのサードパーティサービスが含まれる
- フラットな構造: ユーザーとグループ同格
- 管理サービス: ユーザー、グループ、ポリシーのみを管理

### Azureでのストレージの実装と管理
- Azureのコンピューティングリソースのデプロイと管理
- Azure管理者向けの仮想ネットワークの構成と管理



# 管理者向けの仮想ネットワークの構成と管理
## 仮想ネットワークを構成する
- Azure Virtual Network
  - プライベートネットワークを作成
  - Azureリソースが相互に、及びインターネットやオンプレミスネットワークと安全に通信
  - 仮想ネットワーク
    - Azureクラウドリソースを論理的に分離
    - VPNをプロビジョニング及び管理
    - CIDRブロックを用いたリンク機能
      - CIDR
        - Classless Inter-Domain Routing
        - IPアドレスをより効率的に管理するためのアドレス指定方式
        - IPAddress/Prefix
        - 仮想ネットワークのアドレス空間の指定
        - NSGのルール設定
    - 仮想ネットワーク用のDNSサーバーの設定と、仮想ネットワークのサブネットへのセグメント化は自身で制御

### サブネットの作成
- サブネット
  - 仮想ネットワーク内に論理的な境界を実装
  - ネットワークをサブネットにセグメント化することで、セキュリティを強化し、パフォーマンスを向上させ、管理を容易にできる
  - 各サブネットには、過疎ネットワークアドレス空間に収まるIPアドレスの範囲が含まれる
  - サブネットのアドレスの範囲は、仮想ネットワークのアドレス空間内で一意
  - 1つのサブネットの範囲が、同じ仮想ネットワーク内の他のサブネットのIPアドレス範囲と重複しない
  - サブネットのIPアドレス空間は、CIDR表記で指定
  - 固定のアドレス(x.x.x.x/24の時)
    - x.x.x.0
      - 仮想ネットワークアドレス
    - x.x.x.1
      - Azureにより規定のゲートウェイとして構成
    - x.x.x.2, x.x.x.3
      - Azure DNS IPアドレスは、Azureにより仮想ネットワーク空間にマップされる
    - x.x.x.255
      - 仮想ネットワークのブロードキャスト
  - 考慮すること
    - サービス要件
      - 仮想ネットワークに直接デプロイされるサービスごとに、ルーティングやトラフィックの要件を確認
    - ネットワーク仮想アプライアンスを検討
      - ネットワーク仮想アプライアンス
        - ネットワークトラフィックを制御・監視し、セキュリティ、ルーティング、ロードバランシングなどの機能を提供するためのソフトウェアまたは仮想デバイス
      - 既定では、ネットワークトラフィックは仮想ネットワーク内のすべてのサブネット間でルーティングされる。
    - サービスエンドポイントを検討
      - 外部リソースへの接続を制御する
    - ネットワークセクリティグループを検討
      - 仮想ネットワーク内の各サブネットには0~1個のNSGを設定可能
    - プライベートリンクを検討
      - 仮想ネットワークから外部リソースやサービスへのプライベート接続が可能になる
      - Azure内のエンドポイント間の接続がセキュリティで保護される

### 仮想ネットワーク作成
- 要件
  - ネットワークのIPアドレス空間を定義
  - 組織でまだ使用されていないIPアドレス空間の使用
    - 作成後に変更不可
  - 1つ以上のサブネットを定義
    - 各サブネットには、仮想ネットワークアドレス空間に収まるIPアドレスの範囲が含まれる
    - 各サブネットのアドレスの範囲は、仮想ネットワークのアドレス空間内で一意にする
    - サブネットの範囲が、同じ仮想ネットワーク内の他のサブネットのIPアドレス範囲と重複しない

### IPアドレス指定
- プライベートIPアドレス
  - Azure仮想ネットワーク内とオンプレミスネットワーク内での通信を可能にする
  - VPNゲートウェイまたはAzure ExpressRoute回路を利用してネットワークをAzuremまで拡張する時、リソースにプライベートIPアドレスを作成
- パブリックIPアドレス
  - リソースはインターネットと通信
- 特性
  - 静的/動的割り当て
  - IPリソースを異なるサブネットに分割
  - 静的IPアドレス
    - DNS名の解決。IPアドレスが変わると、ホストレコードの更新が必要になる
    - アプリまたはサービスが静的IPアドレスを持つ必要があるIPアドレスベーツのセキュリティモデル
    - IPアドレスにリンクされているTLS/SSL証明書
    - IPアドレス範囲を使用してトラフィックを許可または拒否するファイアウォール規則
    - ドメインコントローラーやDNSサーバーなどのロールベースのVM

#### パブリックIPアドレス作成
- IPバージョン
- SKU
  - Standard: 高機能
    - 静的
    - 既定でセキュリティ保護され、受信トラフィックに対して閉じられる
    - NI
    - パブリックStandardロードバランサー
  - Basic: 中機能
    - IPv4: 静的、動的
    - IPv6: 動的
    - 既定で開かれる
    - NIC
    - VPN Gateway
    - App Gateway
    - ロードバランサー
  - 値はアドレスが使用されるAzureロードバランサーのSKUに一致
- 名前
  - リソースグループ内で一意
- 割り当て
  - 動的
    - パブリックIPアドレスがAzureリソースに関連づけられ、初めて起動した後に行われる
    - リソースが停止し、再起動した場合動的アドレスが変わる場合がある
  - 静的
    - パブリックIPアドレスの作成時に割り当て

#### パブリックIPアドレスを使用
- 関連付けの先
  - 仮想マシンのネットワークインターフェース
    - NIC
  - インターネットに接続するロードバランサー
    - フロントエンド構成
  - VPNゲートウェイ
    - VPNゲーウェイIP構成
  - アプリケーションゲートウェイ
    - フロントエンド構成

#### プライベートIPアドレス割り当て
- 関連づけ先
  - 仮想マシンのネットワークインターフェース
    - NIC
  - 内部ロードバランサー
    - フロントエンド構成
  - アプリケーションゲートウェイ
    - フロントエンド構成
- 割り当て
  - リソースのデプロイ先となる仮想ネットワークサブネットのアドレスの範囲から割り当て
  - 動的
    - サブネットのアドレス範囲内で、利用可能なアドレスが割り当て
  - 静的
    - サブネットのアドレス範囲内で、未割り当てかつ未予約のアドレスを自身で選択

### IPアドレス指定スキーマ
- 

### ピアリング
- 2つの仮想ネットワークを接続する
- リージョン仮想ネットワークペアリング
  - 同じリージョンに存在するAzure仮想ネットワークを接続
- グローバル仮想ネットワークペアリング
  - 異なるリージョンに存在するAzure仮想ネットワークを接続
- メリット
  - ピアリングされた仮想ネットワーク間のネットワークトラフィックはプライベート
  - Azureインフラストラクチャを利用
  - ピアリングした仮想ネットワークのリソース間での通信が可能
  - シームレスなデータ転送
  - リソースの中断がない
- ピアリング拡張方法
  - ハブとスポークのネットワーク
    - ハブ仮想ネットワークで、ネットワーク仮想アプライアンスやAzure VPNゲートウェイなどのインフラストラクチャコンポーネントをホストできる
  - ユーザー定義のルート
    - ユーザー定義ルート上の次ホップをピアリングされた仮想ネットワーク内の仮想マシンまたはVPNゲートウェイのIPアドレスにする
  - サービスチェーン
    - サービスチェイニングを使い、ユーザー定義のルートを設定

#### Azure VPN Gateway
- 仮想ネットワークにはVPNゲートウェイを1つだけ作成
- リージョンとグローバルの両方
- NSGの適用が可能

## ネットワークセキュリティグループを構成する
- NSG
  - 仮想ネットワーク内のリソースへのネットワークトラフィックを制限する方法
  - 特性
    - 受信または送信ネットワークとファ一句を許可または拒否するセキュリティの規則のリスト
    - サブネットまたはネットワークインタフェースに関連づけ
    - 複数回関連付け
  - DMZ
    - DeMitarizedZone
    - 外部ネットワークと社内ネットワークの中間に作られるセグメント
    - 保護対象の境界ネットワーク
    - サブネット内に存在するすべてのマシンにトラフィックフローを制限
    - 各サブネットにはNSGを最大1つ関連付け
  - ネットワークインターフェース
    - NICに割り当て可能
    - NICに流れるすべてのトラフィックを制御するための規則を定義
    - 各ネットワークインターフェースには、NSGを0~1関連付け

### NSG規則を決定
- 既定の規則はDenyAllInbound、AllowInternetOutbound
- 既定のセキュリティ規則が作成
- セキュリティ規則の追加
  - 名前
  - 優先順位
  - ポート
  - プロトコル
  - 接続元
  - 接続先
  - アクション
- インバウンドトラフィックの場合、サブネットのNSG->ネットワークインターフェースのNSGの順に処理
- インバウンドトラフィクの場合、規定のセキュリティ規則であるDenyAllInboundが作成される
- アウトバウンドトラフィックの場合、ネットワークインターフェースのNSG->サブネットのNSGの順に処理
- か
- アウトバウンドトラフィックの場合、既定のセキュリティ規則であるAllowInternetOutboundが作成される
- 考慮すべきこと
  - 全トラフィックの許可
  - 許可規則の重要性
  - サブネットのトラフィック
  - 規則の優先順位
- パラメーター
  - 送信元
    - 受信トラフィックを制御する方法
  - 送信先
    - 送信とファ一句を制御する方法
  - サービス
    - セキュリティ規則の送信先プロトコルとポート範囲を指定
  - 優先度
    - 優先順位の値が小さければ小さいほど、規則の優先度がそれだけ上がる
- 実装時に考慮すること
  - IPアドレスの維持
  - サブネットがないと考える
    - VMをアプリケーションセキュリティグループに編成すれば。サーバーを特定のサブネットに分散させる必要がない
  - 簡略化された規則
    - アプリケーションセキュリティグループは複数の規則セットに必要性をなくす
  - ワークロードのサポートを考慮

## Azure DNSを構成する
- Azure DNS
  - Azure上でDNSドメインを管理できるホスティングサービス
  - カスタムドメインを構成及び管理できる
  - ドメインのSOAとして機能する
    - SOA
      - Start of Authotity
      - a type of DNS resource record that contains administrative information about the zone, particularly regarding the zone's parameters and primary authoritative name server.
  - Azure Subscriptionを作成すると、サブスクリプションのMicrosoft Entraドメインが自動的に作成される
  - 初期ドメイン名が初期ドメインインスタンスに適用
    - `{YourDomainName.onmicrosoft.com}`
  - カスタムドメイン名の目的は、特定のユーザーまたはタスクをサポートするために、ドメイン名の簡略化された形式を提供
  - 初期ドメイン名はカスタムドメイン名が確認されるまで使用することを目的とする
  - カスタムドメイン名をMicrosoft Entra IDで使用できるようにするには、事前にカスタムドメイン名をディレクトリに追加して確認する必要がある
  - 初期ドメイン名は変更または削除は不可、制御するルーティング可能なカスタムドメイン名を追加できる
  - Microsoft Entra IDではドメイン名はグローバルに一意である必要がある
- DNSゾーン
  - リソースグループ内でDNSゾーンは一意
  - ルート及び親ドメインはレジストらーに登録され、その後AzureDNSを指すようになる
  - 子ドメインはAzure DNSに直接登録される
- DNSレコードセット
  - DNSゾーン内のレコードコレクション
  - DNSレコードセット内のすべてのレコードは、名前とレコードの種類が同じ
  - DNSレコードセットに同一のレコードを2つ含めることはできない
  - CNAMEは1つ
  - 空のレコードセットを作成できる
  - ドメインに空のレコードセットがある場合、このセットはAzure DNSネームサーバーに表示されない
- DNSの仕組み
  - 最近アクセスされた、または使用されたドメイン名とそれらのIPアドレスのローカルキャッシュを保持する
  - 要求されたドメインが見つからない場合、要求を別のDNSサーバーに渡す
  - このプロセスは一致するか、検索がタイムアウトになるまで続く
  - IPアドレス、及びそのDNSサーバーが権威を持つホストまたはサブドメインのキーと値のペアのデータベースを保持する


### カスタムドメイン名を確認する
- 管理者がMicrosoft Entraインスタンスにカスタムドメイン名を追加するとき、その名前は最初有効性が確認されていない状態となる。ディレクトリリソースの有効性が確認されていないカスタムドメイン名を使用することは許可されない
- 有効性の検証プロセスは、カスタムドメイン名のDNSレコードを追加することで開始

### DNSドメインを委任
- DNSゾーンのDNSネームサーバーを識別する必要がある
- DNSゾーン作成時、Azure DNSによってDNSネームサーバーが割り当てられる
- Azure DNSによってDNSゾーンに権限のあるレコードが自動的に作成される
- 親ドメインを更新する方法
  1. レジストラーのDNS管理ページに移動
  1. 親ドメインの既存のNSレコードを検索
  1. 既存のNSレコードを、Azure DNSによってドメインように作成されたNSレコードに置き換える
  - 注意事項
    - NSレコードをコピーするときは、必ずアドレスの末尾にピリオドを含めるようにする
- サブドメインを委任する

### Azure プライベートDNSゾーンを計画する
- 各自のカスタムドメイン名を使って作成
- 仮想ネットワーク内および仮想ネットワーク間で仮想マシンの名前が解決される
- プライベートとパブリックのDNSゾーンで同じドメイン名を共有できる
- 利点
  - カスタムDNSソリューションが不要
  - 一般的なレコードの種類のサポート
  - ホスト名のレコード自動管理
  - 仮想ネットワーク間のホスト名の解決
  - スプリットホライズンDNSのサポート
  - すべてのAzureリージョンで利用可能

##　ネットワークルーティングとエンドポイントを構成する
- システムルート
  - トラフィックの制御
    - 同じサブネット内の仮想マシン間のトラフィック
    - 同じ仮想ネットワークでの異なるサブネット内の仮想マシン間のトラフィック
    - 仮想マシンからインターネットへのトラフィック
  - ルートテーブルには一連の規則が含まれている。ここで仮想ネットワーク内でどのようにパケットをルーティングする必要があるかを指定する
  - ルートテーブルには、テーブルがサブネットに関連づけられているシステムルートに関する情報が記録される
  - サブネットから離れる各パケットは関連づけするルートテーブルに基づいて処理される
  - パケットは送信先を使用してルートと照合される。
    - 宛先
      - IPアドレス
      - 仮想ネットワークゲートウェイ
      - 仮想アプライアンス
      - インターネット
  - 一致するルートが見つからない場合、そのパケットは破棄

### UDR
- トラフィックフローのネクストホップを指定するルートを定義することで、ネットワークトラフィックを制御
- ネクストホップ
  - 仮想ネットワークゲートウェイ
  - 仮想ネットワーク
  - インターネット
  - ネットワーク仮想アプライアンス
- システムルートと同様に、UDRもルートテーブルにアクセスする
- 各ルートテーブルは複数のサブネットに関連づける
- 各サブネットは1つのルートテーブルにのみ関連づける
- ルートテーブルの作成は無料

### サービスエンドポイント
- サービスエンドポイントなし
  - 仮想ネットワークtoAzureサービストラフィックは、パブリックIPアドレスを発信元IPアドレスとして使用
- サービスエンドポイントあり
  - 仮想ネットワークtoAzureサービストラフィックは、仮想ネットワークのプライベートIPアドレスを発信元IPアドレスとして使用
  - IPファイアウォールで通常使用される予約済のパブリックIPアドレスを使用することなくサービスにアクセス可能
- 特性
  - 仮想ネットワークIDを拡張
  - 仮想ネットワーク規則を使用して,Azureサービスリソースを仮想ネットワークにおいてセキュリティで保護
  - 仮想ネットワーク規則により、リソースへのパブリックインターネットアクセスを削除し、仮想ネットワークからのトラフィックのみを許可できる
  - 常にユーザーの仮想ネットワークからMS Azureのバックボーンネットワーク上のサービスへのサービストラフィックが直接受け取られる
  - サービスエンドポイントはサブネットを通じて構成
- 有益なシナリオ
  - リソースのセキュリティ強化
    - リソースへのパブリックインターネットアクセスを完全に排除し、仮想ネットワークからのトラフィックのみを許可する
  - 強制トンネリングを回避

### プライベートリンク
- 仮想ネットワークからAzureサービス、顧客管理のリソース、MSパートナーの各サービスへのプライベート接続が可能
- ネットワークアークテクチャをシンプルに
- パブリックインターネットへのデータの公開をなくす
- トラフィックは全てMSグローバルネットワーク上に維持される
- リージョンに関する制限はない
- 独自のサービスを顧客の仮想ネットワークでプライベート提供

### ロードバランサー
- 高可用性
- ネットワークパフォーマンス
- 受信したネットワークトラフィックをバックエンドサーバーとリソースの間で効率的に分散する
- 負荷分散規則と正常性ブローぶを利用して実装
- 受信と送信のシナリオに使用
- パブリックまたは内部ロードバランサーの実装
- 構成要素
  - フロントエンドのIP構成
    - ロードバランサーで応答するパブリックIPまたは内部IPを指定
  - バックエンドプール
    - VMやAzure VM Scale Sets
  - 正常性ブローぶ
    - バックエンドへのトラフィックの分散方法
  - 負荷分散規則
    - 無数のTCP及びUDPアプリケーションフロー
- パブリックロードバランサー
  - 受信トラフィックのパブリックIPアドレスとポート番号を、仮想マシンのプライベートIPアドレスとポート番号にマップ
- 内部ロードバランサー
  - 仮想ネットワーク内にあるリソース、またはAzureインフラストラクチャへのアクセスにVPNを使用するリソースにトラフィックを転送
  - フロントエンドのIPアドレスと仮想ネットワークがインターネットエンドポイントに直接公開されることはない
  - 適用対象
    - 仮想ネットワーク内
    - クロスプレミス仮想ネットワーク
    - 他層アプリケーション
    - 基幹業務アプリケーション
    - パブリックロードバランサーto内部ロードバランサー
- 設定
  - Gateway > Standard > Basic
  - Standard
    - 正常性ブローブ:
      - HTTPS
      - HTTP
      - TCP
    - 可用性ゾーン
      - 受信トラフィックと送信トラフィック用のゾーン上長およびゾーンフロントエンド
    - 複数のフロントエンド
      - 受信及び送信
    - Security
      - NSGで許可されている場合を除き、受信フローは閉じられている
      - 仮想ネットワークから内部ロードバランサーへの内部トラフィックは許可されている
  - Basic
    - 正常性ブローブ:
      - HTTP
      - TCP
    - 可用性ゾーン
      - 使用不可
    - 複数のフロントエンド
      - 受信のみ
    - Security
      - NSGで許可されている場合を除き、受信フローは閉じられている
      - 仮想ネットワークから内部ロードバランサーへの内部トラフィックは許可されている
- 負荷分散規則
  - 負荷分散規則を構成するには、ロードバランサーのフロントエンド、バックエンド、正常性プローブが必要
  - 既定では、ネットワークトラフィックを複数の仮想マシンに均等に分散させる
  - 5タプルハッシュを使って、使用可能なサーバーにトラフィックをマップする
  - トランスポートセッション内でのみ持続性が提供される
  - セッションの永続化によって、クライアントからのトラフィック処理方法が指定される
  - 負荷分散規則はNAT規則と組み合わせて使用


#### バックエンドプール
- 各ロードバランサーに、バックエンドプールが1つ以上付与
- バックエンドプールには、ロードバランサーに接続されている仮想NICのIPアドレスが含まれる
- 選択したSKUにより、サポートされるエンドポイント構成と、許可されるプールインスタンスの数が決定される
- Basicでは最大300, Standardでは最大1000
- 可用性セット、仮想マシン、Azure Virtual Machine Scale Setsに接続可能
- Basic の場合、1つの可用性セットで仮想マシンを選択、Azure Virtual Machine Scalse setsのインスタンスで仮想マシンを選択できる
- standardの場合、1つの仮想ネットワークで仮想マシンまたはVirtual Machine Scale Setsを選択できる
  - 構成には、仮想マシン、可用性セット、Virtual Machine Scale Setsの組み合わせを含められる

#### 正常性プローブ
- ロードバランサーでアプリケーションの状態を監視
- プローブで応答できない場合、ロードバランサーは異常なインスタンスへの新しい接続の送信を停止する
- HTTPプローブ
  - ロードバランサーによってバックエンドプールエンドポイントが15秒ごとに調査される
  - 指定のタイムアウト期間内(規定値は31s)に仮想マシンインスタンスがHTTP200で応答した場合、そのインスタンスは正常な状態
  - HTTP200以外は異常な状態
- TCPプローブ
  - 定義されたプローブポートにTCPセッションを確立できるかに依存
  - 仮想マシン上に指定されたリスナーが存在すれば、このプローブは成功
  - 接続が拒否されるとプローブは失敗
- ゲストエージェントプローブ

### Azure Application Gateway
- Webトラフィック用のロードバランサー
- アプリケーション層のルーティング
  - 要求のURLに基づいてWebサーバーのバックエンドプールにトラフィックを転送できる
  - バックエンドプール
    - Azure 仮想マシン
    - Azure Virtual Machine Scale Sets
    - Azure App Service
    - オンプレミスのサーバー
  - ラウンドロビンの負荷分散
    - 受信トラフィックを複数のサーバーに分散
  - セッションの持続性
    - 同じセッション内のクライアント要求を同じバックエンドサーバーに確実にルーティングできる
  - サポートされるプロトコル
    - HTTP
    - HTTPS
    - HTTP/2
    - WebSocketプロトコル
  - ファイアウォールによる保護
  - 暗号化
  - 負荷の自動スケーリング
- ルーティング
  - アプリケーションゲートウェイのIPアドレスまたはDNS名を指定することで、Webアプリに要求を送信
  - ゲートウェイでは、その要求を一連の規則に従ってバックエンドプール内の閃t無くされたWebサーバーに転送
  - パスベースのルーティング
    - 異なるURLのパスの要求を異なるバックエンドサーバーのプールに送信
  - マルチサイトのルーティング
    - 同じアプリケーションゲートウェイのインスタンス上に複数のWebアプリケーションを構成
  - アプリケーションゲートウェイを構成して、トラフィックをリダイレクト
  - HTTPヘッダーを書き換える
  - カスタムエラーページを作成できる
- 構成要素
  - フロントエンドIPアドレス
    - クライアント要求を受信
  - ファイアウォール
  - 1つ以上のリスナーがトラフィックを受信し、要求をバックエンドプールにルーティング
  - ルーティング規則
    - 要求を分析し、要求を適切なバックエンドプールに転送
  - バックエンドプール
  - 正常性プローブ

## IDとガバナンス

### ユーザーアカウントとグループアカウント
- クラウドID
  - Microsoft Entra　ID でのみ定義される
- ディレクトリ同期ID  
  - オンプレミスのActive Directory
- ゲストユーザー
  - Azureの外部で定義
- セキュリティグループ
  - ユーザーグループの共有リソースへのメンバーとコンピューターのアクセスを管理するために使用
- Microsoft 365グループ
  - 共同作業の機会を提供
- グループについて
  - アクセス権
    - 割り当て済み
      - グループのメンバーとして特定の湯イーザーを追加
    - 動的ユーザー
      - 動的メンバーシップルールを使用して、グループメンバーを自動的に追加及び削除できる
      - メンバーの属性が変わると、Azureによってディレクトリの動的グループルールが確認される
      - メンバー属性がルールの要件を満たしている場合、そのメンバーはグループに追加される
    - 動的デバイス
      - 動的グループルールを適用して、セキュリティグループ内のデバイスを自動的に追加及び削除

### Azure Policy
- ポリシーの作成、割り当て、管理に使用できるAzureサービス
- 規則のコンプライアンスの適用
  - 組み込みポリシーを有効にするか、すべての種類のリソースに対してカスタムポリシーを作成
- ポリシーの大規模な運用
  - 組織全体を制御する管理グループにポリシーを適用する
  - 複数のポリシーを適用し、ポリシーイニシアティブを使用してポリシーの状態を集約
  - 除外範囲を定義
- 修復の実行
  - リアルタイムの修復
  - 既存のリソースの修復を実行
- ガバナンスの実行
  - 複数のエンジニアリングチームをサポート
  - 複数のサブスクリプションを管理
  - クラウドリソースの構成方法を標準化して適用
  - 規制コンプライアンス、コスト管理、セキュリティ、及び設計の一貫性を管理
- デプロイ可能なリソースを検討
- リージョンの制限
- コンプライアンス規則と構成オプションを適用
- イベントリ監査の適用
- ポリシー定義
  - リソースのコンプライアンス条件と、条件が満たされた時に完了するアクションを記述
  - 組み込みポリシー
    - 許可されている仮想マシンサイズ
    - 許可されているリージョン
    - 公衆ネットワークアクセスを無効にするようにAzure Device Update for IoT Hubアカウントを構成する
- イニシアチブ定義
  - ポリシーのスコープを制御し、リソースのコンプライアンスを評価するために、1つ以上のポリシー定義がグループ化される
  - 組み込みポリシー
    - 安全でないパスワードセキュリティ設定をモク監査マシン
    - Windowsマシンを構成してAzure Monitorエージェントを実行し、それらをデータコレクションルールに関連づける
    - Azure DefenderをSQLサーバーで有効になるように構成する

### RBAC
- Azureリソースにアクセスできるユーザーを管理する。
- 特定のリソースに対して特定のユーザーが実行できる操作を決定し、各ユーザーがアクセスできるリソースの領域を制御する
- Azure Resource Manager上に構築された認可システム
- 構成要素
  - セキュリティプリンシパル
    - リソースへのアクセスを要求しているものを表すオブジェクト
    - アクセス許可を付与するユーザー、グループ、またはアプリケーション
  - ロールの定義
    - 許可された操作を一覧表示するアクセスの許可セット
    - 組み込みポリシーとカスタムロール
  - スコープ
  - 譲渡
    - 割り当てにより、特定のスコープでセキュリティプリンシパルにロール定義がアタッチされる。
    - ユーザーはロールの割り当てを作成することで、ロール定義に記述されているアクセス権を付与できる
- 要求元の確認
  - どの対象にセキュリティプリンシパルを付与するか
- ロールの検討
  - アクセス許可のスコープを検討
- 組み込みまたはカスタム定義を検討
- ロール定義
  - JSONファイルで定義されているアクセス許可のセットで構成
  - 各アクセス許可のセットには、アクセス許可を説明するActionsやNotActiosなどの名前がある
    - Actions: 許可されるアクション
    - NotActions: 許可されないアクション
    - DataActions: データを変更または使用する方法
    - AssignableScopes: ロール定義を割り当てることができるスコープが一覧表示
  - 組み込みロールとアクセス許可セットが用意
  - カスタムロールとアクセス許可を作成することが可能
  - Owner組み込みロールにはAzureで最高レベルのアクセス特権がある
  - システムは、Actionsアクセス許可-NotActionsアクセス許可=有効なアクセス許可
  - AssinableScopesアクセス許可には、管理グループ、サブスクリプション、リソースグループ、リソースを指定可能
  - Role
    - Owner: all
    - Contributor: all - delete,write,elevateAccess
    - Reader: read
  - 組み込みロールの使用
  - カスタムロールの使用
  - アクセススコープを制限
  - データの変更を制御
  - 拒否の割り当てを適用
- ロール
  - 従来のサブスクリプション管理者ロール
  - Azureロールベースアクセス制御(RBAC)ロール
    - Azureリソースに対してより詳細なアクセス管理を提供
    - 要求もとまたはリソースに対して定義され、ルート、管理グループ、サブスクリプション、リソースグループ、リソースという複数のレベルで適用
  - Microsoft Entra管理者ロール
    - ユーザー、グループ、ドメインなど、Microsoft Entra IDのリソースを管理するために使用
    - 構成のルートレベルでMicrosoft Entraテナントに対して定義
    - [Role Based Authentication](imgs/role-based-authentication-b3dda7ae.png)
- Azure Subscription
  - 各Azureサブスクリプションが1つのMS Entraディレクトリに紐づけられている
  - そのディレクトリ内のユーザー、グループ、及びアプリケーションのみがAzureサブスクリプションでリソースを管理できる
  - アクセス管理
    - SSO
    - Microsoft Entra ID
  - Microsoft Entra Connect
    - オンプレミスのActive Directoryをクラウドに拡張

### MS Entra
- MS Entra ID
  - すべてのユーザーアカウントに規定のアクセス許可のセットが付与される
  - ユーザーアカウントのアクセス権
    - ユーザーの種類
    - ユーザーのロール割り当て
    - ここのオブジェクトの所有権
  - ユーザー
    - 管理者ロール
    - メンバーユーザー
    - ゲストユーザー
  - アクセス権
    - 直接割り当て
    - グループの割り当て
    - ルールベースの割り当て
  - フェデレーション
    - 一連のリソースへのアクセスを共有するために、別の組織やドメインのコレクションと信頼を確立する
    - オンプレミスのIDプロバイダーとMS Entra IDとの信頼が確立している場合
  - Self Service Password Reset
    - ユーザーは、Webブラウザーなどでパスワードをリセットし、Azure, Microsoft 365, 及び認証にMicrosoft Entra IDを使用する他のアプリケーションに再びアクセスすることができる
    - パスワードリセットの認証
      - モバイルアプリの通知
      - モバイルアプリコード
      - 電子メール
      - 携帯電話
      - 会社電話
      - セキュリティの質問
    - 認証方法の最小すうを要求
  - ライセンスの要件
    - サインインしているすべてのユーザーは、Microsoft Entra IDのエディションに関係なく、自分のパスワードを変更できる
    - サインインしていない時にパスワードを忘れた場合、パスワードの有効期限が切れた場合、Microsoft Premium P1, P2, Microsoft 365 Apps for business, Microsoft 365で可能
    - オンプレミスのActive DirectoryとクラウドのMicrosoft Entra IDの両方を使用しているハイブリッド環境では、クラウドでのパスワード変更を、オンプレミスのディレクトリに書き戻す必要がある。Microsoft 365 Apps for business

## ストレージ
### ストレージアカウント
- 3つのカテゴリのデータ
  - 仮想マシンデータ
    - ディスク
      - Azure IaaS仮想マシン用の永続的ブロックストレージ
    - ファイル
      - クラウド内のフルマネージドファイル共有
  - 非構造化データ
    - Azure Blob Storage
      - 拡張性が高い、RESTベースのクラウドオブジェクトストア
    - Azure Data Lage Storage
      - SaaSのHadoop分散ファイルシステム
  - 構造化データ
    - 共有スキーマを持つリレーショナル形式で格納
    - データベーステーブル
    - NoSQL
    - Azure Table Storage
    - Azure Cosumos DB
      - グローバル分散型データベース
    - Azure SQL Database
      - SaaSのフルマネージドデータベース
- Storage Account レベル
  - Standard
    - HDDを基盤
    - 大容量ストレージを必要とするアプリケーションやデータへのアクセス頻度が低いアプリケーション
  - Premium
    - SSDを使用
    - データベースのようなI/O集中型アプリケーションがあるAzure仮想マシンディスクのために使用
- 検討事項
  - 持続性と可用性
  - 安全なアクセス
  - スケーラビリティ
  - 管理のしやすさ
  - データへのアクセシビリティ
- サービス
  - Azure Blob Storage
    - テキストとバイナリデータのためのスケーラブルなオブジェクトストア
    - 目的
      - 画像またはドキュメントをブラウザに直接配信
      - 分散アクセス用にファイルを格納
      - ビデオ及びオーディオをストリーミング配信
      - バックアップと復元、ディザスターリカバリー、アーカイブのためのデータを格納
      - オンプレミスサービスまたはAzureホステッドサービスで分析するデータを格納
  - Azure Files
    - クラウドまたはオンプレミスのデプロイ用のマネージドファイル共有
    - SMBとNFSプロトコルを使ってアクセス
    - 複数のVMが読み取りアクセス権と書き込みアクセス権の両方を使用して同じファイルを共有
    - 目的
      - オンプレミスのアプリケーションとファイル共有
      - 構成ファイルをファイル共有に格納し、複数のVMからアクセス可能
    - ファイル共有へのアクセスの認証を提供するために、ストレージアカウントの資格情報が使用される
    - 共有がマウントされているすべてのユーザーは共有への読み取り及び書き込みのアクセス権が必要
  - Azure Queue Storage
    - アプリケーションコンポーネント間の信頼性の高いメッセージングのためのメッセージングストア
    - 最大サイズ64KB
    - 1つのキューに数百万件のメッセージ
    - 非同期的に処理するメッセージ一覧を格納するために使用
  - Azure Table Storage
    - 非リレーショナル構造化データを格納
    - 各種テーブル
      - スループット最適化テーブル
      - グローバル分散
      - 自動セカンダリインデックス
      - Azure Cosmos DBの一部のため、最新のアプリ開発のためのフルマネージドのNoSQLデータベースサービスにアクセス可能
  - 検討事項
    - 大量のデータに対するストレージの最適化を検討
    - 高可用性を備えたストレージ
    - メッセージ用のストレージを検討
    - 構造化データ用のストレージ
- ストレージアカウントの種類
  - Standard 汎用v2
    - Blob, ファイル共有、キュー、ディスクなど基本的なシナリオに対応
  - Premium ブロックBlob
    - ブロックBlobと追加Blob向けのPremiumアカウント
  - Premiumファイル共有
  - PremiumページBlob
    - ページBlob専用
      - OSやVMのデータディスク、DBのようなインデックスベースのスペースデータ構造を格納するのに適する
- レプリケーション戦略
  - LRS
    - 最も低コスト
    - シナリオ
      - データ損失が発生した場合に、簡単に再構築できるデータがアプリケーションで格納されている
      - データはライブフィードの世に絶えず変化しており、データの格納は必須ではない
      - データガバナンスの要件によって、アプリケーションでのデータレプリケートが国/地域の内部に制限されている
  - ZRS
    - 単一リージョン内の3つのストレージクラスターにわたってデータが動的的にレプリケートされる
    - 各ストレージクラスターは、他のクラスターから物理的に分離、独自の可用性ゾーン内に置かれる
    - すべてのリージョンでは使えない
    - 別のデータレプリケーションオプションからZRSに変更するには、1つのストレージスタンプからリージョン内の複数のスタンプへの物理的なデータ移動が必要
  - GRS
    - セカンダリリージョンにデータがレプリケートされる
    - 16ナインの持続性を提供
    - セカンダリリージョンのデータを読み取るのは、MSがプライマリリージョンからセカンダリリージョンへのフェールオーバーを開始した場合のみ
    - RA-GRS
      - セカンダリリージョンの別のデータセンターにデータをレプリケート
      - フェールオーバーの実行に関わらず、セカンダリリージョンから読み取り可能
    - プライマリのLRSでレプリケート。非同期にセカンダリへLRSとしてレプリケーション
    - ストレージスケールユニット内の異なる障害ドメインとアップグレードドメイン間でレプリカを管理
  - GZRS
    - ZRSとGRSの組み合わせ
    - プライマリリージョンの3つのAzure可用性ゾーン間でレプリケートされ、セカンダリリージョンにもレプリケートされる
    - 16ナイン
    - RA-GZRS
      - セカンダリリージョンのデータに対する読み取りアクセスを有効に
- ストレージへのアクセス
  - Azure Storageに格納するすべてのオブジェクトには一意のURLアドレスが設定されている
  - ストレージアカウント名は、URLアドレスのサブドメイン
  - カスタムドメインを構成
  - カスタムドメインやサブドメインをストレージアカウントのBlobエンドポイントまたはWebエンドポイントにマップしている場合、ユーザーはそのドメインを使ってストレージアカウントのBlobデータにアクセス可能
  - 直接マッピング
    - サブドメイン用のカスタムドメインをAzureストレージアカウントに対して有効にできる
    - DNSのCNAMEレコードを設定
  - 中間ドメインマッピング
    - Azure内ですでに使用中のドメインに適用
- ストレージエンドポイントをセキュリティで保護する
  - ファイアウォールと仮想ネットワークの設定
  - サブネットと仮想ネットワークはストレージアカウントと同じAzureリージョンまたはリージョンペアに存在する必要がある
- そのほか
  - 名前はAzure内でグローバルに一意
  - デプロイモデル
    - Azureでリソースを編成するために使用されるシステム
    - Resource Maneger
      - Azure Resource Manager APIを使用する現在のモデル
    - クラシック
      - クラシックデプロイモデルを使用するレガシオファリング
- Azure Storageの承認オプション
  - パブリックアクセス
    - 2段階の設定
      - ストレージアカウント
      - コンテナ
  - Microsoft Entra ID
    - コードに資格情報を保存せずにAzure Storageに安全にアクセスするため
    - マネージドIDでアプリを実行している場合、セキュリティプリンシパルを使用している場合
    - AD承認には2段階のアプローチ
      - セキュリティプリンシパルの承認
      - OAuth2.0トークンを用いた承認
  - 共有キー
    - Azure Storageによって、作成されたすべてのストレージアカウントに対して512ビットのアクセスキーが2つ作成される
    - これらのキーを共有してクライアントにストレージアカウントへのアクセスを許可する
    - これらのキーは、ストレージへのルートアクセスと同等のアクセス権を任意のユーザーに許可
    - Azure Key Valutでストレージキーを管理
  - Shared Access Signature
    - 読み取り専用または読み取り/書き込みアクセス、有効期限などAzure Storage内のファイルへの詳細なアクセスを許可できる
    - SASはストレージリソースに対するアクセス許可を付与するキーであり、アカウントキーと同じ方法で保護する必要がある
    - 3種類
      - ユーザー委任SAS
        - BLOBストレージにのみ使用
        - Microsoft Entra IDで保護
      - サービスSAS
        - ストレージアカウントキーを使用
        - Azure Storage Serviceのいずれかのリソースへのアクセスを委任
      - アカウントSAS
        - ストレージアカウントキーで保護
        - サービスレベルの操作へのアクセスも制御可能
    - 仕組み
      - 1つ以上のストレージリソースを示すURIとクライアントがリソースにアクセスする方法を示すトークン
      - サービスまたはアカウントのSASを作成するときは、署名は自分のストレージアカウントキーで署名
      - Storageへのアクセス権を持つMicrosoft Entra セキュリティプリンシパルを使う場合は、ユーザー委任Shared Access Signatureを作成
      - Microsoft.Storage/storageAccounts/blobServices/generateUserDelegationKeyアクションをプリンシパルに許可
    - 保存されているアクセスポリシー
      - SASトークンの更新を管理


#### Azure Blob Storage
- 非構造化データをクラウド内にオブジェクトまたはBlobとして格納するサービス
- 任意の種類のテキストまたはバイナリデータ
- Storage Account/Container/Blob
- 設定
  - コンテナのオプション
  - 種類とアップロードのオプション
  - アクセス層
  - ライフサイクルルール
  - レプリケーションのオプション
- 検討事項
  - ブラウザのアップロード
  - 分散アクセスを検討
  - データのストリーミング
  - アーカイブと回復
  - アプリケーションによるアクセス
- Container
  - すべてのBlobは1つのコンテナに存在する必要がある
  - Blobを無制限に格納
  - コンテナの数は無制限
  - 設定
    - 名前
    - パブリックアクセスレベル
      - 非公開
      - BLOB
      - コンテナ
  - アクセス層
    - ホット層
      - Azureストレージアカウント内のオブジェクトを頻繁に読み書きするために最適化
    - クール層
      - アクセス頻度の低い大量のデータを格納するために最適化
      - 30日以上保存されるデータ
    - コールド層
      - アクセス頻度の低い大量のデータ
      - 90日間以上保存されるデータ
    - アーカイブ層
      - 数時間の取得待機時間を許容できるデータのために最適化されたオフライン層
      - 180日間以上保存されるデータ
- ライフサイクル管理
  - ライフサイクル管理ポリシールール
- オブジェクトレプリケーション
  - ユーザーが構成したポリシールールに従って、コンテナ内のBlobを非同期にコピーする
  - 内容
    - BLOB
    - メタデータとプロパティ
    - 関連づけられているすべてのバージョンのデータ
  - ソースアカウントと宛先アカウントの両方でBLOBのバージョン管理が有効になっている
  - ソースアカウントのBLOBのスナップショットは宛先アカウントにレプリケートされない
  - コピー元とコピー先のアカウントがホット、クール、またはコールド層にある場合にサポート
  - コピー先とコピー元のアカウントが異なるそうに存在しても良い
  - 検討事項
    - 待ち制限の削減
    - CPUの効率
    - データの分散
    - コストの利点
- Blobの種類
  - ブロックBLOB
    - データのブロックで構成され、それらを組み立ててBLOBを構成
    - クラウドでファイル、画像、ビデオのようなテキストやバイナリデータを格納するのに最適
  - 追加BLOB
    - 追加操作用に最適
    - ログ記録のシナリオ
  - ページBLOB
    - 読み取り及び書き込み操作を頻繁に実行する場合
    - Azure VMでは、OSディスクとデータディスク用に使用
- アップロード
  - AzCopy
    - BlobStorageとの間でコンテナやストレージアカウントを跨いでデータをコピー
  - Azure Data Box Disk
    - 大規模なデータセットやネットワーク上の制約によって有線でのデータのアップロードが非現実的である場合に、オンプレミスのデータをBlob storageに転送するサービス
  - Azure Import/Export
    - ストレージアカウントにある大量のデータをハードドライブにエクスポートする
- コスト
  - パフォーマンスレベル
  - データアクセスコスト
  - トランザクションのコスト
  - Geoレプリケーションデータ転送コスト
  - ストレージ層の変更
    - クールからホットに変更すると、ストレージアカウントに存在するすべてのデータの読み取りと同等の課金が発生
    - ホットからクールに変更すると、クール層への全データの書き込みに相当する課金が発生
- セキュリティ戦略
  - 暗号化
    - Azure Storageに書き込まれるデータの全ては、自動的に暗号化される
  - 認証
    - Microsoft Entra IDとRBACは、AzureStorageのリソース管理操作とデータ操作の両方でサポート
  - 転送中のデータ
    - アプリケーションとAzureの間で送信されるデータを、クライアント側暗号化、HTTPS、またはSMB3.0を使用して保護
  - ディスクの暗号化
    - Azure VMに使われるOSディスクとデータディスクは、Azure Disk Encryptionを使って暗号化できる
  - Shared Access Signature
    - Azure Storageのデータオブジェクトへの委任アクセスは共有アクセス署名を使って付与
  - 承認
  - 考慮すべきこと
    - Microsoft Entra ID
      - RBACを用いて、細かいアクセス制限の割り当てが可能
    - 共有キー
      - Azure Storageのアカウントのアクセスキーとその他のパラメータを利用し、暗号化された署名文字列を生成
      - Authenticationヘッダーで共有
    - 共有アクセス署名
      - SASにより、Azure Storageアカウント内の特定のリソースへのアクセスが、指定したアクセス許可で、指定した期間だけ委任
    - コンテナとBlobへの匿名アクセス
      - 必要に応じて、コンテナまたはBLOBのレベルでパブリック許可を行える
  - SAS
    - Shared Access Signature
    - Azure Storageリソースへの制限付きアクセス権を付与するURI
    - アカウントキーを使わずにストレージリソースを共有
    - SASを所有しているクライアントに付与するアクセスの種類を柔軟に制御
    - 複数のAzure Storageサービスへのアクセスを委任
    - 開始時刻と有効期限など、有効期間を指定
    - 読み取り、書き込み、削除アクセス許可
    - アカウントレベル
      - 1つ以上のAzure Storageサービス内のリソースへのアクセスが委任
    - サービスレベル
      - 1つだけのAzure Storageサービス内のリソースへのアクセスが委任
    - オプション
      - IPアドレス
        - SASを受け入れるAzure StorageのIPアドレスまたはIPアドレスの範囲を識別
      - プロトコル
        - Azure StorageがSASを受け入れるプロトコルを指定
    - 暗号化
      - 各サービスにて永続化される前に、自動的に暗号化される
      - データは取得前に自動的に暗号化が解除される
      - Azure Storageの暗号化、解読、キー管理は自動手で行われる
      - 256bitsのAES暗号化によって暗号化
      - 新規と既存のすべてのストレージアカウントに対して有効化され、無効化不可
    - カスタムマネージドキー
      - Azure Key Valutを用いた暗号化キー管理
      - Azure Key Valut APIを使って、暗号化キーを生成
      - 独自の暗号化キーを作成し、キーコンテナに格納することも可能
      - 暗号化キーのアクセス制御、無効化、監査、ローテーション、定義を行える
    - 推奨事項
      - 作成と配布には常にHTTPSを用いる
      - 可能な場合は保存されたアクセスポリシーを参照する
      - 計画外のSASには短い有効期間を設定する
      - クライアントにSASの自動更新を要求する
      - SASの開始時刻を慎重に計画する
      - リソースに対して最小限のアクセス許可を定義する
      - SASを含む使用量に対するアカウントの課金について
      - SASを使って書き込まれたデータを検証する
      - SASが常に正しい選択であると思い込まないようにする
      - Azure Storage Analyticsでアプリケーションを監視する

#### Azure Files
- SMBとNFSプロトコルを使用して、アプリケーションのための共有ストレージを提供
- データを本来のディレクトリオブジェクトとしてファイル共有に格納
- 複数のVMにまたがるファイルへの共有アクセスを提供
- 任意の数のVMまたはロールがAzureファイル共有を同時にマウントしてアクセスできる
- 検討事項
  - 置き換え及び保管オプションを検討する
  - グローバルアクセスを検討する
  - リフトアンドシフトのサポートを検討する
  - Azure File Syncの使用を検討
  - 共有アプリケーションを検討
  - 診断データを検討
  - ツールとユーティリティを検討
- 考慮事項
  - ポート445を開く
  - 安全な転送を有効にする
- ファイル共有スナップショット
  - データの特定時点の読み取り専用コピーがキャプチャされる
  - ファイル共有レベルで提供
  - 最新の共有スナップショットの後に変更されたデータだけが保存される
  - 増分スナップショットにより、共有スナップショットの作成に必要な時間を最小限に抑え、ストレージコストを節約できる
  - 共有を復元するには最新の共有スナップショットだけを保持
  - 個々のファイルの共有スナップショットを取得
  - 共有スナップショットのある共有を削除する場合、そのすべてのスナップショットを削除する必要がある
  - 考慮すべき事項
    - アプリケーションエラーとデータの破損から保護する
    - 誤った削除や意図しない変更から保護
    - バックアップと回復をサポート
- クラウドの階層化
  - Azure File Syncのオプション機能
  - 頻繁にアクセスされるファイルがサーバー上でローカルにキャッシュされるのに対して、その他のファイルはすべてポリシー設定の基づいてAzure Filesに階層化される
  - ファイルが階層化されると、Azure File Syncはそのファイルをローカルでポインターに置き換える
  - ユーザーが階層化されたファイルを開くと、Azure File SyncによってファイルデータがAzure Filesからシームレスに呼び戻される
  - ユーザーはファイルがAzureに格納されていることを知る必要はない
  - クラウド階層化ファイルには、そのファイルがいつAzureにのみ存在するかがユーザーにわかるように、オフラインの0ファイル属性がついがグレーのアイコンが表示される
- 考慮事項
  - アプリケーションのリフトアンドシフトを検討
    - Windows ServerとAzure Filesに同じデータへの書き込みアクセスを提供
  - ブランチオフィスのサポートを検討
  - バックアップとディザスターリカバリーを検討
  - クラウドの階層化を使用したファイルのアーカイブ
- 構成要素
  - ストレージ同期サービス
    - Azure File Syncのための最上位レベルのAzure リソース
    - 複数の同期グループを使用して、複数のストレージアカウントとの同期関係を形成する
    - 同期関係をサポートするためにストレージアカウントリソースとは異なる最上位レベルのリソースが必要
    - 1つのサブスクリプションで複数のストレージ同期サービスリソースをデプロイできる
  - 同期グループ
    - 一連のファイルの同期トポロジを定義
  - 登録済みサーバー
    - サーバーとストレージ同期サービスリソース間の信頼関係を表す
  - Azure File同期エージェント
    - Azure File Syncエージェント
    - Windows ServerをAzureファイル共有と同期できるようにするダウンロード可能なパッケージ
    - FileSyncSvc.exe
      - バックグラウンドのWindowsサービスで、サーバーエンドポイントの変更の監視とAzureに対する同期セッションの開始を担当
    - StorageSync.sys
      - クラウドを使った階層化をサポートするAzure File Syncファイルシステムフィルター
    - PowerShell管理コマンドレット
      - Microsoft.StorageSync Azureリソースプロバイダーと対話可能
  - サーバーエンドポイント
    - 登録済みサーバー上の特定の場所
    - 名前空間が一意であれば同じボリューム上に複数のサーバーエンドポイントが存在できる
  - クラウドエンドポイント
    - 同期グループに含まれるAzureファイル共有
    - 1つのAzure ファイル共有は、1つのクラウドエンドポイントのみのメンバーにする
    - 1つのAzureファイル共有は、1つの同期グループのみのメンバーにすることができる

#### Azure Storage Explorer
- Windows, macOS, LinuxでのAzure Storageデータの操作を容易にするスタンドアロンアプリケーション
- 複数のアカウントとサブスクリプションにアクセスして、ストレージの内容をすべて管理
- リソースへのフルアクセスを許可するために、Azure Resource Managerとデータ層の両方のアクセス許可が必要
- Storage Account, Container, dataにアクセスするためのMicrosoft Entra のアクセス許可が必要
- 様々なストレージアカウントに接続
  - 自分のAzureサブスクリプションに関連づけられているストレージアカウント
  - 他のAzure サブスクリプションから共有されているストレージアカウントとサービス
  - Azure Storage Emulatorを使ってローカルストレージに接続し、そのローカルストレージを管理
  - データ層のアクセス許可のみで良い
- 考慮事項  
  - Azure Sbuscriptionに接続する
  - ローカル開発ストレージを操作する
  - 外部ストレージにアタッチする
  - SASを使ってストレージアカウントをアタッチする
  - SASを使ってサービスをアタッチする

#### Azure Import/Export
- Azureデータセンターにディスクドライブを送付することで、Azure Blob StorageやAzure Filesに大量のデータを安全にインポートできる
- Azure Blob Storageからディスクドライブにデータを転送し、顧客のオンプレミスのサイトに送付可能
- ディスクドライブからのデータを、顧客のAzure Storage Account内のAzure Blob StorageまたはAzure Filesにインポート
- Azure Storage Account内のAzure Storageからのデータを、指定したドライブにエクスポート
- Azure Importジョブを作成して、物理ディスクからAzure Blob Storage またはAzure Filesにデータをインポート
- Azure Exportジョブを作成して、Azure Storageからハードディスクドライブにデータをエクスポート
- Azure Portalから直接、またはAzure Storage Import/Export REST APIを使ってプログラムでジョブを作成
- 検討事項
  - ネットワーク経由でのデータのアップロードまたはダウンロードが遅すぎる場合や、コストがかかりすぎるためネットワーク帯域幅を増やせない場合に利用
  - クラウド移行
  - コンテンツ配布
  - バックアップ操作
  - データの回復
- Azure Import Job
  - 大量のデータをAzure Blob StorageまたはAzure Filesに安全に転送
  - 顧客がディスクドライブをAzureデータセンターに発送し、スタッフが指定されたデータをAzure Storageにコピーしてからドライブを返送
- Azure Export Job
  - Azure Storageからハードディスクドライブにデータ転送をし、顧客のオンプレミスサイトにディスクを発送
- WAImportExportツール
  - データをインポートする前にドライブを準備したり、データ転送後に破損したファイルやん見つからないファイルを修復したり
  - 考慮事項
    - サポートされているディスクドライブ
    - BitLocker暗号化
    - OSのバージョン

#### AZCopyツール
- Azure Blob StorageとAzure Filesとの間でデータをコピーするための次世代CLU
- 大容量ファイルの転送に最適
- バックグラウンドで実行
- ジョブの順序と関連するログファイル
- 特定のパス内のファイルやBLOBを一覧表示したり、削除したり
- エラーの発生時に転送が自動的に再施行
- Azure Blob Storageを使う場合、AzCopyによってアカウント全体を別のアカウントにコピーできる
- Azure Data LakeStorage Gen2 APIがサポート
- AzCopyは、Azure Storage Explorerに組み込まれている
- Windows, Linux, macOSが使用できる
- 認証オプション
  - Microsoft Entra ID
  - SASトークン
- 考慮事項
  - データの同期
  - ジョブ管理
  - 転送の回復性
  - 高速アカウント間コピー
